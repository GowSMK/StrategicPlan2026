<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pengurusan Kurikulum - SMK Seri Pulai Perdana</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        
        /* --- ORG CHART STYLES --- */
        .org-container {
            overflow: auto; /* Allow scrolling */
            padding: 40px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            min-height: 600px;
            display: flex;
            flex-direction: column;
            align-items: flex-start; 
        }
        
        .tree { 
            display: inline-flex; 
            flex-direction: column; 
            align-items: center; 
            margin: 0 auto; 
        }

        .node-wrapper { display: flex; flex-direction: column; align-items: center; position: relative; padding: 0 10px; }
        
        /* Node Cards */
        .node-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 8px;
            width: 140px;
            position: relative;
            z-index: 10;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            text-align: center;
        }
        .node-card:hover { border-color: #6366f1; transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .node-role { font-size: 9px; font-weight: 800; text-transform: uppercase; color: #6366f1; margin-bottom: 4px; line-height: 1.2; }
        .node-name { font-size: 11px; font-weight: 600; color: #1e293b; line-height: 1.3; }
        
        /* Role Colors */
        .role-pengetua { border-top: 4px solid #fcd34d; background: #fffbeb; }
        .role-pk { border-top: 4px solid #60a5fa; background: #eff6ff; }
        .role-gkmp { border-top: 4px solid #4ade80; background: #f0fdf4; }
        .role-kp { border-top: 4px solid #f472b6; background: #fdf2f8; }
        .role-default { border-top: 4px solid #94a3b8; }

        /* --- LAYOUT CONNECTORS --- */
        /* Horizontal */
        .layout-horizontal .children-container { display: flex; padding-top: 20px; position: relative; }
        .layout-horizontal .node-wrapper::before { content: ''; position: absolute; top: 0; height: 20px; width: 2px; background: #cbd5e1; }
        .layout-horizontal .tree > .node-wrapper::before { display: none; } 
        .layout-horizontal .children-container::before { content: ''; position: absolute; top: 0; left: 50%; height: 20px; width: 2px; background: #cbd5e1; }
        .layout-horizontal .node-wrapper:not(:only-child):first-child::after { content: ''; position: absolute; top: 0; right: 0; height: 2px; width: 50%; background: #cbd5e1; }
        .layout-horizontal .node-wrapper:not(:only-child):last-child::after { content: ''; position: absolute; top: 0; left: 0; height: 2px; width: 50%; background: #cbd5e1; }
        .layout-horizontal .node-wrapper:not(:only-child):not(:first-child):not(:last-child)::after { content: ''; position: absolute; top: 0; left: 0; height: 2px; width: 100%; background: #cbd5e1; }

        /* Vertical */
        .layout-vertical .tree { width: 100%; }
        .layout-vertical .children-container { display: flex; flex-direction: column; align-items: center; width: 100%; padding-top: 20px; position: relative; }
        .layout-vertical .children-container::before { content: ''; position: absolute; top: 0; left: 50%; height: 20px; width: 2px; background: #cbd5e1; }
        .layout-vertical .node-wrapper { margin-bottom: 10px; width: 100%; }
        .layout-vertical > .node-wrapper > .children-container { flex-direction: row; justify-content: center; flex-wrap: wrap; gap: 20px; }

        /* Orphan Section */
        .orphan-section { margin-top: 40px; padding: 20px; border: 2px dashed #f87171; background: #fef2f2; border-radius: 8px; width: 100%; text-align: center; }
        .orphan-container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 10px; }

        /* Table & UI Styles */
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .data-table th { background-color: #f1f5f9; padding: 8px; text-align: left; font-weight: 700; border: 1px solid #e2e8f0; color: #475569; position: relative; }
        .data-table td { border: 1px solid #e2e8f0; padding: 6px; background: white; position: relative; }
        .data-table input { width: 100%; border: none; background: transparent; outline: none; font-size: 0.85rem; padding: 4px; }
        .data-table input:focus { background-color: #f0f9ff; }
        
        #mainSidebar { transition: transform 0.3s ease-in-out; }
        .nav-item.active { background-color: #e0e7ff; color: #4338ca; border-right: 3px solid #4338ca; }
        
        /* Action Buttons Visibility */
        .row-action-btn, .col-action-btn { opacity: 0; transition: opacity 0.2s; }
        tr:hover .row-action-btn { opacity: 1; }
        th:hover .col-action-btn { opacity: 1; }
        
        /* Tabs Scrollbar */
        #tableTabs::-webkit-scrollbar { height: 4px; }
        #tableTabs::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 h-16 flex items-center justify-between px-4 shadow-sm z-30 relative">
        <div class="flex items-center gap-3">
            <button onclick="toggleSidebar()" class="p-2 rounded-lg text-gray-600 hover:bg-gray-100 focus:outline-none">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
            
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 text-white p-2 rounded-lg hidden sm:block">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                </div>
                <div>
                    <h1 class="text-lg font-extrabold text-gray-900 leading-none">PENGURUSAN KURIKULUM</h1>
                    <p class="text-xs text-gray-500 font-medium hidden sm:block">SMK Seri Pulai Perdana</p>
                </div>
                <div id="connectionStatus" class="ml-2 sm:ml-4 text-xs font-bold px-2 py-1 rounded bg-gray-100 text-gray-500 flex items-center">
                    <span class="w-2 h-2 rounded-full bg-gray-400 mr-2"></span> <span class="hidden sm:inline">Connecting...</span>
                </div>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="resetToDefault()" class="text-red-600 hover:text-red-800 text-xs font-bold px-3 py-2">Reset</button>
            <button onclick="saveData()" id="saveBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition shadow-md flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                <span class="hidden sm:inline">Simpan</span>
            </button>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="flex-1 flex overflow-hidden relative">
        <aside id="mainSidebar" class="bg-white border-r border-gray-200 flex flex-col flex-shrink-0 z-20 w-64 absolute md:relative h-full transform -translate-x-full md:translate-x-0 transition-transform duration-300">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider">Navigasi Utama</h3>
                <button onclick="toggleSidebar()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <nav class="flex-1 overflow-y-auto p-2 space-y-1" id="navContainer">
                <button onclick="switchView('carta')" id="nav-carta" class="nav-item active w-full flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-700 hover:bg-gray-50">
                    <span class="mr-3">üìä</span> Carta Organisasi
                </button>
                <button onclick="switchView('tables')" id="nav-tables" class="nav-item w-full flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-600 hover:bg-gray-50">
                    <span class="mr-3">üìã</span> Data & Jawatankuasa
                </button>
            </nav>
            <div class="p-4 bg-gray-50 border-t border-gray-200">
                <p class="text-xs text-gray-400 text-center">Kurikulum 2025 v2.6</p>
            </div>
        </aside>

        <main class="flex-1 overflow-y-auto bg-gray-50 p-4 md:p-8 w-full" id="mainContent">
            
            <!-- VIEW 1: CARTA ORGANISASI -->
            <div id="view-carta" class="space-y-4">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-2">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Carta Organisasi</h2>
                        <p class="text-sm text-gray-500">Klik kotak untuk edit. Guna butang menu (kiri atas) untuk ruang lebih luas.</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="flex items-center bg-white border border-gray-200 rounded-lg p-1">
                            <button onclick="setChartOrientation('horizontal')" id="btn-horizontal" class="px-3 py-1 text-xs font-bold rounded-md bg-indigo-100 text-indigo-700">Melintang</button>
                            <button onclick="setChartOrientation('vertical')" id="btn-vertical" class="px-3 py-1 text-xs font-bold rounded-md text-gray-500 hover:bg-gray-50">Menegak</button>
                        </div>
                    </div>
                </div>
                <div id="chartContainerWrapper" class="org-container layout-horizontal">
                    <div id="chartCanvas" class="tree"></div>
                    <!-- ORPHAN SECTION -->
                    <div id="orphanSection" class="orphan-section hidden">
                        <h4 class="text-red-600 font-bold text-sm">‚ö†Ô∏è Item Tidak Bersambung (Parent Salah)</h4>
                        <div id="orphanCanvas" class="orphan-container"></div>
                    </div>
                </div>
            </div>

            <!-- VIEW 2: TABLES -->
            <div id="view-tables" class="hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800" id="tablePageTitle">Data Panitia & Analisis</h2>
                    <button onclick="deleteActiveTable()" class="text-red-500 hover:bg-red-50 px-3 py-1 rounded text-xs font-bold border border-red-200 transition">Hapus Senarai</button>
                </div>
                <div class="flex gap-2 overflow-x-auto pb-2 border-b border-gray-200 items-center" id="tableTabs"></div>
                <div id="activeTableContainer" class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 min-h-[400px]"></div>
            </div>

        </main>
    </div>

    <!-- Edit Modal -->
    <div id="nodeModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-96 p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Edit Posisi</h3>
            <input type="hidden" id="nodeId">
            <div class="space-y-3">
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Jawatan</label><input type="text" id="nodeRole" class="w-full border border-gray-300 rounded p-2 text-sm"></div>
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nama Guru</label><input type="text" id="nodeName" class="w-full border border-gray-300 rounded p-2 text-sm"></div>
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Parent ID</label><input type="text" id="nodeParent" class="w-full border border-gray-300 bg-gray-50 rounded p-2 text-sm text-gray-500"></div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Warna Tag</label>
                    <select id="nodeColor" class="w-full border border-gray-300 rounded p-2 text-sm">
                        <option value="role-default">Kelabu (Umum)</option>
                        <option value="role-pengetua">Kuning (Pengetua)</option>
                        <option value="role-pk">Biru (Penolong Kanan)</option>
                        <option value="role-gkmp">Hijau (GKMP)</option>
                        <option value="role-kp">Merah Jambu (Ketua Panitia)</option>
                    </select>
                </div>
            </div>
            <div class="mt-6 flex flex-col gap-2">
                <button onclick="saveNodeEdit()" class="w-full bg-indigo-600 text-white font-bold py-2 rounded hover:bg-indigo-700">Simpan</button>
                <div class="flex gap-2">
                    <button onclick="addChildNode()" class="flex-1 bg-green-100 text-green-700 font-bold py-2 rounded hover:bg-green-200 text-xs">+ Bawah</button>
                    <button onclick="deleteNode()" class="flex-1 bg-red-100 text-red-700 font-bold py-2 rounded hover:bg-red-200 text-xs">Padam</button>
                </div>
                <button onclick="closeModal()" class="mt-2 text-gray-400 text-xs hover:text-gray-600 text-center">Batal</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIG ---
        const hardcodedConfig = { apiKey: "AIzaSyDvGANnXKmwWlpRT3Wlfsm-WBOEIC62SWU", authDomain: "strategic2026.firebaseapp.com", projectId: "strategic2026", storageBucket: "strategic2026.firebasestorage.app", messagingSenderId: "642605714672", appId: "1:642605714672:web:5dcdfbf351c36ca6084635" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'strategic2026';
        const DOC_PATH = `artifacts/${appId}/public/data/kurikulum_editor/kurikulum_live_v1`;

        const DEFAULT_DATA = {
            chart: [
                { id: 'root', parent: null, role: 'PENGETUA', name: 'NAMA PENGETUA', color: 'role-pengetua' },
                { id: 'pk1', parent: 'root', role: 'PK PENTADBIRAN', name: 'NAMA PK PENTADBIRAN', color: 'role-pk' },
                { id: 'pkhem', parent: 'root', role: 'PK HEM', name: 'NAMA PK HEM', color: 'role-pk' },
                { id: 'pkkoko', parent: 'root', role: 'PK KOKURIKULUM', name: 'NAMA PK KOKURIKULUM', color: 'role-pk' },
                { id: 'pkpetang', parent: 'root', role: 'PK PETANG', name: 'NAMA PK PETANG', color: 'role-pk' },
                { id: 'su', parent: 'pk1', role: 'SU KURIKULUM', name: 'NAMA SETIAUSAHA', color: 'role-default' },
                { id: 'gkmp_bhs', parent: 'pk1', role: 'GKMP BAHASA', name: 'NAMA GKMP BAHASA', color: 'role-gkmp' },
                { id: 'kp_bm', parent: 'gkmp_bhs', role: 'KP B. MELAYU', name: 'KETUA PANITIA BM', color: 'role-kp' },
                { id: 'kp_bi', parent: 'gkmp_bhs', role: 'KP B. INGGERIS', name: 'KETUA PANITIA BI', color: 'role-kp' },
                { id: 'gkmp_sm', parent: 'pk1', role: 'GKMP SAINS MATH', name: 'NAMA GKMP SAINS MATH', color: 'role-gkmp' },
                { id: 'kp_mat', parent: 'gkmp_sm', role: 'KP MATEMATIK', name: 'KETUA PANITIA MATH', color: 'role-kp' },
                { id: 'kp_sn', parent: 'gkmp_sm', role: 'KP SAINS', name: 'KETUA PANITIA SAINS', color: 'role-kp' },
            ],
            tables: [
                { id: 'senarai_kp', title: 'Senarai Ketua Panitia 2025', headers: ['Bil', 'Mata Pelajaran', 'Ketua Panitia'], rows: [['1', 'Bahasa Melayu', 'NAMA GURU'], ['2', 'Bahasa Inggeris', 'NAMA GURU']] }
            ]
        };

        let app, db, auth, appData = JSON.parse(JSON.stringify(DEFAULT_DATA)), activeTableIndex = 0, currentNodeId = null, isSidebarOpen = true, chartOrientation = 'horizontal';

        // --- CORE FUNCTIONS ---
        function prepareForFirestore(data) {
            const clean = JSON.parse(JSON.stringify(data));
            if (clean.tables) clean.tables.forEach(t => { if(t.rows) t.rows = JSON.stringify(t.rows); else t.rows="[]"; });
            return clean;
        }
        function parseFromFirestore(data) {
            const parsed = JSON.parse(JSON.stringify(data));
            if (parsed.tables) parsed.tables.forEach(t => { try { if(typeof t.rows==='string') t.rows=JSON.parse(t.rows); } catch{t.rows=[]} });
            return parsed;
        }

        async function init() {
            try {
                let config = hardcodedConfig;
                if (typeof __firebase_config !== 'undefined') try { config = JSON.parse(__firebase_config); } catch {}
                app = initializeApp(config); db = getFirestore(app); auth = getAuth(app);
                
                let authSuccess = false;
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try { await signInWithCustomToken(auth, __initial_auth_token); authSuccess = true; } catch {}
                }
                if (!authSuccess) await signInAnonymously(auth);
                
                onAuthStateChanged(auth, async (u) => { if (u) { document.getElementById('connectionStatus').innerHTML='<span class="w-2 h-2 rounded-full bg-green-500 mr-2"></span> Connected'; await loadData(); } });
                checkSidebarState(); window.addEventListener('resize', checkSidebarState);
            } catch (e) { console.error(e); renderAll(); }
        }

        async function loadData() {
            try {
                const snap = await getDoc(doc(db, DOC_PATH));
                if (snap.exists()) {
                    const d = parseFromFirestore(snap.data());
                    appData = { ...DEFAULT_DATA, ...d }; 
                } else {
                    appData = JSON.parse(JSON.stringify(DEFAULT_DATA));
                    await setDoc(doc(db, DOC_PATH), prepareForFirestore(appData));
                }
                renderAll();
            } catch(e) { console.error(e); renderAll(); }
        }

        window.saveData = async function() {
            const btn = document.getElementById('saveBtn'); const old = btn.innerHTML;
            btn.innerHTML = `<span class="animate-pulse">Saving...</span>`;
            try {
                if (auth.currentUser) await setDoc(doc(db, DOC_PATH), prepareForFirestore(appData));
                btn.innerHTML = `Disimpan!`; setTimeout(() => btn.innerHTML = old, 2000);
            } catch { alert("Gagal menyimpan."); btn.innerHTML = old; }
        }

        window.resetToDefault = async function() { if(confirm("Reset data?")) { appData=JSON.parse(JSON.stringify(DEFAULT_DATA)); saveData(); renderAll(); } }

        // --- SIDEBAR ---
        function checkSidebarState() { if (window.innerWidth < 768) isSidebarOpen = false; updateSidebarUI(); }
        window.toggleSidebar = function() { isSidebarOpen = !isSidebarOpen; updateSidebarUI(); }
        function updateSidebarUI() {
            const sb = document.getElementById('mainSidebar');
            if (isSidebarOpen) { sb.classList.remove('-translate-x-full'); } else { sb.classList.add('-translate-x-full'); }
        }
        window.switchView = function(view) {
            document.getElementById('view-carta').classList.add('hidden');
            document.getElementById('view-tables').classList.add('hidden');
            document.getElementById('nav-carta').className = "nav-item w-full flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-600 hover:bg-gray-50";
            document.getElementById('nav-tables').className = "nav-item w-full flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-600 hover:bg-gray-50";
            
            document.getElementById('view-'+view).classList.remove('hidden');
            document.getElementById('nav-'+view).className = "nav-item active w-full flex items-center px-3 py-2 text-sm font-medium rounded-md text-indigo-700 bg-indigo-50";
            if (window.innerWidth < 768) { isSidebarOpen = false; updateSidebarUI(); }
        }

        // --- CHART LOGIC ---
        window.setChartOrientation = function(mode) {
            chartOrientation = mode;
            document.getElementById('chartContainerWrapper').className = `org-container layout-${mode}`;
            document.getElementById('btn-horizontal').className = mode === 'horizontal' ? "px-3 py-1 text-xs font-bold rounded-md bg-indigo-100 text-indigo-700" : "px-3 py-1 text-xs font-bold rounded-md text-gray-500 hover:bg-gray-50";
            document.getElementById('btn-vertical').className = mode === 'vertical' ? "px-3 py-1 text-xs font-bold rounded-md bg-indigo-100 text-indigo-700" : "px-3 py-1 text-xs font-bold rounded-md text-gray-500 hover:bg-gray-50";
        }

        function renderOrgChart() {
            const container = document.getElementById('chartCanvas');
            const orphanContainer = document.getElementById('orphanCanvas');
            const orphanSection = document.getElementById('orphanSection');
            
            container.innerHTML = ''; orphanContainer.innerHTML = '';
            if (!appData.chart || !appData.chart.length) return;

            const map = {}; let root = null;
            appData.chart.forEach(n => map[n.id] = { ...n, children: [] });
            
            const visited = new Set();
            appData.chart.forEach(n => {
                if (n.parent === null) { root = map[n.id]; visited.add(n.id); } 
                else if (map[n.parent]) { map[n.parent].children.push(map[n.id]); visited.add(n.id); }
            });

            if (root) container.appendChild(createTreeNode(root));

            let hasOrphans = false;
            appData.chart.forEach(n => {
                if (!visited.has(n.id)) {
                    orphanContainer.appendChild(createTreeNode(map[n.id], true));
                    hasOrphans = true;
                }
            });
            orphanSection.classList.toggle('hidden', !hasOrphans);
        }

        function createTreeNode(node, isOrphan = false) {
            const wrapper = document.createElement('div');
            wrapper.className = 'node-wrapper';
            const card = document.createElement('div');
            card.className = `node-card ${node.color||'role-default'}`;
            if(isOrphan) card.classList.add('border-red-400', 'bg-red-50');
            card.innerHTML = `<div class="node-role">${node.role}</div><div class="node-name">${node.name}</div>`;
            card.onclick = (e) => { e.stopPropagation(); openModal(node.id); };
            wrapper.appendChild(card);

            if (!isOrphan && node.children && node.children.length > 0) {
                const childContainer = document.createElement('div');
                childContainer.className = 'children-container';
                node.children.forEach(c => childContainer.appendChild(createTreeNode(c)));
                wrapper.appendChild(childContainer);
            }
            return wrapper;
        }

        // --- EDIT MODAL ---
        window.openModal = function(id) {
            currentNodeId = id;
            const node = appData.chart.find(n => n.id === id);
            document.getElementById('nodeRole').value = node.role;
            document.getElementById('nodeName').value = node.name;
            document.getElementById('nodeParent').value = node.parent || '';
            document.getElementById('nodeColor').value = node.color || 'role-default';
            document.getElementById('nodeModal').classList.remove('hidden');
        }
        window.closeModal = function() { document.getElementById('nodeModal').classList.add('hidden'); }
        window.saveNodeEdit = function() {
            const node = appData.chart.find(n => n.id === currentNodeId);
            if(node) {
                node.role = document.getElementById('nodeRole').value;
                node.name = document.getElementById('nodeName').value;
                const newParent = document.getElementById('nodeParent').value;
                node.parent = newParent === '' ? null : newParent;
                node.color = document.getElementById('nodeColor').value;
                renderOrgChart(); closeModal(); saveData();
            }
        }
        window.addChildNode = function() {
            appData.chart.push({ id: 'n_'+Date.now(), parent: currentNodeId, role: 'JAWATAN', name: 'NAMA', color: 'role-default' });
            renderOrgChart(); closeModal(); saveData();
        }
        window.deleteNode = function() {
            if(confirm("Padam?")) {
                appData.chart = appData.chart.filter(n => n.id !== currentNodeId && n.parent !== currentNodeId);
                renderOrgChart(); closeModal(); saveData();
            }
        }

        // --- TABLES ---
        function renderTables() {
            const container = document.getElementById('activeTableContainer');
            const tabs = document.getElementById('tableTabs');
            container.innerHTML = ''; tabs.innerHTML = '';
            
            if (!appData.tables || !appData.tables.length) { container.innerHTML = '<p class="text-gray-400">Tiada data.</p>'; return; }
            if (activeTableIndex >= appData.tables.length) activeTableIndex = 0;

            appData.tables.forEach((t, i) => {
                const btn = document.createElement('button');
                btn.className = `whitespace-nowrap px-4 py-2 rounded-lg text-sm font-medium transition flex-shrink-0 ${i===activeTableIndex ? 'bg-indigo-600 text-white shadow' : 'bg-white border border-gray-200 text-gray-600'}`;
                btn.textContent = t.title;
                btn.onclick = () => { activeTableIndex = i; renderTables(); };
                tabs.appendChild(btn);
            });
            const addBtn = document.createElement('button');
            addBtn.className = "whitespace-nowrap px-3 py-2 rounded-lg text-sm font-bold text-indigo-600 bg-indigo-50 border border-indigo-200 hover:bg-indigo-100 flex items-center flex-shrink-0";
            addBtn.innerHTML = '+ Tambah Senarai';
            addBtn.onclick = window.addNewTable;
            tabs.appendChild(addBtn);

            const table = appData.tables[activeTableIndex];
            if (typeof table.rows === 'string') try { table.rows = JSON.parse(table.rows); } catch { table.rows = []; }

            let html = `
                <div class="mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
                    <input value="${table.title}" onchange="updateTableTitle(this.value)" class="text-xl font-bold bg-transparent border-b border-dashed border-gray-300 focus:border-indigo-500 outline-none text-gray-800 w-full md:w-1/2 py-1">
                    <button onclick="addColumn()" class="bg-blue-100 text-blue-700 hover:bg-blue-200 px-3 py-1 rounded text-sm font-bold transition flex items-center"><span class="mr-1">+</span> Lajur</button>
                </div>
                <div class="overflow-x-auto rounded-lg border border-gray-200 mb-4"><table class="data-table w-full"><thead><tr>`;
            
            // Header Row with Delete Column Buttons
            table.headers.forEach((h, i) => {
                html += `<th>
                            <div class="flex items-center justify-between">
                                <input value="${h}" onchange="updateHeader(${i}, this.value)" class="font-bold text-gray-600 w-full bg-transparent">
                                <button onclick="deleteColumn(${i})" class="col-action-btn text-red-300 hover:text-red-500 font-bold ml-2 text-xs" title="Hapus Lajur">√ó</button>
                            </div>
                         </th>`;
            });
            html += `<th class="w-10"></th></tr></thead><tbody>`;
            
            if (table.rows) {
                table.rows.forEach((r, ri) => {
                    html += `<tr>`;
                    r.forEach((c, ci) => html += `<td><input value="${c}" onchange="updateCell(${ri}, ${ci}, this.value)"></td>`);
                    html += `<td class="text-center"><button onclick="deleteRow(${ri})" class="row-action-btn text-red-400 hover:text-red-600 font-bold px-2 py-1 rounded text-xs">√ó</button></td></tr>`;
                });
            }
            html += `</tbody></table></div><div class="text-center"><button onclick="addRow()" class="bg-gray-100 text-gray-600 hover:bg-gray-200 px-6 py-2 rounded-lg text-sm font-bold transition border border-gray-300">+ Tambah Baris</button></div>`;
            container.innerHTML = html;
        }

        window.addNewTable = function() { const t=prompt("Nama Senarai:"); if(t){appData.tables.push({id:'t_'+Date.now(),title:t,headers:['Bil','Perkara','Catatan'],rows:[['1','Data','-']]});activeTableIndex=appData.tables.length-1;renderTables();saveData();} }
        window.deleteActiveTable = function() { if(appData.tables.length<=1)return alert("Kekalkan 1 senarai."); if(confirm("Hapus?")){appData.tables.splice(activeTableIndex,1);activeTableIndex=0;renderTables();saveData();} }
        window.addRow = function() { const t=appData.tables[activeTableIndex]; if(!t.rows)t.rows=[]; t.rows.push(new Array(t.headers.length).fill("-")); renderTables(); saveData(); }
        window.addColumn = function() { const c=prompt("Nama Lajur:"); if(!c)return; const t=appData.tables[activeTableIndex]; t.headers.push(c); if(t.rows)t.rows.forEach(r=>r.push("-")); renderTables(); saveData(); }
        window.deleteRow = function(i) { if(confirm("Padam baris?")){appData.tables[activeTableIndex].rows.splice(i,1);renderTables();saveData();} }
        
        // --- NEW: DELETE COLUMN FUNCTION ---
        window.deleteColumn = function(colIndex) {
            const table = appData.tables[activeTableIndex];
            if (table.headers.length <= 1) {
                alert("Anda mesti mempunyai sekurang-kurangnya satu lajur.");
                return;
            }
            if (confirm(`Padam lajur "${table.headers[colIndex]}" dan semua datanya?`)) {
                // Remove header
                table.headers.splice(colIndex, 1);
                // Remove data in that column for every row
                if (table.rows) {
                    table.rows.forEach(row => row.splice(colIndex, 1));
                }
                renderTables();
                saveData();
            }
        }

        window.updateTableTitle = (v) => { appData.tables[activeTableIndex].title = v; renderTables(); saveData(); };
        window.updateHeader = (i, v) => { appData.tables[activeTableIndex].headers[i] = v; saveData(); };
        window.updateCell = (r, c, v) => { appData.tables[activeTableIndex].rows[r][c] = v; saveData(); };

        function renderAll() { renderOrgChart(); renderTables(); }
        init();
    </script>
</body>
</html>

