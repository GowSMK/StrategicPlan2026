<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Pengurusan Kurikulum & Intervensi (v3.6)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        
        /* --- MOBILE SAFE AREA FIX --- */
        header {
            padding-top: max(1rem, env(safe-area-inset-top));
            padding-bottom: 1rem;
            height: auto;
        }

        /* --- ORG CHART STYLES --- */
        .org-container {
            overflow: auto; padding: 40px; background: white; border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); min-height: 500px;
            display: flex; flex-direction: column; align-items: flex-start;
        }
        .tree { display: inline-flex; flex-direction: column; align-items: center; margin: 0 auto; }
        .node-wrapper { display: flex; flex-direction: column; align-items: center; position: relative; padding: 0 10px; }
        .node-card {
            background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 8px;
            width: 140px; position: relative; z-index: 10; cursor: pointer; transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); text-align: center;
        }
        .node-card:hover { border-color: #6366f1; transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .node-role { font-size: 9px; font-weight: 800; text-transform: uppercase; color: #6366f1; margin-bottom: 4px; }
        .node-name { font-size: 11px; font-weight: 600; color: #1e293b; }
        
        /* Connectors */
        .layout-horizontal .children-container { display: flex; padding-top: 20px; position: relative; }
        .layout-horizontal .node-wrapper::before { content: ''; position: absolute; top: 0; height: 20px; width: 2px; background: #cbd5e1; }
        .layout-horizontal .tree > .node-wrapper::before { display: none; } 
        .layout-horizontal .children-container::before { content: ''; position: absolute; top: 0; left: 50%; height: 20px; width: 2px; background: #cbd5e1; }
        .layout-horizontal .node-wrapper:not(:only-child):first-child::after { content: ''; position: absolute; top: 0; right: 0; height: 2px; width: 50%; background: #cbd5e1; }
        .layout-horizontal .node-wrapper:not(:only-child):last-child::after { content: ''; position: absolute; top: 0; left: 0; height: 2px; width: 50%; background: #cbd5e1; }
        .layout-horizontal .node-wrapper:not(:only-child):not(:first-child):not(:last-child)::after { content: ''; position: absolute; top: 0; left: 0; height: 2px; width: 100%; background: #cbd5e1; }
        
        /* Colors */
        .role-pengetua { border-top: 4px solid #fcd34d; background: #fffbeb; }
        .role-pk { border-top: 4px solid #60a5fa; background: #eff6ff; }
        .role-gkmp { border-top: 4px solid #4ade80; background: #f0fdf4; }
        .role-kp { border-top: 4px solid #f472b6; background: #fdf2f8; }
        .role-default { border-top: 4px solid #94a3b8; }

        /* --- TABLE STYLES --- */
        .data-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.85rem; table-layout: fixed; }
        
        /* Header Cells */
        .data-table th { 
            background: #f8fafc; 
            padding: 8px; 
            text-align: left; 
            border: 1px solid #e2e8f0; 
            color: #475569; 
            min-width: 160px;
            width: 160px;
            position: relative; 
            vertical-align: middle;
        }
        
        /* Data Cells */
        .data-table td { 
            border: 1px solid #e2e8f0; 
            padding: 6px; 
            background: white; 
            vertical-align: middle; 
            min-width: 160px;
        }

        /* --- FIX: SMALL 'BIL' COLUMN --- */
        .data-table th:first-child, 
        .data-table td:first-child {
            width: 50px !important;
            min-width: 50px !important;
            text-align: center;
        }

        /* Inputs */
        .data-table input { 
            width: 100%; 
            background: transparent; 
            outline: none; 
            font-size: 0.85rem; 
            padding: 4px; 
            border-radius: 4px;
            border: 1px solid transparent;
        }
        .data-table input:focus {
            background-color: white;
            border-color: #cbd5e1;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
        }

        /* --- REVERTED "X" BUTTON STYLE (OLD HOVER METHOD) --- */
        .action-btn {
            flex-shrink: 0;
            color: #cbd5e1; /* Light gray by default */
            font-weight: bold;
            font-size: 16px;
            padding: 4px 8px;
            cursor: pointer;
            transition: color 0.2s;
            background: transparent;
            border: none;
        }
        .action-btn:hover {
            color: #ef4444; /* Red on hover */
        }
        
        /* Force delete buttons to be visible on touch devices active state */
        .action-btn:active {
            color: #ef4444;
        }

        /* --- PInTaS STYLES --- */
        .tab-active { border-bottom: 3px solid #4f46e5; color: #4f46e5; font-weight: 700; background-color: #eef2ff; }
        .tab-inactive { color: #6b7280; font-weight: 500; }
        .pintas-table th { background-color: #1e293b; color: white; border: 1px solid #334155; }
        .pintas-table textarea { width: 100%; min-height: 100px; resize: vertical; border: 1px solid #cbd5e1; border-radius: 4px; padding: 6px; font-size: 0.8rem; }
        .col-initiative { background-color: #eff6ff; border-left: 2px solid #6366f1 !important; border-right: 2px solid #6366f1 !important; }
        .swot-box { padding: 12px; border-radius: 8px; border: 1px solid; height: 100%; }
        .swot-s { background: #f0fdf4; border-color: #86efac; } .swot-w { background: #fef2f2; border-color: #fca5a5; }
        .swot-o { background: #eff6ff; border-color: #93c5fd; } .swot-c { background: #fffbeb; border-color: #fcd34d; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-800">

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 flex items-center justify-between px-4 shadow-sm z-30 relative flex-shrink-0">
        <div class="flex items-center gap-3">
            <button onclick="toggleSidebar()" class="p-2 rounded-lg text-gray-500 hover:bg-gray-100 md:hidden">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
            <div class="flex flex-col justify-center">
                <h1 id="pageTitle" class="text-lg font-extrabold text-slate-900 leading-tight tracking-tight">PENGURUSAN KURIKULUM</h1>
                <p class="text-xs text-slate-500 font-bold">SMK Seri Pulai Perdana â€¢ v3.6</p>
            </div>
            <div id="connectionStatus" class="ml-4 text-xs font-bold px-2 py-1 rounded bg-yellow-100 text-yellow-700 flex items-center hidden sm:flex">
                <span class="w-2 h-2 rounded-full bg-yellow-500 mr-2 animate-pulse"></span> Connecting...
            </div>
        </div>
        <button onclick="saveAllData()" id="saveBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow transition flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
            <span class="hidden sm:inline">Simpan</span>
        </button>
    </header>

    <div class="flex-1 flex overflow-hidden relative">
        <!-- Sidebar -->
        <aside id="mainSidebar" class="bg-white border-r border-gray-200 flex flex-col w-64 absolute md:relative h-full transform -translate-x-full md:translate-x-0 transition-transform duration-300 z-20 shadow-lg md:shadow-none">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center md:hidden">
                <span class="font-bold text-gray-400 text-xs">MENU</span>
                <button onclick="toggleSidebar()" class="text-gray-400">âœ•</button>
            </div>
            <nav class="p-2 space-y-1">
                <button onclick="switchView('carta')" id="nav-carta" class="nav-item active w-full flex items-center px-3 py-3 text-sm font-bold rounded-lg text-indigo-700 bg-indigo-50">
                    <span class="mr-3 text-lg">ðŸ“Š</span> Carta Organisasi
                </button>
                <button onclick="switchView('tables')" id="nav-tables" class="nav-item w-full flex items-center px-3 py-3 text-sm font-medium rounded-lg text-slate-600 hover:bg-slate-50">
                    <span class="mr-3 text-lg">ðŸ“‹</span> Data & Analisis
                </button>
                <div class="py-2"><div class="border-t border-gray-200"></div></div>
                <button onclick="switchView('pintas')" id="nav-pintas" class="nav-item w-full flex items-center px-3 py-3 text-sm font-medium rounded-lg text-slate-600 hover:bg-slate-50">
                    <span class="mr-3 text-lg">ðŸš€</span> Plan Intervensi (PInTaS)
                </button>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto bg-slate-50 p-4 md:p-6 w-full relative pb-20 md:pb-6" id="mainContent">
            
            <!-- VIEW 1: CARTA ORGANISASI -->
            <div id="view-carta" class="space-y-4">
                <div class="flex justify-between items-end mb-2">
                    <h2 class="text-2xl font-bold text-slate-800">Carta Organisasi</h2>
                    <div class="bg-white border rounded p-1 flex">
                        <button onclick="setChartOrientation('horizontal')" class="px-3 py-1 text-xs font-bold rounded bg-indigo-100 text-indigo-700">Melintang</button>
                        <button onclick="setChartOrientation('vertical')" class="px-3 py-1 text-xs font-bold rounded text-slate-500 hover:bg-slate-50">Menegak</button>
                    </div>
                </div>
                <div id="chartContainerWrapper" class="org-container layout-horizontal">
                    <div id="chartCanvas" class="tree"></div>
                </div>
            </div>

            <!-- VIEW 2: DATA TABLES (Enhanced) -->
            <div id="view-tables" class="hidden space-y-4">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-slate-800">Data & Jawatankuasa</h2>
                    <div class="flex gap-2">
                        <button onclick="addNewTable()" class="text-xs bg-indigo-50 text-indigo-600 px-3 py-1 rounded font-bold border border-indigo-200 shadow-sm hover:bg-indigo-100">+ Senarai Baru</button>
                        <button onclick="deleteActiveTable()" class="text-xs bg-red-50 text-red-600 px-3 py-1 rounded font-bold border border-red-200 shadow-sm hover:bg-red-100">Hapus Senarai</button>
                    </div>
                </div>
                <div class="flex gap-2 overflow-x-auto pb-2 border-b border-slate-200" id="tableTabs"></div>
                <div id="activeTableContainer" class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 min-h-[400px]"></div>
            </div>

            <!-- VIEW 3: PInTaS -->
            <div id="view-pintas" class="hidden space-y-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">Plan Intervensi Transformasi</h2>
                        <p class="text-xs text-slate-500 font-semibold">Data disinkronasi dengan dokumen PInTaS utama.</p>
                    </div>
                    <div class="flex items-center gap-2 mt-2 md:mt-0">
                        <span class="text-[10px] font-bold bg-green-100 text-green-700 px-2 py-1 rounded border border-green-200">LIVE DATA</span>
                    </div>
                </div>
                <div class="flex space-x-1 border-b border-slate-200 overflow-x-auto" id="kraTabs"></div>
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
                    <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4">Fasa 1: Analisis SWOT</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="swot-box swot-s"><div class="font-bold text-xs text-green-700 mb-2">KEKUATAN (S)</div><textarea id="input_s" class="w-full bg-transparent border-none text-sm resize-none focus:ring-0" rows="4"></textarea></div>
                        <div class="swot-box swot-w"><div class="font-bold text-xs text-red-700 mb-2">KELEMAHAN (W)</div><textarea id="input_w" class="w-full bg-transparent border-none text-sm resize-none focus:ring-0" rows="4"></textarea></div>
                        <div class="swot-box swot-o"><div class="font-bold text-xs text-blue-700 mb-2">PELUANG (O)</div><textarea id="input_o" class="w-full bg-transparent border-none text-sm resize-none focus:ring-0" rows="4"></textarea></div>
                        <div class="swot-box swot-c"><div class="font-bold text-xs text-yellow-700 mb-2">ANCAMAN (T)</div><textarea id="input_c" class="w-full bg-transparent border-none text-sm resize-none focus:ring-0" rows="4"></textarea></div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5 overflow-hidden">
                    <div class="flex justify-between mb-4">
                        <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider">Fasa 2: Matriks Intervensi</h3>
                        <button onclick="addPintasRow()" class="text-xs font-bold bg-emerald-500 text-white px-3 py-1 rounded shadow hover:bg-emerald-600">+ Inisiatif</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="pintas-table min-w-[1800px]">
                            <thead>
                                <tr>
                                    <th class="w-10">No</th><th class="w-48">1. Bidang Fokus</th><th class="w-48">2. Data Dikumpul</th><th class="w-48">3. TOV</th><th class="w-48">4. KPI / ETR</th><th class="w-64 bg-indigo-900 border-indigo-700 text-yellow-300 shadow-inner">5. Inisiatif (Program)</th><th class="w-48">6. Tanggungjawab</th><th class="w-32">7. Tempoh</th><th class="w-32">8. Sumber</th><th class="w-32">9. Evidens</th><th class="w-32">10. Penilaian</th><th class="w-24">11. Kos</th><th class="w-10"></th>
                                </tr>
                            </thead>
                            <tbody id="interventionTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Edit Modal -->
    <div id="nodeModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-80 p-6">
            <h3 class="text-lg font-bold text-slate-800 mb-4">Edit Posisi</h3>
            <input type="hidden" id="nodeId">
            <div class="space-y-3">
                <input type="text" id="nodeRole" placeholder="Jawatan" class="w-full border border-gray-300 rounded p-2 text-sm font-bold">
                <input type="text" id="nodeName" placeholder="Nama Guru" class="w-full border border-gray-300 rounded p-2 text-sm">
                <select id="nodeColor" class="w-full border border-gray-300 rounded p-2 text-sm">
                    <option value="role-default">Kelabu (Umum)</option><option value="role-pengetua">Kuning (Pengetua)</option><option value="role-pk">Biru (Penolong Kanan)</option><option value="role-gkmp">Hijau (GKMP)</option><option value="role-kp">Merah Jambu (KP)</option>
                </select>
            </div>
            <div class="mt-4 flex gap-2">
                <button onclick="saveNodeEdit()" class="flex-1 bg-indigo-600 text-white font-bold py-2 rounded text-sm">Simpan</button>
                <button onclick="closeModal()" class="flex-1 bg-gray-100 text-gray-500 font-bold py-2 rounded text-sm">Batal</button>
            </div>
            <div class="mt-2 pt-2 border-t flex justify-between">
                <button onclick="addChildNode()" class="text-xs font-bold text-green-600">+ Anak</button>
                <button onclick="deleteNode()" class="text-xs font-bold text-red-600">Padam</button>
            </div>
        </div>
    </div>

    <!-- MAIN LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DEFAULT DATA ---
        const DEFAULT_KURIKULUM = {
            chart: [{id:'root',parent:null,role:'PENGETUA',name:'NAMA PENGETUA',color:'role-pengetua'},{id:'pk1',parent:'root',role:'PK PENTADBIRAN',name:'NAMA PK1',color:'role-pk'},{id:'gkmp1',parent:'pk1',role:'GKMP BAHASA',name:'NAMA GKMP',color:'role-gkmp'},{id:'kp1',parent:'gkmp1',role:'KP BM',name:'NAMA KP',color:'role-kp'}],
            tables: [{id:'t1',title:'Senarai KP 2025',headers:['Bil','Panitia','Nama'],rows:[['1','BM','Ali']]}]
        };

        const DEFAULT_PINTAS = {
            "KRA1": { id:"KRA1", title:"KRA 1: Pemimpin Berkesan", swot: { s:"S1. SLT Proaktif", w:"W1. Data belum realtime", o:"O1. Jaringan SIP+", c:"T1. Kekangan masa" }, interventions: [{fokus:"Kepimpinan",data:"SKPMg2",tov:"88%",etr:"95%",inisiatif:"1. BENGKEL COACHING",tanggungjawab:"Pengetua",tempoh:"Jan",sumber:"RM1000",evidens:"Laporan",penilaian:"",kos:""}] },
            "KRA2": { id:"KRA2", title:"KRA 2: Guru Berkualiti", swot:{s:"",w:"",o:"",c:""}, interventions:[] },
            "KRA3": { id:"KRA3", title:"KRA 3: Persekitaran", swot:{s:"",w:"",o:"",c:""}, interventions:[] },
            "KRA4": { id:"KRA4", title:"KRA 4: PIBG", swot:{s:"",w:"",o:"",c:""}, interventions:[] }
        };

        const CONFIG = { apiKey: "AIzaSyDvGANnXKmwWlpRT3Wlfsm-WBOEIC62SWU", authDomain: "strategic2026.firebaseapp.com", projectId: "strategic2026", storageBucket: "strategic2026.firebasestorage.app", messagingSenderId: "642605714672", appId: "1:642605714672:web:5dcdfbf351c36ca6084635" };
        const APP_ID = 'strategic2026';
        const PATH_KURIKULUM = `artifacts/${APP_ID}/public/data/kurikulum_editor/kurikulum_live_v1`;
        const PATH_PINTAS = `artifacts/${APP_ID}/public/data/pintas/main_plan`;

        let app, db, auth;
        let kurikulumData = JSON.parse(JSON.stringify(DEFAULT_KURIKULUM));
        let pintasData = JSON.parse(JSON.stringify(DEFAULT_PINTAS));
        let activeTableIndex = 0;
        let activeKra = "KRA1";
        let currentNodeId = null;
        let isOffline = false;

        async function init() {
            try {
                app = initializeApp(CONFIG); db = getFirestore(app); auth = getAuth(app);
                await signInAnonymously(auth);
                document.getElementById('connectionStatus').innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500 mr-2"></span> Online';
                await loadAllData();
            } catch (error) {
                isOffline = true;
                document.getElementById('connectionStatus').innerHTML = '<span class="w-2 h-2 rounded-full bg-red-500 mr-2"></span> Offline Mode';
                renderAll();
            }
        }

        async function loadAllData() {
            if (isOffline) return;
            try {
                const kSnap = await getDoc(doc(db, PATH_KURIKULUM));
                if (kSnap.exists()) {
                    let d = kSnap.data();
                    if(d.tables) d.tables.forEach(t => { try{ if(typeof t.rows==='string') t.rows=JSON.parse(t.rows) }catch{} });
                    kurikulumData = { ...DEFAULT_KURIKULUM, ...d };
                }
                const pSnap = await getDoc(doc(db, PATH_PINTAS));
                if (pSnap.exists()) pintasData = { ...DEFAULT_PINTAS, ...pSnap.data() };
                renderAll();
            } catch (e) { renderAll(); }
        }

        window.saveAllData = async function() {
            const btn = document.getElementById('saveBtn'); const oldText = btn.innerHTML; btn.innerHTML = 'Saving...';
            if (!document.getElementById('view-pintas').classList.contains('hidden')) savePintasInputs();
            if (isOffline) { alert("Offline Mode: Data tidak disimpan."); btn.innerHTML = oldText; return; }
            try {
                const kClean = JSON.parse(JSON.stringify(kurikulumData));
                kClean.tables.forEach(t => { if(t.rows) t.rows = JSON.stringify(t.rows); });
                await setDoc(doc(db, PATH_KURIKULUM), kClean);
                await setDoc(doc(db, PATH_PINTAS), pintasData);
                btn.innerHTML = 'Saved!'; setTimeout(() => btn.innerHTML = oldText, 2000);
            } catch (e) { alert("Gagal menyimpan!"); btn.innerHTML = oldText; }
        }

        function renderAll() { renderChart(); renderTables(); renderPintas(); }
        window.setChartOrientation = (m) => { document.getElementById('chartContainerWrapper').className = `org-container layout-${m}`; };
        function renderChart() {
            const container = document.getElementById('chartCanvas'); container.innerHTML = '';
            const map = {}; kurikulumData.chart.forEach(n => map[n.id] = {...n, children:[]});
            let root = null;
            kurikulumData.chart.forEach(n => { if(n.parent === null) root = map[n.id]; else if(map[n.parent]) map[n.parent].children.push(map[n.id]); });
            if(root) container.appendChild(createNode(root));
        }
        function createNode(node) {
            const wrap = document.createElement('div'); wrap.className = 'node-wrapper';
            const card = document.createElement('div'); card.className = `node-card ${node.color || 'role-default'}`;
            card.innerHTML = `<div class="node-role">${node.role}</div><div class="node-name">${node.name}</div>`;
            card.onclick = (e) => { e.stopPropagation(); openModal(node.id); };
            wrap.appendChild(card);
            if(node.children.length > 0) {
                const kids = document.createElement('div'); kids.className = 'children-container';
                node.children.forEach(c => kids.appendChild(createNode(c)));
                wrap.appendChild(kids);
            }
            return wrap;
        }

        function renderTables() {
            const tabs = document.getElementById('tableTabs'); const container = document.getElementById('activeTableContainer');
            tabs.innerHTML = ''; container.innerHTML = '';
            if(!kurikulumData.tables.length) { container.innerHTML = 'Tiada data'; return; }
            if(activeTableIndex >= kurikulumData.tables.length) activeTableIndex = 0;

            kurikulumData.tables.forEach((t, i) => {
                const b = document.createElement('button');
                b.className = `px-4 py-2 rounded-lg text-sm font-bold whitespace-nowrap ${i===activeTableIndex ? 'bg-indigo-600 text-white shadow' : 'bg-white border text-slate-600'}`;
                b.textContent = t.title;
                b.onclick = () => { activeTableIndex = i; renderTables(); };
                tabs.appendChild(b);
            });

            const t = kurikulumData.tables[activeTableIndex];
            let h = `
                <div class="mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
                    <input class="text-xl font-bold bg-transparent border-b border-dashed w-full md:w-1/2 py-1 text-slate-800 focus:border-indigo-500" value="${t.title}" onchange="updateTableTitle(this.value)" placeholder="Nama Senarai">
                    <button onclick="addColumn()" class="bg-blue-50 text-blue-700 hover:bg-blue-100 px-3 py-1 rounded text-sm font-bold transition flex items-center border border-blue-200">
                        <span class="mr-1 text-lg">+</span> Lajur
                    </button>
                </div>
                <div class="overflow-x-auto rounded-lg border border-slate-200 shadow-sm mb-4">
                    <table class="data-table">
                        <thead><tr>`;
            
            t.headers.forEach((hdr, i) => {
                // Reverted X Button Style
                h += `<th>
                        <div class="flex items-center gap-2">
                            <input value="${hdr}" onchange="updateHeader(${i},this.value)" placeholder="Tajuk..." class="font-bold w-full">
                            <button onclick="deleteColumn(${i})" class="action-btn" title="Hapus">Ã—</button>
                        </div>
                      </th>`;
            });
            h += `<th class="w-10"></th></tr></thead><tbody>`;
            
            if(t.rows) t.rows.forEach((row, ri) => {
                h += `<tr>`;
                row.forEach((cell, ci) => h += `<td><input value="${cell}" onchange="updateCell(${ri},${ci},this.value)"></td>`);
                // Reverted X Button Style
                h += `<td class="text-center bg-gray-50"><button class="action-btn" onclick="delRow(${ri})" title="Padam Baris">Ã—</button></td></tr>`;
            });
            h += `</tbody></table></div>
                  <div class="text-center">
                    <button class="bg-slate-100 text-slate-600 hover:bg-slate-200 px-6 py-2 rounded-lg text-sm font-bold border border-slate-300 transition" onclick="addRow()">+ Tambah Baris</button>
                  </div>`;
            container.innerHTML = h;
        }

        window.addNewTable = () => { const n=prompt("Nama Senarai:"); if(n){kurikulumData.tables.push({id:Date.now(),title:n,headers:['Bil','Lajur 2'],rows:[['1','-']]}); activeTableIndex=kurikulumData.tables.length-1; renderTables(); saveAllData();} };
        window.deleteActiveTable = () => { if(kurikulumData.tables.length<=1)return alert("Perlu sekurang-kurangnya satu senarai."); if(confirm("Padam senarai ini?")){kurikulumData.tables.splice(activeTableIndex,1);activeTableIndex=0;renderTables();saveAllData();} };
        window.updateTableTitle = (v) => { kurikulumData.tables[activeTableIndex].title = v; saveAllData(); };
        window.updateHeader = (i,v) => { kurikulumData.tables[activeTableIndex].headers[i]=v; saveAllData(); };
        window.updateCell = (r,c,v) => { kurikulumData.tables[activeTableIndex].rows[r][c]=v; saveAllData(); };
        
        // --- AUTO-NUMBERING & IMPROVED ADD/DELETE ---
        window.addRow = () => { 
            const t = kurikulumData.tables[activeTableIndex]; 
            if(!t.rows) t.rows=[]; 
            // Calculate next number
            const nextNum = t.rows.length + 1;
            const newRow = new Array(t.headers.length).fill('-');
            newRow[0] = nextNum; // Auto-populate first column
            t.rows.push(newRow); 
            renderTables(); 
            saveAllData(); 
        };
        window.delRow = (i) => { if(confirm("Padam baris?")){ kurikulumData.tables[activeTableIndex].rows.splice(i,1); renderTables(); saveAllData(); }};
        
        window.addColumn = () => { 
            const t = kurikulumData.tables[activeTableIndex]; 
            t.headers.push("Lajur " + (t.headers.length + 1)); // Auto-name
            if(t.rows) t.rows.forEach(r => r.push("-")); 
            renderTables(); 
            saveAllData(); 
        };

        window.deleteColumn = (i) => { 
            const t = kurikulumData.tables[activeTableIndex];
            if(confirm(`Padam lajur "${t.headers[i]}"?`)){ 
                t.headers.splice(i,1); 
                if(t.rows) t.rows.forEach(r => r.splice(i,1)); 
                renderTables(); 
                saveAllData(); 
            }
        };

        function renderPintas() {
            const tabs = document.getElementById('kraTabs'); tabs.innerHTML = '';
            Object.keys(pintasData).forEach(key => {
                const k = pintasData[key]; const b = document.createElement('button');
                b.className = `px-6 py-3 text-sm font-medium whitespace-nowrap ${key===activeKra ? 'tab-active' : 'tab-inactive'}`;
                b.textContent = k.title; b.onclick = () => { savePintasInputs(); activeKra = key; renderPintas(); };
                tabs.appendChild(b);
            });
            const data = pintasData[activeKra];
            document.getElementById('input_s').value = data.swot.s; document.getElementById('input_w').value = data.swot.w;
            document.getElementById('input_o').value = data.swot.o; document.getElementById('input_c').value = data.swot.c;
            const tbody = document.getElementById('interventionTableBody'); tbody.innerHTML = '';
            if(data.interventions) data.interventions.forEach((row, i) => {
                const tr = document.createElement('tr'); const fields = ['fokus','data','tov','etr','inisiatif','tanggungjawab','tempoh','sumber','evidens','penilaian','kos'];
                let h = `<td class="text-center text-xs font-bold text-slate-400 pt-2">${i+1}</td>`;
                fields.forEach(f => { const cls = f==='inisiatif' ? 'col-initiative' : ''; h += `<td><textarea data-f="${f}" class="${cls}" onchange="savePintasInputs()">${row[f]||''}</textarea></td>`; });
                h += `<td class="text-center"><button class="action-btn" onclick="delPintasRow(${i})">Ã—</button></td>`;
                tr.innerHTML = h; tbody.appendChild(tr);
            });
        }
        window.savePintasInputs = () => {
            if(!activeKra || !pintasData[activeKra]) return;
            const d = pintasData[activeKra];
            d.swot.s = document.getElementById('input_s').value; d.swot.w = document.getElementById('input_w').value;
            d.swot.o = document.getElementById('input_o').value; d.swot.c = document.getElementById('input_c').value;
            const rows = Array.from(document.querySelectorAll('#interventionTableBody tr'));
            d.interventions = rows.map(tr => { const obj = {}; tr.querySelectorAll('textarea').forEach(ta => obj[ta.getAttribute('data-f')] = ta.value); return obj; });
        };
        window.addPintasRow = () => { savePintasInputs(); pintasData[activeKra].interventions.push({}); renderPintas(); };
        window.delPintasRow = (i) => { if(confirm("Padam?")){ savePintasInputs(); pintasData[activeKra].interventions.splice(i,1); renderPintas(); }};

        window.openModal = (id) => { currentNodeId=id; const n=kurikulumData.chart.find(x=>x.id===id); if(n){document.getElementById('nodeRole').value=n.role;document.getElementById('nodeName').value=n.name;document.getElementById('nodeColor').value=n.color;document.getElementById('nodeModal').classList.remove('hidden');}};
        window.closeModal = () => document.getElementById('nodeModal').classList.add('hidden');
        window.saveNodeEdit = () => { const n=kurikulumData.chart.find(x=>x.id===currentNodeId); if(n){n.role=document.getElementById('nodeRole').value;n.name=document.getElementById('nodeName').value;n.color=document.getElementById('nodeColor').value;renderChart();closeModal();saveAllData();}};
        window.addChildNode = () => { kurikulumData.chart.push({id:'n'+Date.now(),parent:currentNodeId,role:'Jawatan',name:'Nama',color:'role-default'}); renderChart(); closeModal(); saveAllData(); };
        window.deleteNode = () => { if(confirm("Padam?")){ kurikulumData.chart=kurikulumData.chart.filter(n=>n.id!==currentNodeId && n.parent!==currentNodeId); renderChart(); closeModal(); saveAllData(); }};
        window.toggleSidebar = () => { const s = document.getElementById('mainSidebar'); s.classList.toggle('-translate-x-full'); };
        window.switchView = (v) => {
            if(!document.getElementById('view-pintas').classList.contains('hidden')) savePintasInputs();
            ['carta','tables','pintas'].forEach(x => { document.getElementById('view-'+x).classList.add('hidden'); document.getElementById('nav-'+x).className = "nav-item w-full flex items-center px-3 py-3 text-sm font-medium rounded-lg text-slate-600 hover:bg-slate-50"; });
            document.getElementById('view-'+v).classList.remove('hidden'); document.getElementById('nav-'+v).className = "nav-item active w-full flex items-center px-3 py-3 text-sm font-bold rounded-lg text-indigo-700 bg-indigo-50";
            document.getElementById('pageTitle').textContent = v === 'pintas' ? "PLAN INTERVENSI TRANSFORMASI" : "PENGURUSAN KURIKULUM";
            if(v==='pintas') renderPintas();
            if(window.innerWidth < 768) document.getElementById('mainSidebar').classList.add('-translate-x-full');
        };
        init();
    </script>
</body>
</html>

