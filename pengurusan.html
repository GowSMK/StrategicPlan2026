<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Sistem Pengurusan Bersepadu - SMK Seri Pulai Perdana</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Use Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    
    <style>
        /* --- GLOBAL & SHARED STYLES --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Slate-100 */
            color: #1e293b; /* Slate-800 */
            overflow-x: hidden; /* Prevent horizontal scroll on body */
        }

        /* --- MODULE TRANSITIONS --- */
        .module-container {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            width: 100%;
        }
        .module-container.active-module {
            display: block;
            opacity: 1;
        }

        /* --- NAVIGATION STYLES --- */
        .nav-pill {
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s;
            color: #64748b;
        }
        .nav-pill:hover {
            background-color: #e2e8f0;
            color: #334155;
        }
        .nav-pill.active {
            background-color: #4f46e5; /* Indigo-600 */
            color: white;
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2);
        }

        /* --- LOADING OVERLAY --- */
        #globalLoadingOverlay {
            position: fixed; inset: 0; z-index: 100;
            background-color: #f8fafc;
            display: flex; align-items: center; justify-content: center;
            flex-direction: column;
        }

        /* =========================================
           STYLES FROM MODULE A: KURIKULUM EDITOR
           ========================================= */
        /* Org Chart Styles */
        .org-container {
            overflow: auto; padding: 40px; background: white; border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); min-height: 500px;
            display: flex; flex-direction: column; align-items: flex-start;
        }
        .tree { display: inline-flex; flex-direction: column; align-items: center; margin: 0 auto; }
        .node-wrapper { display: flex; flex-direction: column; align-items: center; position: relative; padding: 0 10px; }
        .node-card {
            background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 8px;
            width: 140px; position: relative; z-index: 10; cursor: pointer; transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); text-align: center;
        }
        .node-card:hover { border-color: #6366f1; transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .node-role { font-size: 9px; font-weight: 800; text-transform: uppercase; color: #6366f1; margin-bottom: 4px; }
        .node-name { font-size: 11px; font-weight: 600; color: #1e293b; }
        
        /* Connectors */
        .layout-horizontal .children-container { display: flex; padding-top: 20px; position: relative; }
        .layout-horizontal .node-wrapper::before { content: ''; position: absolute; top: 0; height: 20px; width: 2px; background: #cbd5e1; }
        .layout-horizontal .tree > .node-wrapper::before { display: none; } 
        .layout-horizontal .children-container::before { content: ''; position: absolute; top: 0; left: 50%; height: 20px; width: 2px; background: #cbd5e1; }
        .layout-horizontal .node-wrapper:not(:only-child):first-child::after { content: ''; position: absolute; top: 0; right: 0; height: 2px; width: 50%; background: #cbd5e1; }
        .layout-horizontal .node-wrapper:not(:only-child):last-child::after { content: ''; position: absolute; top: 0; left: 0; height: 2px; width: 50%; background: #cbd5e1; }
        .layout-horizontal .node-wrapper:not(:only-child):not(:first-child):not(:last-child)::after { content: ''; position: absolute; top: 0; left: 0; height: 2px; width: 100%; background: #cbd5e1; }
        
        /* Node Colors */
        .role-pengetua { border-top: 4px solid #fcd34d; background: #fffbeb; }
        .role-pk { border-top: 4px solid #60a5fa; background: #eff6ff; }
        .role-gkmp { border-top: 4px solid #4ade80; background: #f0fdf4; }
        .role-kp { border-top: 4px solid #f472b6; background: #fdf2f8; }
        .role-default { border-top: 4px solid #94a3b8; }

        /* Data Table Styles (Kurikulam) */
        .k-data-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.85rem; table-layout: fixed; }
        .k-data-table th { background: #f8fafc; padding: 8px; text-align: left; border: 1px solid #e2e8f0; color: #475569; min-width: 160px; width: 160px; vertical-align: middle; }
        .k-data-table td { border: 1px solid #e2e8f0; padding: 6px; background: white; vertical-align: middle; min-width: 160px; }
        .k-data-table th:first-child, .k-data-table td:first-child { width: 50px !important; min-width: 50px !important; text-align: center; }
        .k-data-table input { width: 100%; background: transparent; outline: none; font-size: 0.85rem; padding: 4px; border-radius: 4px; border: 1px solid transparent; }
        .k-data-table input:focus { background-color: white; border-color: #cbd5e1; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1); }
        .k-action-btn { color: #cbd5e1; font-weight: bold; font-size: 16px; padding: 4px 8px; cursor: pointer; background: transparent; border: none; }
        .k-action-btn:hover { color: #ef4444; }

        /* PInTaS Specific (Kurikulam Module) */
        .k-tab-active { border-bottom: 3px solid #4f46e5; color: #4f46e5; font-weight: 700; background-color: #eef2ff; }
        .k-tab-inactive { color: #6b7280; font-weight: 500; }
        .k-pintas-table th { background-color: #1e293b; color: white; border: 1px solid #334155; }
        .k-pintas-table textarea { width: 100%; min-height: 100px; resize: vertical; border: 1px solid #cbd5e1; border-radius: 4px; padding: 6px; font-size: 0.8rem; }
        .k-col-initiative { background-color: #eff6ff; border-left: 2px solid #6366f1 !important; border-right: 2px solid #6366f1 !important; }
        .k-swot-box { padding: 12px; border-radius: 8px; border: 1px solid; height: 100%; }
        .k-swot-s { background: #f0fdf4; border-color: #86efac; } .k-swot-w { background: #fef2f2; border-color: #fca5a5; }
        .k-swot-o { background: #eff6ff; border-color: #93c5fd; } .k-swot-c { background: #fffbeb; border-color: #fcd34d; }

    </style>
</head>
<body>

<!-- GLOBAL LOADER -->
<div id="globalLoadingOverlay">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-4"></div>
    <p class="text-indigo-800 font-bold animate-pulse">Memulakan Sistem Bersepadu...</p>
</div>

<!-- GLOBAL HEADER -->
<nav class="bg-white shadow-sm sticky top-0 z-50 border-b border-gray-200" style="padding-top: env(safe-area-inset-top);">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16 items-center">
            <div class="flex items-center">
                <!-- BACK BUTTON (Links to Main Page) -->
                <a href="index.html" class="mr-3 p-2 rounded-full text-gray-500 hover:bg-gray-100 hover:text-indigo-600 transition-colors" title="Kembali ke Laman Utama">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                </a>
                
                <div class="flex-shrink-0 flex items-center gap-2">
                    <div class="h-8 w-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold">SP</div>
                    <div class="hidden md:block">
                        <h1 class="text-lg font-bold text-gray-900 leading-tight">SMK Seri Pulai Perdana</h1>
                        <p class="text-xs text-gray-500">Sistem Pengurusan Bersepadu</p>
                    </div>
                </div>
                <!-- Navigation pills for Strategic Plan REMOVED -->
            </div>
            <div class="flex items-center">
                <span id="globalConnectionStatus" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                    <span class="w-2 h-2 mr-1 bg-green-500 rounded-full"></span>
                    Online
                </span>
            </div>
        </div>
    </div>
</nav>

<!-- MAIN CONTENT WRAPPER -->
<main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">

    <!-- =======================================================
         MODULE A: KURIKULUM EDITOR (Pengurusan Kurikulum)
         ======================================================= -->
    <div id="module-kurikulum" class="module-container active-module">
        
        <!-- Kurikulum Header / Toolbar -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
            <div>
                <h2 id="k-pageTitle" class="text-2xl font-extrabold text-slate-800">Pengurusan Kurikulum</h2>
                <p class="text-sm text-slate-500">Carta Organisasi, Data Guru & PInTaS Intervensi</p>
            </div>
            <div class="flex gap-2">
                <button onclick="window.kurikulumApp.saveAllData()" id="k-saveBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow transition flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                    Simpan Data Kurikulum
                </button>
            </div>
        </div>

        <div class="flex flex-col md:flex-row gap-6 relative">
            <!-- Kurikulum Sidebar -->
            <aside class="w-full md:w-64 bg-white rounded-xl shadow-sm border border-gray-200 p-2 h-fit">
                <nav class="space-y-1">
                    <button onclick="window.kurikulumApp.switchView('carta')" id="k-nav-carta" class="w-full flex items-center px-3 py-3 text-sm font-bold rounded-lg text-indigo-700 bg-indigo-50 transition-colors">
                        <span class="mr-3">ðŸ“Š</span> Carta Organisasi
                    </button>
                    <button onclick="window.kurikulumApp.switchView('tables')" id="k-nav-tables" class="w-full flex items-center px-3 py-3 text-sm font-medium rounded-lg text-slate-600 hover:bg-slate-50 transition-colors">
                        <span class="mr-3">ðŸ“‹</span> Data & Analisis
                    </button>
                    <div class="my-2 border-t border-gray-100"></div>
                    <button onclick="window.kurikulumApp.switchView('pintas')" id="k-nav-pintas" class="w-full flex items-center px-3 py-3 text-sm font-medium rounded-lg text-slate-600 hover:bg-slate-50 transition-colors">
                        <span class="mr-3">ðŸš€</span> Plan Intervensi (PInTaS)
                    </button>
                </nav>
            </aside>

            <!-- Kurikulum Main Area -->
            <div class="flex-1 min-w-0">
                
                <!-- VIEW 1: CARTA ORGANISASI -->
                <div id="k-view-carta" class="space-y-4">
                    <div class="flex justify-end mb-2">
                        <div class="bg-white border rounded p-1 flex shadow-sm">
                            <button onclick="window.kurikulumApp.setChartOrientation('horizontal')" class="px-3 py-1 text-xs font-bold rounded bg-indigo-100 text-indigo-700 hover:bg-indigo-200">Melintang</button>
                            <button onclick="window.kurikulumApp.setChartOrientation('vertical')" class="px-3 py-1 text-xs font-bold rounded text-slate-500 hover:bg-slate-50">Menegak</button>
                        </div>
                    </div>
                    <div id="chartContainerWrapper" class="org-container layout-horizontal">
                        <div id="chartCanvas" class="tree"></div>
                    </div>
                </div>

                <!-- VIEW 2: DATA TABLES -->
                <div id="k-view-tables" class="hidden space-y-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-slate-700">Senarai Data</h3>
                        <div class="flex gap-2">
                            <button onclick="window.kurikulumApp.addNewTable()" class="text-xs bg-indigo-50 text-indigo-600 px-3 py-2 rounded font-bold border border-indigo-200 hover:bg-indigo-100">+ Senarai Baru</button>
                            <button onclick="window.kurikulumApp.deleteActiveTable()" class="text-xs bg-red-50 text-red-600 px-3 py-2 rounded font-bold border border-red-200 hover:bg-red-100">Hapus Senarai</button>
                        </div>
                    </div>
                    <div class="flex gap-2 overflow-x-auto pb-2 border-b border-slate-200" id="k-tableTabs"></div>
                    <div id="k-activeTableContainer" class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 min-h-[400px]"></div>
                </div>

                <!-- VIEW 3: PInTaS -->
                <div id="k-view-pintas" class="hidden space-y-6">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-bold text-slate-700">Modul Intervensi (One Page PInTaS)</h3>
                        <span class="text-[10px] font-bold bg-green-100 text-green-700 px-2 py-1 rounded border border-green-200">LIVE SYNC</span>
                    </div>
                    
                    <div class="flex space-x-1 border-b border-slate-200 overflow-x-auto pb-2" id="k-kraTabs"></div>
                    
                    <!-- Fasa 1 -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
                        <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">Fasa 1: Analisis SWOT</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="k-swot-box k-swot-s"><div class="font-bold text-xs text-green-700 mb-2">KEKUATAN (S)</div><textarea id="k-input_s" class="w-full bg-transparent border-none text-sm resize-none focus:ring-0" rows="4"></textarea></div>
                            <div class="k-swot-box k-swot-w"><div class="font-bold text-xs text-red-700 mb-2">KELEMAHAN (W)</div><textarea id="k-input_w" class="w-full bg-transparent border-none text-sm resize-none focus:ring-0" rows="4"></textarea></div>
                            <div class="k-swot-box k-swot-o"><div class="font-bold text-xs text-blue-700 mb-2">PELUANG (O)</div><textarea id="k-input_o" class="w-full bg-transparent border-none text-sm resize-none focus:ring-0" rows="4"></textarea></div>
                            <div class="k-swot-box k-swot-c"><div class="font-bold text-xs text-yellow-700 mb-2">ANCAMAN (T)</div><textarea id="k-input_c" class="w-full bg-transparent border-none text-sm resize-none focus:ring-0" rows="4"></textarea></div>
                        </div>
                    </div>

                    <!-- Fasa 2 -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5 overflow-hidden">
                        <div class="flex justify-between mb-4">
                            <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider">Fasa 2: Matriks Intervensi</h4>
                            <button onclick="window.kurikulumApp.addPintasRow()" class="text-xs font-bold bg-emerald-500 text-white px-3 py-1 rounded shadow hover:bg-emerald-600">+ Inisiatif</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="k-pintas-table min-w-[1800px]">
                                <thead>
                                    <tr>
                                        <th class="w-10">No</th><th class="w-48">1. Bidang Fokus</th><th class="w-48">2. Data Dikumpul</th><th class="w-48">3. TOV</th><th class="w-48">4. KPI / ETR</th><th class="w-64 bg-indigo-900 border-indigo-700 text-yellow-300 shadow-inner">5. Inisiatif (Program)</th><th class="w-48">6. Tanggungjawab</th><th class="w-32">7. Tempoh</th><th class="w-32">8. Sumber</th><th class="w-32">9. Evidens</th><th class="w-32">10. Penilaian</th><th class="w-24">11. Kos</th><th class="w-10"></th>
                                    </tr>
                                </thead>
                                <tbody id="k-interventionTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- SHARED MODALS -->
<!-- Edit Node Modal for Kurikulam -->
<div id="k-nodeModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-[200] backdrop-blur-sm">
    <div class="bg-white rounded-xl shadow-2xl w-80 p-6">
        <h3 class="text-lg font-bold text-slate-800 mb-4">Edit Posisi</h3>
        <input type="hidden" id="k-nodeId">
        <div class="space-y-3">
            <input type="text" id="k-nodeRole" placeholder="Jawatan" class="w-full border border-gray-300 rounded p-2 text-sm font-bold">
            <input type="text" id="k-nodeName" placeholder="Nama Guru" class="w-full border border-gray-300 rounded p-2 text-sm">
            <select id="k-nodeColor" class="w-full border border-gray-300 rounded p-2 text-sm">
                <option value="role-default">Kelabu (Umum)</option><option value="role-pengetua">Kuning (Pengetua)</option><option value="role-pk">Biru (Penolong Kanan)</option><option value="role-gkmp">Hijau (GKMP)</option><option value="role-kp">Merah Jambu (KP)</option>
            </select>
        </div>
        <div class="mt-4 flex gap-2">
            <button onclick="window.kurikulumApp.saveNodeEdit()" class="flex-1 bg-indigo-600 text-white font-bold py-2 rounded text-sm">Simpan</button>
            <button onclick="window.kurikulumApp.closeModal()" class="flex-1 bg-gray-100 text-gray-500 font-bold py-2 rounded text-sm">Batal</button>
        </div>
        <div class="mt-2 pt-2 border-t flex justify-between">
            <button onclick="window.kurikulumApp.addChildNode()" class="text-xs font-bold text-green-600">+ Anak</button>
            <button onclick="window.kurikulumApp.deleteNode()" class="text-xs font-bold text-red-600">Padam</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- SHARED CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyDvGANnXKmwWlpRT3Wlfsm-WBOEIC62SWU",
        authDomain: "strategic2026.firebaseapp.com",
        projectId: "strategic2026",
        storageBucket: "strategic2026.firebasestorage.app",
        messagingSenderId: "642605714672",
        appId: "1:642605714672:web:5dcdfbf351c36ca6084635"
    };
    const APP_ID = 'strategic2026';

    // --- GLOBAL STATE ---
    let app, db, auth;
    
    // =========================================================================
    // MODULE A LOGIC: KURIKULUM (Namespaced under window.kurikulumApp)
    // =========================================================================
    const K_PATH_KURIKULUM = `artifacts/${APP_ID}/public/data/kurikulum_editor/kurikulum_live_v1`;
    const K_PATH_PINTAS = `artifacts/${APP_ID}/public/data/pintas/main_plan`;
    
    const K_DEFAULT_DATA = {
        chart: [{id:'root',parent:null,role:'PENGETUA',name:'NAMA PENGETUA',color:'role-pengetua'},{id:'pk1',parent:'root',role:'PK PENTADBIRAN',name:'NAMA PK1',color:'role-pk'},{id:'gkmp1',parent:'pk1',role:'GKMP BAHASA',name:'NAMA GKMP',color:'role-gkmp'},{id:'kp1',parent:'gkmp1',role:'KP BM',name:'NAMA KP',color:'role-kp'}],
        tables: [{id:'t1',title:'Senarai KP 2025',headers:['Bil','Panitia','Nama'],rows:[['1','BM','Ali']]}]
    };
    const K_DEFAULT_PINTAS = {
        "KRA1": { id:"KRA1", title:"KRA 1: Pemimpin", swot: { s:"", w:"", o:"", c:"" }, interventions: [{fokus:"Kepimpinan",data:"SKPMg2",tov:"88%",etr:"95%",inisiatif:"BENGKEL COACHING",tanggungjawab:"Pengetua",tempoh:"Jan",sumber:"RM100",evidens:"Laporan",penilaian:"",kos:""}] },
        "KRA2": { id:"KRA2", title:"KRA 2: Guru", swot:{s:"",w:"",o:"",c:""}, interventions:[] },
        "KRA3": { id:"KRA3", title:"KRA 3: Murid", swot:{s:"",w:"",o:"",c:""}, interventions:[] },
        "KRA4": { id:"KRA4", title:"KRA 4: PIBG", swot:{s:"",w:"",o:"",c:""}, interventions:[] }
    };

    let kData = JSON.parse(JSON.stringify(K_DEFAULT_DATA));
    let kPintasData = JSON.parse(JSON.stringify(K_DEFAULT_PINTAS));
    let kActiveTableIndex = 0;
    let kActiveKra = "KRA1";
    let kCurrentNodeId = null;

    const kurikulumApp = {
        init: async () => {
            await kurikulumApp.loadData();
            kurikulumApp.renderAll();
        },
        loadData: async () => {
            try {
                const kSnap = await getDoc(doc(db, K_PATH_KURIKULUM));
                if (kSnap.exists()) {
                    let d = kSnap.data();
                    if(d.tables) d.tables.forEach(t => { try{ if(typeof t.rows==='string') t.rows=JSON.parse(t.rows) }catch{} });
                    kData = { ...K_DEFAULT_DATA, ...d };
                }
                const pSnap = await getDoc(doc(db, K_PATH_PINTAS));
                if (pSnap.exists()) kPintasData = { ...K_DEFAULT_PINTAS, ...pSnap.data() };
            } catch (e) { console.warn("Kurikulam Load Error (using default):", e); }
        },
        saveAllData: async () => {
            const btn = document.getElementById('k-saveBtn'); const oldText = btn.innerHTML; btn.textContent = 'Saving...';
            if(!document.getElementById('k-view-pintas').classList.contains('hidden')) kurikulumApp.savePintasInputs();
            try {
                const kClean = JSON.parse(JSON.stringify(kData));
                kClean.tables.forEach(t => { if(t.rows) t.rows = JSON.stringify(t.rows); });
                await setDoc(doc(db, K_PATH_KURIKULUM), kClean);
                await setDoc(doc(db, K_PATH_PINTAS), kPintasData);
                btn.textContent = 'Saved!'; setTimeout(() => btn.innerHTML = oldText, 2000);
            } catch (e) { alert("Gagal menyimpan!"); btn.innerHTML = oldText; }
        },
        switchView: (v) => {
             if(!document.getElementById('k-view-pintas').classList.contains('hidden')) kurikulumApp.savePintasInputs();
             ['carta','tables','pintas'].forEach(x => { 
                 document.getElementById('k-view-'+x).classList.add('hidden'); 
                 document.getElementById('k-nav-'+x).className = "w-full flex items-center px-3 py-3 text-sm font-medium rounded-lg text-slate-600 hover:bg-slate-50 transition-colors";
             });
             document.getElementById('k-view-'+v).classList.remove('hidden'); 
             document.getElementById('k-nav-'+v).className = "w-full flex items-center px-3 py-3 text-sm font-bold rounded-lg text-indigo-700 bg-indigo-50 transition-colors";
             if(v==='pintas') kurikulumApp.renderPintas();
        },
        // Chart Logic
        setChartOrientation: (m) => { document.getElementById('chartContainerWrapper').className = `org-container layout-${m}`; },
        renderAll: () => { kurikulumApp.renderChart(); kurikulumApp.renderTables(); kurikulumApp.renderPintas(); },
        renderChart: () => {
            const container = document.getElementById('chartCanvas'); container.innerHTML = '';
            const map = {}; kData.chart.forEach(n => map[n.id] = {...n, children:[]});
            let root = null;
            kData.chart.forEach(n => { if(n.parent === null) root = map[n.id]; else if(map[n.parent]) map[n.parent].children.push(map[n.id]); });
            if(root) container.appendChild(kurikulumApp.createNode(root));
        },
        createNode: (node) => {
            const wrap = document.createElement('div'); wrap.className = 'node-wrapper';
            const card = document.createElement('div'); card.className = `node-card ${node.color || 'role-default'}`;
            card.innerHTML = `<div class="node-role">${node.role}</div><div class="node-name">${node.name}</div>`;
            card.onclick = (e) => { e.stopPropagation(); kurikulumApp.openModal(node.id); };
            wrap.appendChild(card);
            if(node.children.length > 0) {
                const kids = document.createElement('div'); kids.className = 'children-container';
                node.children.forEach(c => kids.appendChild(kurikulumApp.createNode(c)));
                wrap.appendChild(kids);
            }
            return wrap;
        },
        openModal: (id) => { 
            kCurrentNodeId=id; const n=kData.chart.find(x=>x.id===id); 
            if(n){
                document.getElementById('k-nodeRole').value=n.role;
                document.getElementById('k-nodeName').value=n.name;
                document.getElementById('k-nodeColor').value=n.color;
                document.getElementById('k-nodeModal').classList.remove('hidden');
            }
        },
        closeModal: () => document.getElementById('k-nodeModal').classList.add('hidden'),
        saveNodeEdit: () => { 
            const n=kData.chart.find(x=>x.id===kCurrentNodeId); 
            if(n){
                n.role=document.getElementById('k-nodeRole').value;
                n.name=document.getElementById('k-nodeName').value;
                n.color=document.getElementById('k-nodeColor').value;
                kurikulumApp.renderChart(); kurikulumApp.closeModal(); kurikulumApp.saveAllData();
            }
        },
        addChildNode: () => { kData.chart.push({id:'n'+Date.now(),parent:kCurrentNodeId,role:'Jawatan',name:'Nama',color:'role-default'}); kurikulumApp.renderChart(); kurikulumApp.closeModal(); kurikulumApp.saveAllData(); },
        deleteNode: () => { if(confirm("Padam nod ini?")){ kData.chart=kData.chart.filter(n=>n.id!==kCurrentNodeId && n.parent!==kCurrentNodeId); kurikulumApp.renderChart(); kurikulumApp.closeModal(); kurikulumApp.saveAllData(); } },
        
        // Table Logic
        renderTables: () => {
            const tabs = document.getElementById('k-tableTabs'); const container = document.getElementById('k-activeTableContainer');
            tabs.innerHTML = ''; container.innerHTML = '';
            if(!kData.tables.length) { container.innerHTML = 'Tiada data'; return; }
            if(kActiveTableIndex >= kData.tables.length) kActiveTableIndex = 0;

            kData.tables.forEach((t, i) => {
                const b = document.createElement('button');
                b.className = `px-4 py-2 rounded-lg text-sm font-bold whitespace-nowrap ${i===kActiveTableIndex ? 'bg-indigo-600 text-white shadow' : 'bg-white border text-slate-600'}`;
                b.textContent = t.title;
                b.onclick = () => { kActiveTableIndex = i; kurikulumApp.renderTables(); };
                tabs.appendChild(b);
            });
            const t = kData.tables[kActiveTableIndex];
            let h = `<div class="mb-6 flex gap-4"><input class="text-xl font-bold bg-transparent border-b border-dashed w-1/2 py-1" value="${t.title}" onchange="window.kurikulumApp.updateTableTitle(this.value)"><button onclick="window.kurikulumApp.addColumn()" class="text-xs bg-blue-50 text-blue-700 px-3 py-1 rounded border border-blue-200">+ Lajur</button></div>`;
            h += `<div class="overflow-x-auto rounded-lg border border-slate-200 shadow-sm mb-4"><table class="k-data-table"><thead><tr>`;
            t.headers.forEach((hdr, i) => { h += `<th><div class="flex gap-1"><input value="${hdr}" onchange="window.kurikulumApp.updateHeader(${i},this.value)" class="font-bold"><button onclick="window.kurikulumApp.deleteColumn(${i})" class="k-action-btn">Ã—</button></div></th>`; });
            h += `<th class="w-10"></th></tr></thead><tbody>`;
            if(t.rows) t.rows.forEach((row, ri) => {
                h += `<tr>`; row.forEach((cell, ci) => h += `<td><input value="${cell}" onchange="window.kurikulumApp.updateCell(${ri},${ci},this.value)"></td>`);
                h += `<td class="text-center bg-gray-50"><button class="k-action-btn" onclick="window.kurikulumApp.delRow(${ri})">Ã—</button></td></tr>`;
            });
            h += `</tbody></table></div><div class="text-center"><button class="bg-slate-100 text-slate-600 px-6 py-2 rounded-lg text-sm font-bold border" onclick="window.kurikulumApp.addRow()">+ Tambah Baris</button></div>`;
            container.innerHTML = h;
        },
        addNewTable: () => { const n=prompt("Nama Senarai:"); if(n){kData.tables.push({id:Date.now(),title:n,headers:['Bil','Lajur 2'],rows:[['1','-']]}); kActiveTableIndex=kData.tables.length-1; kurikulumApp.renderTables(); kurikulumApp.saveAllData();} },
        deleteActiveTable: () => { if(kData.tables.length<=1)return alert("Minimum 1 senarai."); if(confirm("Hapus?")){kData.tables.splice(kActiveTableIndex,1);kActiveTableIndex=0;kurikulumApp.renderTables();kurikulumApp.saveAllData();} },
        updateTableTitle: (v) => { kData.tables[kActiveTableIndex].title = v; kurikulumApp.saveAllData(); },
        updateHeader: (i,v) => { kData.tables[kActiveTableIndex].headers[i]=v; kurikulumApp.saveAllData(); },
        updateCell: (r,c,v) => { kData.tables[kActiveTableIndex].rows[r][c]=v; kurikulumApp.saveAllData(); },
        addRow: () => { const t = kData.tables[kActiveTableIndex]; if(!t.rows) t.rows=[]; const r=new Array(t.headers.length).fill('-'); r[0]=t.rows.length+1; t.rows.push(r); kurikulumApp.renderTables(); kurikulumApp.saveAllData(); },
        delRow: (i) => { const t = kData.tables[kActiveTableIndex]; t.rows.splice(i,1); kurikulumApp.renderTables(); kurikulumApp.saveAllData(); },
        addColumn: () => { const t = kData.tables[kActiveTableIndex]; t.headers.push("Lajur "+(t.headers.length+1)); if(t.rows)t.rows.forEach(r=>r.push("-")); kurikulumApp.renderTables(); kurikulumApp.saveAllData(); },
        deleteColumn: (i) => { const t = kData.tables[kActiveTableIndex]; if(confirm("Hapus lajur?")){t.headers.splice(i,1); if(t.rows)t.rows.forEach(r=>r.splice(i,1)); kurikulumApp.renderTables(); kurikulumApp.saveAllData();} },

        // Pintas Logic
        renderPintas: () => {
            const tabs = document.getElementById('k-kraTabs'); tabs.innerHTML = '';
            Object.keys(kPintasData).forEach(key => {
                const b = document.createElement('button'); b.className = `px-6 py-3 text-sm font-medium whitespace-nowrap ${key===kActiveKra ? 'k-tab-active' : 'k-tab-inactive'}`;
                b.textContent = kPintasData[key].title; b.onclick = () => { kurikulumApp.savePintasInputs(); kActiveKra = key; kurikulumApp.renderPintas(); };
                tabs.appendChild(b);
            });
            const d = kPintasData[kActiveKra];
            document.getElementById('k-input_s').value = d.swot.s; document.getElementById('k-input_w').value = d.swot.w;
            document.getElementById('k-input_o').value = d.swot.o; document.getElementById('k-input_c').value = d.swot.c;
            const tbody = document.getElementById('k-interventionTableBody'); tbody.innerHTML = '';
            if(d.interventions) d.interventions.forEach((row, i) => {
                const tr = document.createElement('tr'); const fields = ['fokus','data','tov','etr','inisiatif','tanggungjawab','tempoh','sumber','evidens','penilaian','kos'];
                let h = `<td class="text-center text-xs font-bold text-slate-400 pt-2">${i+1}</td>`;
                fields.forEach(f => { const cls = f==='inisiatif' ? 'k-col-initiative' : ''; h += `<td><textarea data-f="${f}" class="${cls}" onchange="window.kurikulumApp.savePintasInputs()">${row[f]||''}</textarea></td>`; });
                h += `<td class="text-center"><button class="k-action-btn" onclick="window.kurikulumApp.delPintasRow(${i})">Ã—</button></td>`;
                tr.innerHTML = h; tbody.appendChild(tr);
            });
        },
        savePintasInputs: () => {
            if(!kActiveKra || !kPintasData[kActiveKra]) return;
            const d = kPintasData[kActiveKra];
            d.swot.s = document.getElementById('k-input_s').value; d.swot.w = document.getElementById('k-input_w').value;
            d.swot.o = document.getElementById('k-input_o').value; d.swot.c = document.getElementById('k-input_c').value;
            const rows = Array.from(document.querySelectorAll('#k-interventionTableBody tr'));
            d.interventions = rows.map(tr => { const obj = {}; tr.querySelectorAll('textarea').forEach(ta => obj[ta.getAttribute('data-f')] = ta.value); return obj; });
        },
        addPintasRow: () => { kurikulumApp.savePintasInputs(); kPintasData[kActiveKra].interventions.push({}); kurikulumApp.renderPintas(); },
        delPintasRow: (i) => { if(confirm("Padam inisiatif ini?")){ kurikulumApp.savePintasInputs(); kPintasData[kActiveKra].interventions.splice(i,1); kurikulumApp.renderPintas(); } }
    };

    // --- MAIN INITIALIZATION ---
    window.initApp = async () => {
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            await signInAnonymously(auth);
            
            // Remove Loader
            document.getElementById('globalLoadingOverlay').style.display = 'none';
            document.getElementById('globalConnectionStatus').innerHTML = `<span class="w-2 h-2 mr-1 bg-green-500 rounded-full"></span> Online`;

            // Expose sub-apps to window so HTML handlers work
            window.kurikulumApp = kurikulumApp;
            
            // Init Sub-Modules
            kurikulumApp.init();

        } catch (error) {
            console.error("App Init Error:", error);
            document.getElementById('globalConnectionStatus').innerHTML = `<span class="w-2 h-2 mr-1 bg-red-500 rounded-full"></span> Error`;
            document.getElementById('globalLoadingOverlay').innerHTML = `<p class="text-red-600 font-bold">Ralat Sambungan. Sila muat semula.</p>`;
        }
    };

    // Start
    window.initApp();

</script>
</body>
</html>


