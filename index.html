<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pelan Operasi Editor - SMK Seri Pulai Perdana</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        /* Ensures table is wide enough for content, enabling horizontal scroll on mobile */
        .table-auto-layout {
            width: 1200px; 
            table-layout: fixed;
            border-collapse: collapse;
        }
        .table-auto-layout th, .table-auto-layout td {
            padding: 8px 12px;
            text-align: left;
            border: 1px solid #e5e7eb;
            font-size: 0.875rem;
            vertical-align: top;
        }
        
        #prosesPelaksanaanTable th, #pelanTaktikalTable th {
            text-align: center;
            white-space: normal; 
            line-height: 1.2;
            padding-top: 10px;
            padding-bottom: 10px;
        }
        #pelanTaktikalTable textarea {
            min-height: 60px; /* Ensure sufficient space for multiline text */
        }
        
        /* Ensure responsive table container for desktop/mobile */
        .overflow-x-auto {
            overflow-x: auto;
        }
    </style>
</head>
<body>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="fixed inset-0 bg-gray-50 flex items-center justify-center z-50">
    <div class="text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500 mx-auto"></div>
        <p class="mt-4 text-indigo-700 font-semibold">Memulakan Aplikasi...</p>
    </div>
</div>

<div id="app" class="min-h-screen p-4 sm:p-8 max-w-7xl mx-auto hidden">

    <!-- Header Section (Fixed Titles) -->
    <header class="text-center mb-8">
        <h1 class="text-4xl font-extrabold text-indigo-900 mb-2 tracking-tight">
            SMK Seri Pulai Perdana
        </h1>
        <h2 id="pageMainTitle" class="text-2xl font-bold text-gray-800">
            Pelan Strategik Mata Pelajaran
        </h2>
        <p id="headerSubtitle" class="text-sm text-gray-500 mt-1">Sila pilih subjek atau cipta subjek baharu untuk memulakan pengeditan.</p>
    </header>

    <!-- Subject Management Section (Only visible in Subject Editing Mode) -->
    <div id="subjectManagementSection" class="bg-white p-6 rounded-xl shadow-lg max-w-lg mx-auto mb-8 space-y-4">
        
        <!-- 1. Existing Subject Selector -->
        <div>
            <label for="subjectSelector" class="block text-lg font-medium text-gray-700 mb-2">1. Pilih Mata Pelajaran (Subjek) untuk Diedit:</label>
            <select id="subjectSelector" class="w-full p-3 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-white">
                <!-- Options populated by JavaScript -->
            </select>
            <p id="subjectListMessage" class="text-xs text-gray-500 mt-1 hidden">Memuatkan senarai subjek...</p>
        </div>

        <!-- 2. Add New Subject -->
        <div class="border-t pt-4">
            <label for="newSubjectInput" class="block text-lg font-medium text-gray-700 mb-2">2. Tambah Subjek Baharu:</label>
            <div class="flex space-x-2">
                <input type="text" id="newSubjectInput" placeholder="Contoh: Kimia" class="flex-grow p-3 border border-green-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150">
                <button id="addNewSubjectButton" class="bg-green-600 text-white font-semibold px-4 py-3 rounded-lg hover:bg-green-700 transition duration-200">
                    Tambah
                </button>
            </div>
            <div id="newSubjectMessageBox" class="mt-3 p-2 text-center rounded-lg hidden text-sm"></div>
        </div>
    </div>
    
    <!-- MASTER TEMPLATE ADMIN LOGIN GATE (Hidden by default, shown when footer link is clicked) -->
    <div id="templateAdminGate" class="bg-yellow-50 p-6 rounded-xl shadow-lg max-w-lg mx-auto mb-8 space-y-4 hidden">
        <h3 class="text-xl font-bold text-yellow-800">Templat Induk: Sila Sahkan</h3>
        <p class="text-sm text-yellow-700">Mod ini membolehkan anda mengedit templat asas untuk subjek baharu.</p>
        <div class="flex space-x-2">
            <input type="password" id="templateAdminKeyInput" placeholder="Masukkan Kunci Pentadbir" class="flex-grow p-3 border border-yellow-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 transition duration-150">
            <button id="templateAdminLoginButton" class="bg-yellow-600 text-white font-semibold px-4 py-3 rounded-lg hover:bg-yellow-700 transition duration-200">
                Buka Kunci
            </button>
        </div>
        <div id="templateAdminMessage" class="mt-3 p-2 text-center rounded-lg hidden text-sm"></div>
    </div>


    <!-- Main Content Container (Used for both Subject Editing and Template Editing) -->
    <div id="planEditorContainer" class="bg-white p-6 rounded-xl shadow-2xl hidden">
        <div id="messageBox" class="p-3 text-center rounded-lg hidden mb-4" role="alert"></div>
        
        <!-- Switch Subject Button -->
        <div class="flex justify-start mb-4">
            <button id="switchSubjectButton" class="text-sm text-indigo-500 hover:text-indigo-700 font-medium py-1 px-3 rounded-lg border border-indigo-200 hover:bg-indigo-50 transition duration-150 flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                Tukar Subjek
            </button>
        </div>

        <!-- Section 0.2: Analisis Quantum SMART (NEW SECTION) -->
        <h3 class="text-xl font-semibold text-teal-600 mb-4 border-b pb-2">Analisis Quantum SMART (Prinsip Teras)</h3>
        <div class="overflow-x-auto mb-8 p-4 border border-teal-200 rounded-lg bg-teal-50">
            <table class="table-auto-layout border-collapse border border-gray-200" style="width: 1000px;">
                <tbody>
                    <tr>
                        <th class="w-1/5 bg-teal-100 font-medium">Quantum SMART Principle</th>
                        <td colspan="3"><textarea id="smartPrinciple" rows="3" class="w-full focus:outline-none resize-none" placeholder="Terangkan bagaimana setiap program taktik memenuhi prinsip SMART. Contoh: Semua KPI (Measurable) mestilah boleh dicapai (Achievable) dalam tempoh (Time-bound) yang ditetapkan."></textarea></td>
                    </tr>
                    <tr>
                        <th class="w-1/5 bg-teal-100 font-medium">Entanglement Measurement</th>
                        <td colspan="3"><textarea id="entanglementMeasure" rows="3" class="w-full focus:outline-none resize-none" placeholder="Terangkan metrik utama yang mengukur kejayaan holistik program ini. Contoh: Peningkatan 15% Gred A merentasi semua tingkatan dalam tempoh 6 bulan, diukur melalui ujian PBD dan Peperiksaan Pertengahan Tahun."></textarea></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Section 0.5: Strategic Goals Table -->
        <h3 class="text-xl font-semibold text-red-600 mb-4 border-b pb-2">Matlamat & Strategi</h3>
        <div class="overflow-x-auto mb-8">
            <table class="table-auto-layout border-collapse border border-gray-200" style="width: 1000px;">
                <tbody>
                    <tr>
                        <th class="w-1/5 bg-red-100 font-medium">MATLAMAT STRATEGIK</th>
                        <td colspan="3"><textarea id="matlamatStrategik" rows="2" class="w-full focus:outline-none resize-none"></textarea></td>
                    </tr>
                    <tr>
                        <th class="w-1/5 bg-red-100 font-medium">STRATEGI</th>
                        <td colspan="3"><textarea id="strategiList" rows="3" class="w-full focus:outline-none resize-none"></textarea></td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Section 0.7: Pelan Taktikal (Senarai Program) - NEW COMPREHENSIVE TABLE -->
        <h3 class="text-xl font-semibold text-purple-600 mb-4 border-b pb-2">Pelan Taktikal (Senarai Program)</h3>
        <div class="overflow-x-auto mb-8">
            <table class="table-auto-layout border-collapse border border-gray-200" id="pelanTaktikalTable" style="width: 1800px;">
                <thead>
                    <tr class="bg-purple-50 text-gray-600 uppercase text-xs">
                        <th style="width: 30px;" class="text-center">Bil</th>
                        <th style="width: 150px;">Nama Program</th>
                        <th style="width: 250px;">Aktiviti</th>
                        <th style="width: 150px;">Tanggungjawab</th>
                        <th style="width: 100px;">Tempoh / Hari / Kekerapan</th>
                        <th style="width: 80px;">Kos / Sumber</th>
                        <th style="width: 150px;">Sasaran</th>
                        <th style="width: 200px;">Output / Outcome / Benefit</th>
                        <th style="width: 200px;">Pelan Kontengensi</th>
                        <th style="width: 50px;" class="text-center">Padam</th>
                    </tr>
                </thead>
                <tbody id="pelanTaktikalTableBody">
                    <!-- Dynamic Taktikal Program Rows -->
                </tbody>
            </table>
            <button id="addTaktikalProgramButton" class="bg-purple-500 text-white px-3 py-1 mt-2 text-sm rounded-lg hover:bg-purple-600 transition duration-150 flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                Tambah Program Taktikal
            </button>
        </div>


        <!-- Section 1: Butiran Program (Static Header Info - Now less relevant due to tactical table) -->
        <h3 class="text-xl font-semibold text-indigo-600 mb-4 border-b pb-2">Butiran Program (Untuk Pelan Am)</h3>
        <div class="overflow-x-auto mb-8">
            <table class="table-auto-layout border-collapse border border-gray-200" style="width: 1000px;">
                <tbody>
                    <tr>
                        <th class="w-1/5 bg-gray-100 font-medium">Nama Program</th>
                        <td colspan="3"><input type="text" id="programName" class="w-full focus:outline-none" value=""></td>
                    </tr>
                    <tr>
                        <th class="w-1/5 bg-gray-100 font-medium">Objektif Program</th>
                        <td colspan="3"><textarea id="objektifProgram" rows="3" class="w-full focus:outline-none resize-none"></textarea></td>
                    </tr>
                    <tr>
                        <th class="w-1/5 bg-gray-100 font-medium">Aktiviti Program</th>
                        <td colspan="3"><textarea id="aktivitiProgram" rows="5" class="w-full focus:outline-none resize-none"></textarea></td>
                    </tr>
                    <tr>
                        <th class="w-1/5 bg-gray-100 font-medium">Penyelaras Program</th>
                        <td class="w-2/5"><input type="text" id="penyelarasProgram" class="w-full focus:outline-none" value=""></td>
                        <th class="w-1/5 bg-gray-100 font-medium">Tarikh Mula - Akhir</th>
                        <td class="w-1/5"><input type="text" id="tarikhMulaAkhir" class="w-full focus:outline-none" value=""></td>
                    </tr>
                    <tr>
                        <th class="w-1/5 bg-gray-100 font-medium">Penyelaras Aktiviti</th>
                        <td><input type="text" id="penyelarasAktiviti" class="w-full focus:outline-none" value=""></td>
                        <th class="w-1/5 bg-gray-100 font-medium">Tempat</th>
                        <td><input type="text" id="tempat" class="w-full focus:outline-none" value=""></td>
                    </tr>
                    <tr>
                        <th class="w-1/5 bg-gray-100 font-medium">Sasaran</th>
                        <td><input type="text" id="sasaran" class="w-full focus:outline-none" value=""></td>
                        <th class="w-1/5 bg-gray-100 font-medium">Kos dan Sumber</th>
                        <td><input type="text" id="kosSumber" class="w-full focus:outline-none" value=""></td>
                    </tr>
                    <tr>
                        <th class="w-1/5 bg-gray-100 font-medium">Jawatankuasa</th>
                        <td colspan="3"><input type="text" id="jawatankuasa" class="w-full focus:outline-none" value=""></td>
                    </tr>
                    <tr>
                        <th class="w-1/5 bg-gray-100 font-medium">Ringkasan Program</th>
                        <td colspan="3"><textarea id="ringkasanProgram" rows="4" class="w-full focus:outline-none resize-none"></textarea></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Section 2: Proses Pelaksanaan Table (Proses Kerja) -->
        <h3 class="text-xl font-semibold text-indigo-600 mb-4 border-b pb-2">Proses Pelaksanaan (Langkah-langkah)</h3>
        
        <div class="overflow-x-auto mb-4">
            <table class="table-auto-layout border-collapse border border-gray-200" id="prosesPelaksanaanTable" style="width: 1200px;">
                <thead>
                    <tr class="bg-gray-100 text-gray-600 uppercase text-xs">
                        <th style="width: 50px;">Langkah</th>
                        <th style="width: 250px;">Proses Kerja</th>
                        <th style="width: 150px;">Tanggungjawab</th> 
                        <th style="width: 150px;">Tarikh Mula-Akhir</th> 
                        <th style="width: 150px;">KPI</th>
                        <th style="width: 150px;">Sasaran</th>
                        <th style="width: 120px;">Status</th> 
                        <th style="width: 80px;">Tindakan</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Dynamic rows will be inserted here -->
                </tbody>
            </table>
        </div>
        
        <!-- Table Action Buttons -->
        <div class="flex justify-between items-center mb-6">
            <button id="addRowButton" class="bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 transition duration-150 flex items-center">
                <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                Tambah Langkah
            </button>
        </div>

        <!-- Save Button -->
        <div class="border-t pt-4">
            <button id="saveButton" class="w-full bg-green-600 text-white font-semibold py-3 rounded-lg hover:bg-green-700 transition duration-200 shadow-md">
                Simpan Pelan Operasi
            </button>
        </div>
    </div>
</div>

<!-- Subtle Footer Link for Admin Mode -->
<footer class="p-4 text-center">
    <button id="adminFooterToggle" class="text-xs text-gray-400 hover:text-indigo-600 transition duration-150 cursor-pointer">
        Mod Pentadbir
    </button>
</footer>

<!-- Firebase SDKs -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    setLogLevel('debug');

    // --- Core Configuration and Paths ---
    const appId = 'default-strategic-plan-app'; 
    const ADMIN_SECRET_KEY = "admin2025";
    
    // --- FIREBASE CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyBgvyb95-jujtCC2HPiHXLdYMJgQquIEx4",
        authDomain: "jadual-3f0aa.firebaseapp.com",
        projectId: "jadual-3f0aa",
        storageBucket: "jadual-3f0aa.firebasestorage.app",
        messagingSenderId: "496526436851",
        appId: "1:496526436851:web:78ff48b28bfc8c31f14a86"
    };
    
    const SUBJECTS_DOC_PATH = `artifacts/${appId}/public/data/subject_config/subject_list`;
    const PLAN_COLLECTION_BASE = `artifacts/${appId}/public/data/pelan_strategik`; 
    const MASTER_TEMPLATE_PATH = `${PLAN_COLLECTION_BASE}/master_template`; 


    // --- GLOBAL STATE ---
    let app, db, auth;
    let userId = null;
    let isAuthReady = false;
    let currentSubject = null; 
    let isAdminMode = false; 
    let masterTemplateCache = {};


    // --- DOM ELEMENTS (Defined for brevity) ---
    const loadingOverlay = document.getElementById('loadingOverlay');
    const mainApp = document.getElementById('app');
    const messageBox = document.getElementById('messageBox');
    const saveButton = document.getElementById('saveButton');
    const addRowButton = document.getElementById('addRowButton');
    const tableBody = document.getElementById('tableBody');
    const subjectSelector = document.getElementById('subjectSelector');
    const planEditorContainer = document.getElementById('planEditorContainer');
    const pageMainTitle = document.getElementById('pageMainTitle');
    const newSubjectInput = document.getElementById('newSubjectInput');
    const addNewSubjectButton = document.getElementById('addNewSubjectButton');
    const newSubjectMessageBox = document.getElementById('newSubjectMessageBox');
    const subjectListMessage = document.getElementById('subjectListMessage');
    const adminFooterToggle = document.getElementById('adminFooterToggle');
    const subjectManagementSection = document.getElementById('subjectManagementSection');
    const templateAdminGate = document.getElementById('templateAdminGate');
    const templateAdminKeyInput = document.getElementById('templateAdminKeyInput');
    const templateAdminLoginButton = document.getElementById('templateAdminLoginButton');
    const templateAdminMessage = document.getElementById('templateAdminMessage');
    const headerSubtitle = document.getElementById('headerSubtitle');
    const switchSubjectButton = document.getElementById('switchSubjectButton');
    const matlamatStrategik = document.getElementById('matlamatStrategik');
    const strategiList = document.getElementById('strategiList');
    const pelanTaktikalTableBody = document.getElementById('pelanTaktikalTableBody');
    const addTaktikalProgramButton = document.getElementById('addTaktikalProgramButton');
    const smartPrinciple = document.getElementById('smartPrinciple');
    const entanglementMeasure = document.getElementById('entanglementMeasure');

    let programCounter = 0;


    // --- UTILITIES ---

    function showMessage(message, type = 'success', target = messageBox) {
        target.textContent = message;
        target.className = `p-3 text-center rounded-lg ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} mb-4`;
        target.classList.remove('hidden');
        setTimeout(() => { target.classList.add('hidden'); }, 5000);
    }
    
    const textToArray = (text) => text.split('\n').map(item => item.trim()).filter(item => item.length > 0);
    const arrayToText = (array) => Array.isArray(array) ? array.join('\n') : '';
    
    function ensureUIVisible() {
        loadingOverlay.classList.add('hidden');
        mainApp.classList.remove('hidden');
    }
    
    function getFormState() {
        return {
            smartPrinciple: smartPrinciple.value.trim(),
            entanglementMeasure: entanglementMeasure.value.trim(),
            matlamatStrategik: matlamatStrategik.value.trim(),
            strategiList: textToArray(strategiList.value),
            pelanTaktikal: collectPelanTaktikalData(),
            
            programName: document.getElementById('programName').value.trim(),
            objektifProgram: document.getElementById('objektifProgram').value.trim(),
            aktivitiProgram: textToArray(document.getElementById('aktivitiProgram').value),
            penyelarasProgram: document.getElementById('penyelarasProgram').value.trim(),
            tarikhMulaAkhir: document.getElementById('tarikhMulaAkhir').value.trim(),
            penyelarasAktiviti: document.getElementById('penyelarasAktiviti').value.trim(),
            tempat: document.getElementById('tempat').value.trim(),
            sasaran: document.getElementById('sasaran').value.trim(),
            kosSumber: document.getElementById('kosSumber').value.trim(),
            jawatankuasa: document.getElementById('jawatankuasa').value.trim(),
            ringkasanProgram: document.getElementById('ringkasanProgram').value.trim(),
            
            prosesPelaksanaan: collectTableData(),
            updatedAt: serverTimestamp(),
        };
    }
    
    function setFormState(data) {
        smartPrinciple.value = data.smartPrinciple || '';
        entanglementMeasure.value = data.entanglementMeasure || '';
        matlamatStrategik.value = data.matlamatStrategik || '';
        strategiList.value = arrayToText(data.strategiList) || '';
        
        document.getElementById('programName').value = data.programName || '';
        document.getElementById('objektifProgram').value = data.objektifProgram || '';
        document.getElementById('aktivitiProgram').value = arrayToText(data.aktivitiProgram) || '';
        document.getElementById('penyelarasProgram').value = data.penyelarasProgram || '';
        document.getElementById('tarikhMulaAkhir').value = data.tarikhMulaAkhir || '';
        document.getElementById('penyelarasAktiviti').value = data.penyelarasAktiviti || '';
        document.getElementById('tempat').value = data.tempat || '';
        document.getElementById('sasaran').value = data.sasaran || '';
        document.getElementById('kosSumber').value = data.kosSumber || '';
        document.getElementById('jawatankuasa').value = data.jawatankuasa || '';
        document.getElementById('ringkasanProgram').value = data.ringkasanProgram || '';

        // Pelan Taktikal
        pelanTaktikalTableBody.innerHTML = '';
        if (Array.isArray(data.pelanTaktikal) && data.pelanTaktikal.length > 0) {
            data.pelanTaktikal.forEach(row => createTaktikalProgramRow(row));
            updateTaktikalProgramRowNumbers();
        } else {
            createTaktikalProgramRow({});
            updateTaktikalProgramRowNumbers();
        }

        // Proses Pelaksanaan
        tableBody.innerHTML = '';
        if (Array.isArray(data.prosesPelaksanaan) && data.prosesPelaksanaan.length > 0) {
            data.prosesPelaksanaan.forEach(row => createTableRow(row));
            updateRowNumbers();
        } else {
            createTableRow({prosesKerja: ['']});
            updateRowNumbers();
        }
    }


    // --- TABLE MANAGEMENT FUNCTIONS ---
    
    function createTaktikalProgramRow(data = {}) {
        programCounter++;
        const row = pelanTaktikalTableBody.insertRow();
        row.dataset.id = `taktikal-program-${programCounter}`;
        row.className = 'hover:bg-gray-50';

        const rowData = {
            bil: pelanTaktikalTableBody.rows.length,
            namaProgram: data.namaProgram || '',
            aktiviti: arrayToText(data.aktiviti || ['Aktiviti 1']),
            tanggungJawab: data.tanggungJawab || '',
            tempoh: data.tempoh || '',
            kosSumber: data.kosSumber || '',
            sasaran: data.sasaran || '',
            outputOutcome: arrayToText(data.outputOutcome || ['Output/Outcome']),
            pelanKontengensi: arrayToText(data.pelanKontengensi || ['Pelan Kontengensi']),
            ...data
        };

        row.innerHTML = `
            <td class="text-center font-medium program-bil">${rowData.bil}</td>
            <td><textarea rows="3" class="w-full focus:outline-none resize-none" data-field="namaProgram">${rowData.namaProgram}</textarea></td>
            <td><textarea rows="3" class="w-full focus:outline-none resize-none" data-field="aktiviti">${rowData.aktiviti}</textarea></td>
            <td><input type="text" class="w-full focus:outline-none" data-field="tanggungJawab" value="${rowData.tanggungJawab}"></td>
            <td><input type="text" class="w-full focus:outline-none" data-field="tempoh" value="${rowData.tempoh}"></td>
            <td><input type="text" class="w-full focus:outline-none" data-field="kosSumber" value="${rowData.kosSumber}"></td>
            <td><input type="text" class="w-full focus:outline-none" data-field="sasaran" value="${rowData.sasaran}"></td>
            <td><textarea rows="3" class="w-full focus:outline-none resize-none" data-field="outputOutcome">${rowData.outputOutcome}</textarea></td>
            <td><textarea rows="3" class="w-full focus:outline-none resize-none" data-field="pelanKontengensi">${rowData.pelanKontengensi}</textarea></td>
            <td class="text-center">
                <button type="button" class="text-red-500 hover:text-red-700 delete-program-taktikal-btn" title="Hapus">
                    <svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3"></path></svg>
                </button>
            </td>
        `;

        row.querySelector('.delete-program-taktikal-btn').addEventListener('click', () => {
            row.remove();
            updateTaktikalProgramRowNumbers();
        });
    }

    function updateTaktikalProgramRowNumbers() {
        Array.from(pelanTaktikalTableBody.rows).forEach((row, index) => {
            row.cells[0].textContent = index + 1;
        });
    }

    function collectPelanTaktikalData() {
        const data = [];
        Array.from(pelanTaktikalTableBody.rows).forEach(row => {
            const rowData = {};
            Array.from(row.querySelectorAll('[data-field]')).forEach(input => {
                const fieldName = input.dataset.field;
                let value = input.value.trim();
                
                if (['aktiviti', 'outputOutcome', 'pelanKontengensi'].includes(fieldName)) {
                    value = textToArray(value);
                }
                rowData[fieldName] = value;
            });
            rowData.bil = parseInt(row.cells[0].textContent, 10);
            data.push(rowData);
        });
        return data;
    }
    
    function createTableRow(data = {}) {
        const langkah = tableBody.rows.length + 1;
        const row = tableBody.insertRow();
        row.dataset.index = langkah;
        row.className = 'hover:bg-gray-50';

        const rowData = {
            langkah: langkah,
            prosesKerja: arrayToText(data.prosesKerja || ["Proses 1", "Proses 2"]),
            tanggungJawab: data.tanggungJawab || '',
            tarikhMulaAkhir: data.tarikhMulaAkhir || '',
            kpi: data.kpi || '',
            sasaran: data.sasaran || '',
            status: data.status || 'Jelas',
            ...data
        };

        const statusOptions = ['Jelas', 'Belum Mula', 'Sedang Jalan', 'Selesai', 'Laporan disemak'];

        row.innerHTML = `
            <td class="text-center font-medium">${rowData.langkah}</td>
            <td><textarea rows="3" class="w-full focus:outline-none resize-none" data-field="prosesKerja">${rowData.prosesKerja}</textarea></td>
            <td><input type="text" class="w-full focus:outline-none" data-field="tanggungJawab" value="${rowData.tanggungJawab}"></td>
            <td><input type="text" class="w-full focus:outline-none" data-field="tarikhMulaAkhir" value="${rowData.tarikhMulaAkhir}"></td>
            <td><input type="text" class="w-full focus:outline-none" data-field="kpi" value="${rowData.kpi}"></td>
            <td><input type="text" class="w-full focus:outline-none" data-field="sasaran" value="${rowData.sasaran}"></td>
            <td>
                <select class="w-full p-1 border rounded" data-field="status">
                    ${statusOptions.map(opt => `<option value="${opt}" ${rowData.status === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                </select>
            </td>
            <td class="text-center">
                <button type="button" class="text-red-500 hover:text-red-700 delete-row-btn" title="Hapus">
                    <svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3"></path></svg>
                </button>
            </td>
        `;

        row.querySelector('.delete-row-btn').addEventListener('click', () => {
            row.remove();
            updateRowNumbers();
        });
    }

    function updateRowNumbers() {
        Array.from(tableBody.rows).forEach((row, index) => {
            const rowNumber = index + 1;
            row.cells[0].textContent = rowNumber;
            row.dataset.index = rowNumber;
        });
    }

    function collectTableData() {
        const data = [];
        Array.from(tableBody.rows).forEach(row => {
            const rowData = {};
            Array.from(row.querySelectorAll('[data-field]')).forEach(input => {
                const fieldName = input.dataset.field;
                let value = input.value.trim();
                
                if (fieldName === 'prosesKerja') {
                    value = textToArray(value);
                }
                rowData[fieldName] = value;
            });
            rowData.langkah = parseInt(row.dataset.index, 10);
            data.push(rowData);
        });
        return data;
    }


    // --- DEFAULT MASTER CONTENT (ENRICHED) ---
    const DEFAULT_MASTER_DATA = {
        smartPrinciple: 'Strategi ini memastikan setiap program taktik adalah benar-benar SMART: Spesifik kepada keperluan sebenar murid dan panitia, Measurable melalui data PBD, peperiksaan dan rekod kehadiran, Achievable berdasarkan kapasiti guru dan sumber sedia ada, Relevant kepada hala tuju sekolah dan panitia, serta Time bound dengan tempoh pelaksanaan dan semakan yang jelas (mingguan, bulanan dan suku tahun).',
        entanglementMeasure: 'Keberhasilan pelan diukur melalui gabungan indikator yang saling berkaitan: peningkatan sekurang-kurangnya 15% murid dalam kategori lulus dan cemerlang, pengurangan bilangan murid berprestasi sangat rendah, peningkatan penggunaan platform digital PdP oleh guru, peningkatan kadar penyertaan murid dalam program intervensi, serta maklum balas kualitatif yang positif daripada guru, murid dan ibu bapa.',
        matlamatStrategik: 'Melonjakkan kualiti PdP dan pencapaian akademik murid melalui program berfokus data, intervensi sistematik dan integrasi teknologi supaya sekurang-kurangnya 80% murid mencapai tahap penguasaan minimum dan berlaku peningkatan sekurang-kurangnya 15% dalam kategori cemerlang bagi mata pelajaran panitia.',
        strategiList: [
            'Melaksanakan PdP berteraskan PAK21, pembelajaran aktif dan kemahiran berfikir aras tinggi di semua kelas secara konsisten.',
            'Menggunakan data PBD, ujian diagnostik dan peperiksaan untuk merancang intervensi khusus bagi murid berisiko.',
            'Menghasilkan dan berkongsi bahan digital panitia yang seragam, mudah dicapai dan mesra murid.',
            'Memperkasa kompetensi guru melalui PLC, lesson study, peer coaching dan bimbingan rakan sebaya digital.',
            'Memantau dan menilai keberkesanan program secara berkala serta menambah baik pelan berdasarkan dapatan data dan maklum balas.'
        ],
        
        pelanTaktikal: [
            {
                namaProgram: 'LITERASI DIGITAL & e-PORTFOLIO PANITIA',
                aktiviti: [
                    'Bengkel pembangunan e-portfolio mengikut format standard panitia.',
                    'Latihan penggunaan Delima / Google Classroom untuk tugasan dan refleksi murid.',
                    'Pelaksanaan kuiz interaktif mingguan (Quizizz, Kahoot dan seumpamanya).'
                ],
                tanggungJawab: 'Penyelaras Digital & Semua Guru Panitia',
                tempoh: 'Januari – November (mingguan)',
                kosSumber: 'PCG Digital, capaian internet, peranti sedia ada',
                sasaran: 'Semua murid mengikut tingkatan dan kelas yang diurus panitia.',
                outputOutcome: [
                    '100% murid mempunyai e-portfolio aktif yang dikemas kini secara berkala.',
                    'Peningkatan ketekalan serahan tugasan dalam talian sekurang-kurangnya 20%.',
                    'Peningkatan penglibatan murid dalam PdP digital (rujuk analitik platform).'
                ],
                pelanKontengensi: [
                    'Menggunakan modul bercetak dan buku latihan sekiranya capaian internet terhad.',
                    'Menjalankan PdP secara bersemuka dengan lembaran kerja fizikal sebagai alternatif.'
                ]
            },
            {
                namaProgram: 'PLC BERFOKUS & PENYELARASAN KURIKULUM',
                aktiviti: [
                    'Sesi PLC berkala untuk penjajaran RPH, DSKP dan standard pentaksiran.',
                    'Lesson Study melibatkan perancangan, pemerhatian dan refleksi PdP.',
                    'Perkongsian amalan terbaik (best practice) dan bank soalan panitia.'
                ],
                tanggungJawab: 'Ketua Panitia & GKMP',
                tempoh: 'Februari – Oktober (sekali setiap bulan)',
                kosSumber: 'PCG Panitia, bahan cetakan dan alat bantu mengajar.',
                sasaran: 'Semua guru dalam panitia.',
                outputOutcome: [
                    'RPH selaras dengan DSKP dan standard pentaksiran semasa.',
                    'Peningkatan kualiti PdP berdasarkan dapatan pencerapan dan refleksi PLC.',
                    'Pembinaan budaya kolaboratif dan sokongan profesional dalam kalangan guru.'
                ],
                pelanKontengensi: [
                    'Menggunakan platform dalam talian (Google Meet / Delima) bagi PLC jika bersemuka tidak dapat dilaksanakan.',
                    'Sesi bimbingan individu bagi guru yang memerlukan sokongan tambahan.'
                ]
            },
            {
                namaProgram: 'BENGKEL TEKNIK MENJAWAB & MODUL KBAT',
                aktiviti: [
                    'Penyediaan modul soalan berfokus KBAT mengikut format peperiksaan semasa.',
                    'Pelaksanaan bengkel teknik menjawab untuk murid sasaran (pertengahan dan akhir tahun).',
                    'Latih tubi dan klinik akademik berkala berdasarkan analisis item.'
                ],
                tanggungJawab: 'Ketua Panitia & Guru Subjek Peperiksaan',
                tempoh: 'Mac – Oktober (mengikut jadual peperiksaan dalaman dan awam).',
                kosSumber: 'PCG Panitia, bahan modul cetakan, penggunaan bilik khas.',
                sasaran: 'Murid kelas peperiksaan dan murid yang dikenal pasti berpotensi cemerlang.',
                outputOutcome: [
                    'Peningkatan keyakinan murid menjawab soalan aras tinggi.',
                    'Peningkatan peratus lulus dan cemerlang dalam peperiksaan dalaman dan awam.',
                    'Pengurangan kesalahan berulang dalam item yang sama (berdasarkan analisis item).'
                ],
                pelanKontengensi: [
                    'Menjalankan bengkel dalam kumpulan kecil mengikut keperluan jika jadual padat.',
                    'Menyediakan rakaman video ringkas teknik menjawab untuk rujukan kendiri murid.'
                ]
            },
            {
                namaProgram: 'AUDIT DATA PBD & INTERVENSI BERFOKUS',
                aktiviti: [
                    'Mengumpul dan menganalisis data PBD secara berkala (suku tahun).',
                    'Mengenal pasti murid berisiko dan merangka intervensi khusus.',
                    'Melaksanakan intervensi kecil (klinikal, bimbingan, tutor rakan sebaya).'
                ],
                tanggungJawab: 'SU Peperiksaan, Guru Data & Ketua Panitia',
                tempoh: 'Februari, Mei, Ogos dan November.',
                kosSumber: 'Tiada kos besar, hanya keperluan cetakan dan rekod data.',
                sasaran: 'Semua murid dengan fokus khas kepada murid berprestasi rendah.',
                outputOutcome: [
                    'Laporan trend pencapaian murid yang jelas dan mudah dibaca.',
                    'Pengurangan bilangan murid dalam kategori sangat lemah.',
                    'Intervensi direkod dan ditindak susul sehingga akhir tahun.'
                ],
                pelanKontengensi: [
                    'Menggunakan rekod manual sekiranya sistem digital tidak dapat diakses.',
                    'Melaksanakan intervensi bertahap mengikut kekangan masa dan sumber.'
                ]
            },
            {
                namaProgram: 'PUSAT SUMBER DIGITAL & BAHAN INTERAKTIF',
                aktiviti: [
                    'Membangunkan repositori bahan digital (video, slaid, modul interaktif).',
                    'Menggalakkan penggunaan makmal komputer dan peranti mudah alih bagi PdP.',
                    'Menyelaras perkongsian bahan antara panitia untuk mengelak penduaan.'
                ],
                tanggungJawab: 'Guru Media, Penyelaras ICT & Ketua Panitia.',
                tempoh: 'Sepanjang tahun dengan semakan bahan setiap suku tahun.',
                kosSumber: 'PCG, sokongan PIBG, capaian internet dan peralatan sedia ada.',
                sasaran: 'Semua murid dan guru yang terlibat dalam PdP.',
                outputOutcome: [
                    'Sekurang-kurangnya 50 bahan digital berinteraktif tersedia mengikut topik.',
                    'Peningkatan penggunaan bilik komputer dan platform digital PdP.',
                    'Murid menunjukkan minat dan motivasi lebih tinggi terhadap topik sukar.'
                ],
                pelanKontengensi: [
                    'Menyediakan versi bercetak atau offline bagi bahan utama.',
                    'Menggunakan alat bantu mengajar mudah (kad, carta, manipulatif) jika capaian digital terhad.'
                ]
            },
            {
                namaProgram: 'KAPSUL VIDEO MIKRO & ULANGKAJI TOPIK',
                aktiviti: [
                    'Merancang skrip ringkas untuk video mikro (3–5 minit setiap topik).',
                    'Merakam dan menyusun video mengikut unit atau bab.',
                    'Mempromosikan penggunaan video sebagai pengulangan sebelum ujian dan peperiksaan.'
                ],
                tanggungJawab: 'Penyelaras Media Panitia & Guru Berminat.',
                tempoh: 'Mac – September.',
                kosSumber: 'Peralatan rakaman asas (telefon pintar), platform perkongsian video sekolah.',
                sasaran: 'Murid semua tingkatan dengan keutamaan kepada kelas peperiksaan.',
                outputOutcome: [
                    'Sekurang-kurangnya 20 video mikro bagi topik utama.',
                    'Murid lebih mudah mengulang kaji topik yang kompleks dalam masa singkat.',
                    'Peningkatan kefahaman konsep berdasarkan maklum balas murid dan keputusan ujian.'
                ],
                pelanKontengensi: [
                    'Menghasilkan infografik statik jika rakaman video tidak dapat dibuat.',
                    'Menggunakan slaid ringkas atau nota bergambar sebagai bahan alternatif.'
                ]
            },
            {
                namaProgram: 'e-MENTORING GURU & BIMBINGAN RAKAN SEBAYA DIGITAL',
                aktiviti: [
                    'Memadankan guru pakar dengan guru yang memerlukan bimbingan dalam aspek pedagogi dan teknologi.',
                    'Sesi bimbingan bersemuka atau dalam talian secara berkala.',
                    'Rekod perkembangan guru dan tindakan susulan berdasarkan keperluan.'
                ],
                tanggungJawab: 'Penyelaras LDP, GKMP & Ketua Panitia.',
                tempoh: 'Januari – November.',
                kosSumber: 'Tiada kos besar, hanya masa dan ruang perbincangan.',
                sasaran: 'Guru baharu dan guru yang memerlukan sokongan dalam penggunaan teknologi dan PdP berimpak tinggi.',
                outputOutcome: [
                    'Peningkatan keyakinan dan kompetensi guru dalam PdP digital dan berfokus data.',
                    'Pengurangan jurang kemahiran antara guru pakar dan guru baharu.',
                    'Budaya sokongan profesional yang sihat dalam kalangan warga panitia.'
                ],
                pelanKontengensi: [
                    'Mengganti sesi bimbingan formal dengan konsultasi tidak formal jika jadual padat.',
                    'Menggunakan kumpulan WhatsApp/Telegram sebagai saluran sokongan teknikal pantas.'
                ]
            }
        ],
        
        programName: 'Program Transformasi PdP Berimpak Tinggi',
        objektifProgram: 'Menyusun dan melaksanakan siri program taktikal yang menyokong pencapaian matlamat strategik panitia melalui PdP berkualiti, intervensi berfokus dan penggunaan teknologi secara optimum demi meningkatkan pencapaian murid dan mengurangkan jurang prestasi.',
        aktivitiProgram: [
            'Pelaksanaan PdP berasaskan projek, inkuiri dan pembelajaran aktif mengikut takwim panitia.',
            'Intervensi berkala untuk murid berprestasi rendah berdasarkan analisis data PBD dan peperiksaan.',
            'Klinik akademik, bengkel teknik menjawab dan sesi ulangkaji terancang sebelum peperiksaan utama.'
        ],
        penyelarasProgram: 'Ketua Panitia',
        tarikhMulaAkhir: 'Januari – November',
        penyelarasAktiviti: 'Penyelaras Program bersama guru mata pelajaran terlibat.',
        tempat: 'Bilik darjah, makmal komputer, pusat sumber dan ruang pembelajaran lain yang bersesuaian.',
        sasaran: 'Semua murid di bawah panitia dengan fokus kepada kelas peperiksaan dan murid berisiko.',
        kosSumber: 'Peruntukan PCG, sumbangan PIBG, sokongan komuniti dan penggunaan sumber sedia ada sekolah.',
        jawatankuasa: 'Pentadbir, GKMP, Ketua Panitia, SU Peperiksaan, Penyelaras Digital dan guru panitia.',
        ringkasanProgram: 'Program ini menyelaras semua inisiatif panitia dalam satu pelan strategik yang jelas merangkumi PdP harian, intervensi berfokus, penggunaan teknologi digital dan pemantauan berterusan. Pendekatan ini memastikan setiap murid mendapat peluang pembelajaran yang tersusun, adil dan berimpak tinggi serta membantu panitia mengekalkan budaya penambahbaikan berterusan.',
        
        prosesPelaksanaan: [
            {
                langkah: 1,
                prosesKerja: [
                    'Mengadakan mesyuarat awal panitia untuk menyemak pencapaian tahun sebelumnya.',
                    'Menganalisis data PBD, peperiksaan dan kehadiran untuk mengenal pasti isu utama.',
                    'Menetapkan matlamat strategik dan KPI tahunan panitia.'
                ],
                tanggungJawab: 'Ketua Panitia & GKMP',
                tarikhMulaAkhir: 'Januari',
                kpi: 'Dokumen analisis data dan KPI panitia disiapkan dan disahkan pentadbir.',
                sasaran: 'Semua guru panitia hadir dan terlibat.',
                status: 'Selesai'
            },
            {
                langkah: 2,
                prosesKerja: [
                    'Merancang takwim program dan pelan taktikal mengikut fasa tahun persekolahan.',
                    'Menyusun tugasan jawatankuasa kecil dan penyelaras program.',
                    'Menyediakan garis panduan pelaksanaan bagi setiap program utama.'
                ],
                tanggungJawab: 'Ketua Panitia & Jawatankuasa Program',
                tarikhMulaAkhir: 'Januari – Februari',
                kpi: 'Takwim program dan pelan taktikal diluluskan dan dikongsikan kepada semua guru.',
                sasaran: 'Semua program utama mempunyai PIC yang jelas.',
                status: 'Sedang Jalan'
            },
            {
                langkah: 3,
                prosesKerja: [
                    'Penyediaan modul PdP, bahan digital dan alat bantu mengajar mengikut perancangan.',
                    'Penyediaan modul intervensi dan bahan KBAT untuk murid sasaran.',
                    'Mengemas kini repositori bahan panitia di platform yang dipersetujui.'
                ],
                tanggungJawab: 'Guru Panitia & Penyelaras Digital',
                tarikhMulaAkhir: 'Februari – Mac',
                kpi: 'Sekurang-kurangnya 80% bahan utama tersedia sebelum pertengahan tahun.',
                sasaran: 'Semua guru mempunyai akses kepada bahan yang diperlukan.',
                status: 'Sedang Jalan'
            },
            {
                langkah: 4,
                prosesKerja: [
                    'Melaksanakan PdP mengikut RPH selaras DSKP dan strategi yang telah dirancang.',
                    'Melaksanakan program taktikal seperti bengkel KBAT, e-portfolio dan intervensi berfokus.',
                    'Merekod kehadiran, penglibatan dan pencapaian murid secara berkala.'
                ],
                tanggungJawab: 'Semua Guru Panitia & Penyelaras Program',
                tarikhMulaAkhir: 'Mac – Oktober',
                kpi: 'Program dilaksanakan mengikut jadual dengan rekod pelaksanaan yang lengkap.',
                sasaran: 'Semua murid di bawah panitia mendapat manfaat daripada program.',
                status: 'Sedang Jalan'
            },
            {
                langkah: 5,
                prosesKerja: [
                    'Menjalankan penilaian formatif dan sumatif mengikut takwim peperiksaan.',
                    'Menganalisis keputusan untuk mengenal pasti keberkesanan program dan jurang baharu.',
                    'Mengemas kini data dalam laporan panitia dan merancang intervensi tambahan jika perlu.'
                ],
                tanggungJawab: 'SU Peperiksaan, Guru Data & Guru Kelas',
                tarikhMulaAkhir: 'Mei, Ogos & November',
                kpi: 'Laporan analisis keputusan peperiksaan disiapkan dalam tempoh dua minggu selepas peperiksaan.',
                sasaran: 'Semua kelas di bawah panitia.',
                status: 'Sedang Jalan'
            },
            {
                langkah: 6,
                prosesKerja: [
                    'Melaksanakan pemantauan dan pencerapan PdP secara berkala.',
                    'Memberi maklum balas profesional kepada guru melalui coaching dan mentoring.',
                    'Merekod dapatan pemantauan untuk tindakan susulan.'
                ],
                tanggungJawab: 'Pentadbir, GKMP & Ketua Panitia',
                tarikhMulaAkhir: 'Februari – Oktober',
                kpi: 'Setiap guru dipantau sekurang-kurangnya dua kali setahun.',
                sasaran: 'Semua guru panitia.',
                status: 'Sedang Jalan'
            },
            {
                langkah: 7,
                prosesKerja: [
                    'Mengadakan mesyuarat post-mortem akhir tahun untuk menilai semua program.',
                    'Menyediakan laporan komprehensif yang merangkumi pencapaian, cabaran dan cadangan.',
                    'Menetapkan fokus utama penambahbaikan untuk tahun berikutnya.'
                ],
                tanggungJawab: 'Ketua Panitia & Jawatankuasa Panitia',
                tarikhMulaAkhir: 'November – Disember',
                kpi: 'Laporan post-mortem panitia disiapkan dan dibentang kepada pentadbir.',
                sasaran: 'Seluruh panitia dan pihak pengurusan sekolah.',
                status: 'Belum Mula'
            }
        ]
    };


    // --- FIREBASE LOAD/SAVE LOGIC (Unchanged) ---

    async function loadTemplateData(path, saveIfMissing = false) {
        try {
            const docSnap = await getDoc(doc(db, path));
            
            if (docSnap.exists()) {
                // Update global cache and set form state
                masterTemplateCache = docSnap.data();
                setFormState(masterTemplateCache);
                return true;
            } else {
                // Template not found, use hardcoded default
                masterTemplateCache = DEFAULT_MASTER_DATA;
                setFormState(DEFAULT_MASTER_DATA);
                if (saveIfMissing) {
                    await savePlan(null, path);
                }
                return false;
            }
        } catch (error) {
             console.error(`Error processing path ${path}:`, error);
             // On critical error, fallback to hardcoded data to ensure UI loads
             masterTemplateCache = DEFAULT_MASTER_DATA;
             setFormState(DEFAULT_MASTER_DATA);
             return false;
        }
    }


    async function loadPlan(subject, isAdminTemplateLoad = false) {
        if (!isAuthReady || !db || !subject) { planEditorContainer.classList.add('hidden'); return; }
        currentSubject = subject;
        if (!isAdminTemplateLoad) { pageMainTitle.innerHTML = `Pelan Strategik Mata Pelajaran **${subject}**`; }
        planEditorContainer.classList.remove('hidden');
        loadingOverlay.classList.remove('hidden'); 
        
        const path = getPlanDocPath(subject);
        
        try {
            const docSnap = await getDoc(doc(db, path));
            
            if (docSnap.exists()) {
                // Load existing subject data
                setFormState(docSnap.data());
                showMessage(`Pelan Strategik untuk ${subject} berjaya dimuatkan untuk pengeditan.`, 'success');
            } else if (!isAdminTemplateLoad) {
                // Load from cache/master template for new subject
                setFormState(JSON.parse(JSON.stringify(masterTemplateCache))); // Deep clone the template
                showMessage(`Memuatkan templat Master untuk subjek baharu: ${subject}.`, 'info');
            }
            
            saveButton.textContent = isAdminTemplateLoad ? 'Simpan Templat Induk' : 'Simpan Pelan Operasi';

        } catch (error) {
            console.error("Error fetching or loading plan data:", error);
            showMessage(`Ralat memuatkan data: ${error.message}. Memuatkan templat Master.`, 'error');
            setFormState(DEFAULT_MASTER_DATA); // Final fallback
        } finally { loadingOverlay.classList.add('hidden'); }
    }


    async function savePlan(e, specificPath = null) {
        if (e) e.preventDefault();
        
        const savePath = specificPath || getPlanDocPath(currentSubject);
        const subjectName = specificPath === MASTER_TEMPLATE_PATH ? 'Templat Induk' : currentSubject;

        if (!isAuthReady || !db || !subjectName) {
            showMessage("Sila pilih subjek atau sahkan templat.", 'error');
            return;
        }

        saveButton.disabled = true;
        saveButton.textContent = `Menyimpan ${subjectName}...`;

        try {
            const staticData = getFormState();
            
            const planRef = doc(db, savePath);
            await setDoc(planRef, staticData);
            
            showMessage(`Pelan Strategik untuk ${subjectName} berjaya disimpan!`, 'success');

        } catch (error) {
            console.error("Error saving plan:", error);
            showMessage(`Gagal menyimpan: ${error.message}`, 'error');
        } finally {
            saveButton.disabled = false;
            saveButton.textContent = specificPath === MASTER_TEMPLATE_PATH ? 'Simpan Templat Induk' : 'Simpan Pelan Operasi';
        }
    }
    
    // --- FIREBASE INITIALIZATION AND APP STARTUP ---

    async function loadSubjectList(selectSubject = null) {
        if (!isAuthReady || !db) return;

        subjectListMessage.classList.remove('hidden');
        subjectListMessage.textContent = 'Memuatkan senarai subjek...';
        subjectSelector.innerHTML = '<option value="" disabled selected>--- Memuatkan... ---</option>';

        try {
            const subjectsRef = doc(db, SUBJECTS_DOC_PATH);
            const docSnap = await getDoc(subjectsRef);
            let subjects = [];
            
            if (!docSnap.exists() || !Array.isArray(docSnap.data().subjects) || docSnap.data().subjects.length === 0) {
                 subjects = ["Sejarah", "Matematik", "Sains", "Bahasa Inggeris", "Pendidikan Islam"];
                 await setDoc(subjectsRef, { subjects: subjects });
            } else {
                subjects = docSnap.data().subjects;
            }

            subjectSelector.innerHTML = '<option value="" disabled selected>--- Sila Pilih Subjek ---</option>';
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject;
                subjectSelector.appendChild(option);
            });
            
            subjectListMessage.classList.add('hidden');

            if (selectSubject) {
                subjectSelector.value = selectSubject;
                loadPlan(selectSubject, false);
            }

        } catch (error) {
            console.error("Error loading subject list:", error);
            subjectListMessage.textContent = 'Ralat memuatkan senarai subjek.';
            showMessage('Ralat memuatkan senarai subjek.', 'error', newSubjectMessageBox);
        }
    }

    async function initializeFirebaseAndAuth() {
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            await signInAnonymously(auth); 
            userId = auth.currentUser?.uid;
            isAuthReady = true;

            // 1. Ensure UI is visible immediately after auth (guaranteed visibility)
            ensureUIVisible(); 
            
            // 2. Load Master Template Data into cache first (synchronous structure ready)
            await loadTemplateData(MASTER_TEMPLATE_PATH, false);
            
            // 3. Start subject loading
            await loadSubjectList();
            
            // 4. Set default mode 
            setAdminMode(false);

        } catch (error) {
            console.error("Firebase initialization error:", error);
            ensureUIVisible();
            showMessage(`Ralat Sistem (Firebase): ${error.message}. SILA SEMAK PERATURAN KESELAMATAN FIREBASE ANDA.`, 'error');
        }
    }
    
    // --- COMPONENT LOGIC ---

    function setAdminMode(enable) {
        isAdminMode = enable;
        subjectSelector.value = '';
        pelanTaktikalTableBody.innerHTML = ''; 

        if (isAdminMode) {
            subjectManagementSection.classList.add('hidden');
            templateAdminGate.classList.remove('hidden');
            planEditorContainer.classList.add('hidden');
            pageMainTitle.textContent = 'Templat Induk Pelan Strategik';
            headerSubtitle.textContent = 'Anda kini dalam Mod Pentadbir. Sila buka kunci untuk mengedit templat asas.';
            currentSubject = null; 
            addTaktikalProgramButton.classList.remove('hidden');
        } else {
            subjectManagementSection.classList.remove('hidden');
            templateAdminGate.classList.add('hidden');
            planEditorContainer.classList.add('hidden');
            pageMainTitle.textContent = 'Pelan Strategik Mata Pelajaran';
            headerSubtitle.textContent = 'Sila pilih subjek atau cipta subjek baharu untuk memulakan pengeditan.';
            addTaktikalProgramButton.classList.add('hidden');
        }
    }

    function createSubjectSlug(subjectName) {
        return subjectName.toLowerCase().replace(/[^a-z0-9]+/g, '_').trim('_');
    }
    
    function getPlanDocPath(subject) {
        if (subject === MASTER_TEMPLATE_PATH) return MASTER_TEMPLATE_PATH;
        const slug = createSubjectSlug(subject);
        return `${PLAN_COLLECTION_BASE}/${slug}_plan`;
    }
    
    // --- EVENT HANDLERS ---
    
    document.addEventListener('DOMContentLoaded', initializeFirebaseAndAuth); 
    document.getElementById('addRowButton').addEventListener('click', () => { createTableRow({}); updateRowNumbers(); });
    document.getElementById('addTaktikalProgramButton').addEventListener('click', () => { createTaktikalProgramRow({}); updateTaktikalProgramRowNumbers(); });
    document.getElementById('saveButton').addEventListener('click', savePlan);
    document.getElementById('adminFooterToggle').addEventListener('click', () => { setAdminMode(true); });
    
    document.getElementById('switchSubjectButton').addEventListener('click', () => {
        setAdminMode(false); 
        currentSubject = null;
        subjectSelector.value = ''; 
        pelanTaktikalTableBody.innerHTML = '';
        document.getElementById('addTaktikalProgramButton').classList.add('hidden');
    });

    document.getElementById('addNewSubjectButton').addEventListener('click', async () => {
        if (!isAuthReady || !db) return;
        const newSubjectInput = document.getElementById('newSubjectInput');
        const newSubjectName = newSubjectInput.value.trim();
        if (!newSubjectName) { showMessage('Sila masukkan nama subjek.', 'error', newSubjectMessageBox); return; }

        const addSubjectButton = addNewSubjectButton;
        addSubjectButton.disabled = true;
        addSubjectButton.textContent = 'Menambah...';

        try {
            const subjectsRef = doc(db, SUBJECTS_DOC_PATH);
            const docSnap = await getDoc(subjectsRef);
            if (docSnap.exists() && docSnap.data().subjects.includes(newSubjectName)) {
                showMessage(`Subjek '${newSubjectName}' sudah wujud.`, 'error', newSubjectMessageBox);
            } else {
                await updateDoc(subjectsRef, { subjects: arrayUnion(newSubjectName) });
                newSubjectInput.value = '';
                showMessage(`Subjek '${newSubjectName}' berjaya ditambah!`, 'success', newSubjectMessageBox);
                await loadSubjectList(newSubjectName);
            }
        } catch (error) {
            console.error("Error adding new subject:", error);
            showMessage(`Gagal menambah subjek: ${error.message}`, 'error', newSubjectMessageBox);
        } finally {
            addSubjectButton.disabled = false;
            addSubjectButton.textContent = 'Tambah';
        }
    });

    subjectSelector.addEventListener('change', (e) => {
        const selectedSubject = e.target.value;
        if (selectedSubject) {
            loadPlan(selectedSubject, false);
            saveButton.textContent = 'Simpan Pelan Operasi'; 
        } else {
            planEditorContainer.classList.add('hidden');
            pageMainTitle.innerHTML = 'Pelan Strategik Mata Pelajaran';
        }
    });
</script>

</body>
</html>