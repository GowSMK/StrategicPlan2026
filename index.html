<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pelan Operasi Editor</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        .table-auto-layout {
            /* Ensures table is wide enough for content, enabling horizontal scroll on mobile */
            width: 1200px; 
            table-layout: fixed;
            border-collapse: collapse;
        }
        .table-auto-layout th, .table-auto-layout td {
            padding: 8px 12px;
            text-align: left;
            border: 1px solid #e5e7eb;
            font-size: 0.875rem;
            vertical-align: top;
        }
        
        #prosesPelaksanaanTable th, #pelanTaktikalTable th {
            text-align: center;
            white-space: normal; 
            line-height: 1.2;
            padding-top: 10px;
            padding-bottom: 10px;
        }
        #pelanTaktikalTable textarea {
            min-height: 60px; /* Ensure sufficient space for multiline text */
        }
        
    </style>
</head>
<body>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="fixed inset-0 bg-gray-50 flex items-center justify-center z-50">
    <div class="text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500 mx-auto"></div>
        <p class="mt-4 text-indigo-700 font-semibold">Memulakan Aplikasi...</p>
    </div>
</div>

<div id="app" class="min-h-screen p-4 sm:p-8 max-w-7xl mx-auto hidden">

    <!-- Header Section (Fixed Titles) -->
    <header class="text-center mb-8">
        <h1 class="text-4xl font-extrabold text-indigo-900 mb-2 tracking-tight">
            SMK Seri Pulai Perdana
        </h1>
        <h2 id="pageMainTitle" class="text-2xl font-bold text-gray-800">
            Pelan Strategik Mata Pelajaran
        </h2>
        <p id="headerSubtitle" class="text-sm text-gray-500 mt-1">Sila pilih subjek atau cipta subjek baharu untuk memulakan pengeditan.</p>
    </header>

    <!-- Subject Management Section (Only visible in Subject Editing Mode) -->
    <div id="subjectManagementSection" class="bg-white p-6 rounded-xl shadow-lg max-w-lg mx-auto mb-8 space-y-4">
        
        <!-- 1. Existing Subject Selector -->
        <div>
            <label for="subjectSelector" class="block text-lg font-medium text-gray-700 mb-2">1. Pilih Mata Pelajaran (Subjek) untuk Diedit:</label>
            <select id="subjectSelector" class="w-full p-3 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-white">
                <!-- Options populated by JavaScript -->
            </select>
            <p id="subjectListMessage" class="text-xs text-gray-500 mt-1 hidden">Memuatkan senarai subjek...</p>
        </div>

        <!-- 2. Add New Subject -->
        <div class="border-t pt-4">
            <label for="newSubjectInput" class="block text-lg font-medium text-gray-700 mb-2">2. Tambah Subjek Baharu:</label>
            <div class="flex space-x-2">
                <input type="text" id="newSubjectInput" placeholder="Contoh: Kimia" class="flex-grow p-3 border border-green-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150">
                <button id="addNewSubjectButton" class="bg-green-600 text-white font-semibold px-4 py-3 rounded-lg hover:bg-green-700 transition duration-200">
                    Tambah
                </button>
            </div>
            <div id="newSubjectMessageBox" class="mt-3 p-2 text-center rounded-lg hidden text-sm"></div>
        </div>
    </div>
    
    <!-- MASTER TEMPLATE ADMIN LOGIN GATE (Hidden by default, shown when footer link is clicked) -->
    <div id="templateAdminGate" class="bg-yellow-50 p-6 rounded-xl shadow-lg max-w-lg mx-auto mb-8 space-y-4 hidden">
        <h3 class="text-xl font-bold text-yellow-800">Templat Induk: Sila Sahkan</h3>
        <p class="text-sm text-yellow-700">Mod ini membolehkan anda mengedit templat asas untuk subjek baharu.</p>
        <div class="flex space-x-2">
            <input type="password" id="templateAdminKeyInput" placeholder="Masukkan Kunci Pentadbir" class="flex-grow p-3 border border-yellow-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 transition duration-150">
            <button id="templateAdminLoginButton" class="bg-yellow-600 text-white font-semibold px-4 py-3 rounded-lg hover:bg-yellow-700 transition duration-200">
                Buka Kunci
            </button>
        </div>
        <div id="templateAdminMessage" class="mt-3 p-2 text-center rounded-lg hidden text-sm"></div>
    </div>


    <!-- Main Content Container (Used for both Subject Editing and Template Editing) -->
    <div id="planEditorContainer" class="bg-white p-6 rounded-xl shadow-2xl hidden">
        <div id="messageBox" class="p-3 text-center rounded-lg hidden mb-4" role="alert"></div>
        
        <!-- Switch Subject Button -->
        <div class="flex justify-start mb-4">
            <button id="switchSubjectButton" class="text-sm text-indigo-500 hover:text-indigo-700 font-medium py-1 px-3 rounded-lg border border-indigo-200 hover:bg-indigo-50 transition duration-150 flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                Tukar Subjek
            </button>
        </div>

        <!-- Section 0.5: Strategic Goals Table -->
        <h3 class="text-xl font-semibold text-red-600 mb-4 border-b pb-2">Matlamat & Strategi</h3>
        <div class="overflow-x-auto mb-8">
            <table class="table-auto-layout border-collapse border border-gray-200" style="width: 1000px;">
                <tbody>
                    <tr>
                        <th class="w-1/5 bg-red-100 font-medium">MATLAMAT STRATEGIK</th>
                        <td colspan="3"><textarea id="matlamatStrategik" rows="2" class="w-full focus:outline-none resize-none"></textarea></td>
                    </tr>
                    <tr>
                        <th class="w-1/5 bg-red-100 font-medium">STRATEGI</th>
                        <td colspan="3"><textarea id="strategiList" rows="3" class="w-full focus:outline-none resize-none"></textarea></td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Section 0.7: Pelan Taktikal (Senarai Program) - NEW COMPREHENSIVE TABLE -->
        <h3 class="text-xl font-semibold text-purple-600 mb-4 border-b pb-2">Pelan Taktikal (Senarai Program)</h3>
        <div class="overflow-x-auto mb-8">
            <table class="table-auto-layout border-collapse border border-gray-200" id="pelanTaktikalTable" style="width: 1800px;">
                <thead>
                    <tr class="bg-purple-50 text-gray-600 uppercase text-xs">
                        <th style="width: 30px;" class="text-center">Bil</th>
                        <th style="width: 150px;">Nama Program</th>
                        <th style="width: 250px;">Aktiviti</th>
                        <th style="width: 150px;">Tanggungjawab</th>
                        <th style="width: 100px;">Tempoh / Hari / Kekerapan</th>
                        <th style="width: 80px;">Kos / Sumber</th>
                        <th style="width: 150px;">Sasaran</th>
                        <th style="width: 200px;">Output / Outcome / Benefit</th>
                        <th style="width: 200px;">Pelan Kontengensi</th>
                        <th style="width: 50px;" class="text-center">Padam</th>
                    </tr>
                </thead>
                <tbody id="pelanTaktikalTableBody">
                    <!-- Dynamic Taktikal Program Rows -->
                </tbody>
            </table>
            <button id="addTaktikalProgramButton" class="bg-purple-500 text-white px-3 py-1 mt-2 text-sm rounded-lg hover:bg-purple-600 transition duration-150 flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                Tambah Program Taktikal
            </button>
        </div>


        <!-- Section 1: Butiran Program (Static Header Info - Now less relevant due to tactical table) -->
        <h3 class="text-xl font-semibold text-indigo-600 mb-4 border-b pb-2">Butiran Program (Untuk Pelan Am)</h3>
        <div class="overflow-x-auto mb-8">
            <table class="table-auto-layout border-collapse border border-gray-200" style="width: 1000px;">
                <tbody>
                    <tr>
                        <th class="w-1/5 bg-gray-100 font-medium">Nama Program</th>
                        <td colspan="3"><input type="text" id="programName" class="w-full focus:outline-none" value=""></td>
                    </tr>
                    <tr>
                        <th class="w-1/5 bg-gray-100 font-medium">Objektif Program</th>
                        <td colspan="3"><textarea id="objektifProgram" rows="3" class="w-full focus:outline-none resize-none"></textarea></td>
                    </tr>
                    <tr>
                        <th class="w-1/5 bg-gray-100 font-medium">Aktiviti Program</th>
                        <td colspan="3"><textarea id="aktivitiProgram" rows="5" class="w-full focus:outline-none resize-none"></textarea></td>
                    </tr>
                    <tr>
                        <th class="w-1/5 bg-gray-100 font-medium">Penyelaras Program</th>
                        <td class="w-2/5"><input type="text" id="penyelarasProgram" class="w-full focus:outline-none" value=""></td>
                        <th class="w-1/5 bg-gray-100 font-medium">Tarikh Mula - Akhir</th>
                        <td class="w-1/5"><input type="text" id="tarikhMulaAkhir" class="w-full focus:outline-none" value=""></td>
                    </tr>
                    <tr>
                        <th class="w-1/5 bg-gray-100 font-medium">Penyelaras Aktiviti</th>
                        <td><input type="text" id="penyelarasAktiviti" class="w-full focus:outline-none" value=""></td>
                        <th class="w-1/5 bg-gray-100 font-medium">Tempat</th>
                        <td><input type="text" id="tempat" class="w-full focus:outline-none" value=""></td>
                    </tr>
                    <tr>
                        <th class="w-1/5 bg-gray-100 font-medium">Sasaran</th>
                        <td><input type="text" id="sasaran" class="w-full focus:outline-none" value=""></td>
                        <th class="w-1/5 bg-gray-100 font-medium">Kos dan Sumber</th>
                        <td><input type="text" id="kosSumber" class="w-full focus:outline-none" value=""></td>
                    </tr>
                    <tr>
                        <th class="w-1/5 bg-gray-100 font-medium">Jawatankuasa</th>
                        <td colspan="3"><input type="text" id="jawatankuasa" class="w-full focus:outline-none" value=""></td>
                    </tr>
                    <tr>
                        <th class="w-1/5 bg-gray-100 font-medium">Ringkasan Program</th>
                        <td colspan="3"><textarea id="ringkasanProgram" rows="4" class="w-full focus:outline-none resize-none"></textarea></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Section 2: Proses Pelaksanaan Table (Proses Kerja) -->
        <h3 class="text-xl font-semibold text-indigo-600 mb-4 border-b pb-2">Proses Pelaksanaan (Langkah-langkah)</h3>
        
        <div class="overflow-x-auto mb-4">
            <table class="table-auto-layout border-collapse border border-gray-200" id="prosesPelaksanaanTable" style="width: 1200px;">
                <thead>
                    <tr class="bg-gray-100 text-gray-600 uppercase text-xs">
                        <th style="width: 50px;">Langkah</th>
                        <th style="width: 250px;">Proses Kerja</th>
                        <th style="width: 150px;">Tanggungjawab</th> 
                        <th style="width: 150px;">Tarikh Mula-Akhir</th> 
                        <th style="width: 150px;">KPI</th>
                        <th style="width: 150px;">Sasaran</th>
                        <th style="width: 120px;">Status</th> 
                        <th style="width: 80px;">Tindakan</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Dynamic rows will be inserted here -->
                </tbody>
            </table>
        </div>
        
        <!-- Table Action Buttons -->
        <div class="flex justify-between items-center mb-6">
            <button id="addRowButton" class="bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 transition duration-150 flex items-center">
                <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                Tambah Langkah
            </button>
        </div>

        <!-- Save Button -->
        <div class="border-t pt-4">
            <button id="saveButton" class="w-full bg-green-600 text-white font-semibold py-3 rounded-lg hover:bg-green-700 transition duration-200 shadow-md">
                Simpan Pelan Operasi
            </button>
        </div>
    </div>
</div>

<!-- Subtle Footer Link for Admin Mode -->
<footer class="p-4 text-center">
    <button id="adminFooterToggle" class="text-xs text-gray-400 hover:text-indigo-600 transition duration-150 cursor-pointer">
        Mod Pentadbir
    </button>
</footer>

<!-- Firebase SDKs -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    setLogLevel('debug');

    // --- MANDATORY GLOBAL VARIABLE SETUP ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    
    // Hardcoded Firebase Config Fallback from SDK_Jadual.txt
    const FALLBACK_FIREBASE_CONFIG = {
        apiKey: "AIzaSyBgvyb95-jujtCC2HPiHXLdYMJgQquIEx4",
        authDomain: "jadual-3f0aa.firebaseapp.com",
        projectId: "jadual-3f0aa",
        storageBucket: "jadual-3f0aa.firebasestorage.app",
        messagingSenderId: "496526436851",
        appId: "1:496526436851:web:78ff48b28bfc8c31f14a86"
    };

    let firebaseConfig = FALLBACK_FIREBASE_CONFIG;
    try {
        if (typeof __firebase_config !== 'undefined' && __firebase_config.trim() !== '') {
            const parsedConfig = JSON.parse(__firebase_config);
            if (Object.keys(parsedConfig).length > 0) {
                 firebaseConfig = parsedConfig;
            }
        }
    } catch (e) {
        console.error("Error parsing __firebase_config. Using fallback.", e);
    }
    
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // --- FIREBASE INITIALIZATION AND AUTHENTICATION ---
    let app, db, auth;
    let userId = null;
    let isAuthReady = false;
    let currentSubject = null; 
    let isAdminMode = false; 
    const ADMIN_SECRET_KEY = "admin2025";


    // --- FIRESTORE PATHS ---
    const SUBJECTS_DOC_PATH = `artifacts/${appId}/public/data/subject_config/subject_list`;
    const PLAN_COLLECTION_BASE = `artifacts/${appId}/public/data/pelan_strategik`; 
    const MASTER_TEMPLATE_PATH = `${PLAN_COLLECTION_BASE}/master_template`; 

    // --- DOM ELEMENTS ---
    const loadingOverlay = document.getElementById('loadingOverlay');
    const mainApp = document.getElementById('app');
    const messageBox = document.getElementById('messageBox');
    const saveButton = document.getElementById('saveButton');
    const addRowButton = document.getElementById('addRowButton');
    const tableBody = document.getElementById('tableBody');
    const subjectSelector = document.getElementById('subjectSelector');
    const planEditorContainer = document.getElementById('planEditorContainer');
    const pageMainTitle = document.getElementById('pageMainTitle');
    const newSubjectInput = document.getElementById('newSubjectInput');
    const addNewSubjectButton = document.getElementById('addNewSubjectButton');
    const newSubjectMessageBox = document.getElementById('newSubjectMessageBox');
    const subjectListMessage = document.getElementById('subjectListMessage');
    
    const adminFooterToggle = document.getElementById('adminFooterToggle');
    const subjectManagementSection = document.getElementById('subjectManagementSection');
    const templateAdminGate = document.getElementById('templateAdminGate');
    const templateAdminKeyInput = document.getElementById('templateAdminKeyInput');
    const templateAdminLoginButton = document.getElementById('templateAdminLoginButton');
    const templateAdminMessage = document.getElementById('templateAdminMessage');
    const headerSubtitle = document.getElementById('headerSubtitle');
    const switchSubjectButton = document.getElementById('switchSubjectButton');
    
    // Elements for Strategic Goals
    const matlamatStrategik = document.getElementById('matlamatStrategik');
    const strategiList = document.getElementById('strategiList');
    
    // Elements for NEW Pelan Taktikal Table
    const pelanTaktikalTableBody = document.getElementById('pelanTaktikalTableBody');
    const addTaktikalProgramButton = document.getElementById('addTaktikalProgramButton');

    let programCounter = 0;


    // --- UTILITIES ---

    function showMessage(message, type = 'success', target = messageBox) {
        target.textContent = message;
        target.className = `p-3 text-center rounded-lg ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} mb-4`;
        target.classList.remove('hidden');
        setTimeout(() => { target.classList.add('hidden'); }, 5000);
    }
    
    // Convert multiline text to array for saving
    const textToArray = (text) => text.split('\n').map(item => item.trim()).filter(item => item.length > 0);
    // Convert array back to multiline text for textarea
    const arrayToText = (array) => Array.isArray(array) ? array.join('\n') : '';
    
    // Function to ensure UI is visible after initialization
    function ensureUIVisible() {
        loadingOverlay.classList.add('hidden');
        mainApp.classList.remove('hidden');
    }

    // --- PELAN TAKTIKAL TABLE MANAGEMENT ---
    
    function createTaktikalProgramRow(data = {}) {
        programCounter++;
        const row = pelanTaktikalTableBody.insertRow();
        row.dataset.id = `taktikal-program-${programCounter}`;
        row.className = 'hover:bg-gray-50';

        const rowData = {
            bil: pelanTaktikalTableBody.rows.length,
            namaProgram: data.namaProgram || '',
            aktiviti: arrayToText(data.aktiviti || ['Aktiviti 1']),
            tanggungJawab: data.tanggungJawab || '',
            tempoh: data.tempoh || '',
            kosSumber: data.kosSumber || '',
            sasaran: data.sasaran || '',
            outputOutcome: arrayToText(data.outputOutcome || ['Output/Outcome']),
            pelanKontengensi: arrayToText(data.pelanKontengensi || ['Pelan Kontengensi']),
            ...data
        };

        row.innerHTML = `
            <td class="text-center font-medium program-bil">${rowData.bil}</td>
            <td><textarea rows="3" class="w-full focus:outline-none resize-none" data-field="namaProgram">${rowData.namaProgram}</textarea></td>
            <td><textarea rows="3" class="w-full focus:outline-none resize-none" data-field="aktiviti">${rowData.aktiviti}</textarea></td>
            <td><input type="text" class="w-full focus:outline-none" data-field="tanggungJawab" value="${rowData.tanggungJawab}"></td>
            <td><input type="text" class="w-full focus:outline-none" data-field="tempoh" value="${rowData.tempoh}"></td>
            <td><input type="text" class="w-full focus:outline-none" data-field="kosSumber" value="${rowData.kosSumber}"></td>
            <td><input type="text" class="w-full focus:outline-none" data-field="sasaran" value="${rowData.sasaran}"></td>
            <td><textarea rows="3" class="w-full focus:outline-none resize-none" data-field="outputOutcome">${rowData.outputOutcome}</textarea></td>
            <td><textarea rows="3" class="w-full focus:outline-none resize-none" data-field="pelanKontengensi">${rowData.pelanKontengensi}</textarea></td>
            <td class="text-center">
                <button type="button" class="text-red-500 hover:text-red-700 delete-program-taktikal-btn" title="Hapus">
                    <svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3"></path></svg>
                </button>
            </td>
        `;

        // Event listener for delete button
        row.querySelector('.delete-program-taktikal-btn').addEventListener('click', () => {
            row.remove();
            updateTaktikalProgramRowNumbers();
        });
    }

    function updateTaktikalProgramRowNumbers() {
        Array.from(pelanTaktikalTableBody.rows).forEach((row, index) => {
            row.cells[0].textContent = index + 1;
        });
    }

    function collectPelanTaktikalData() {
        const data = [];
        Array.from(pelanTaktikalTableBody.rows).forEach(row => {
            const rowData = {};
            Array.from(row.querySelectorAll('[data-field]')).forEach(input => {
                const fieldName = input.dataset.field;
                let value = input.value.trim();
                
                // Fields that should be stored as arrays (multiline text)
                if (['aktiviti', 'outputOutcome', 'pelanKontengensi'].includes(fieldName)) {
                    value = textToArray(value);
                }
                rowData[fieldName] = value;
            });
            rowData.bil = parseInt(row.cells[0].textContent, 10);
            data.push(rowData);
        });
        return data;
    }
    
    addTaktikalProgramButton.addEventListener('click', () => {
        createTaktikalProgramRow({});
        updateTaktikalProgramRowNumbers();
    });


    // --- DYNAMIC TABLE (Proses Pelaksanaan) MANAGEMENT (Unchanged) ---
    
    function createTableRow(data = {}) {
        const langkah = tableBody.rows.length + 1;
        const row = tableBody.insertRow();
        row.dataset.index = langkah;
        row.className = 'hover:bg-gray-50';

        const rowData = {
            langkah: langkah,
            prosesKerja: arrayToText(data.prosesKerja || ["Proses 1", "Proses 2"]),
            tanggungJawab: data.tanggungJawab || '',
            tarikhMulaAkhir: data.tarikhMulaAkhir || '',
            kpi: data.kpi || '',
            sasaran: data.sasaran || '',
            status: data.status || 'Jelas',
            ...data
        };

        const statusOptions = ['Jelas', 'Belum Mula', 'Sedang Jalan', 'Selesai', 'Laporan disemak'];

        row.innerHTML = `
            <td class="text-center font-medium">${rowData.langkah}</td>
            <td><textarea rows="3" class="w-full focus:outline-none resize-none" data-field="prosesKerja">${rowData.prosesKerja}</textarea></td>
            <td><input type="text" class="w-full focus:outline-none" data-field="tanggungJawab" value="${rowData.tanggungJawab}"></td>
            <td><input type="text" class="w-full focus:outline-none" data-field="tarikhMulaAkhir" value="${rowData.tarikhMulaAkhir}"></td>
            <td><input type="text" class="w-full focus:outline-none" data-field="kpi" value="${rowData.kpi}"></td>
            <td><input type="text" class="w-full focus:outline-none" data-field="sasaran" value="${rowData.sasaran}"></td>
            <td>
                <select class="w-full p-1 border rounded" data-field="status">
                    ${statusOptions.map(opt => `<option value="${opt}" ${rowData.status === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                </select>
            </td>
            <td class="text-center">
                <button type="button" class="text-red-500 hover:text-red-700 delete-row-btn" title="Hapus">
                    <svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3"></path></svg>
                </button>
            </td>
        `;

        row.querySelector('.delete-row-btn').addEventListener('click', () => {
            row.remove();
            updateRowNumbers();
        });
    }

    function updateRowNumbers() {
        Array.from(tableBody.rows).forEach((row, index) => {
            const rowNumber = index + 1;
            row.cells[0].textContent = rowNumber;
            row.dataset.index = rowNumber;
        });
    }

    function collectTableData() {
        const data = [];
        Array.from(tableBody.rows).forEach(row => {
            const rowData = {};
            Array.from(row.querySelectorAll('[data-field]')).forEach(input => {
                const fieldName = input.dataset.field;
                let value = input.value.trim();
                
                if (fieldName === 'prosesKerja') {
                    value = textToArray(value);
                }
                rowData[fieldName] = value;
            });
            rowData.langkah = parseInt(row.dataset.index, 10);
            data.push(rowData);
        });
        return data;
    }

    addRowButton.addEventListener('click', () => {
        createTableRow({});
        updateRowNumbers();
    });

    // --- TEMPLATE & ADMIN MODE LOGIC ---
    
    function setAdminMode(enable) {
        isAdminMode = enable;
        subjectSelector.value = '';
        pelanTaktikalTableBody.innerHTML = ''; 

        if (isAdminMode) {
            subjectManagementSection.classList.add('hidden');
            templateAdminGate.classList.remove('hidden');
            planEditorContainer.classList.add('hidden');
            pageMainTitle.textContent = 'Templat Induk Pelan Strategik';
            headerSubtitle.textContent = 'Anda kini dalam Mod Pentadbir. Sila buka kunci untuk mengedit templat asas.';
            currentSubject = null; 
            addTaktikalProgramButton.classList.remove('hidden');
        } else {
            subjectManagementSection.classList.remove('hidden');
            templateAdminGate.classList.add('hidden');
            planEditorContainer.classList.add('hidden');
            pageMainTitle.textContent = 'Pelan Strategik Mata Pelajaran';
            headerSubtitle.textContent = 'Sila pilih subjek atau cipta subjek baharu untuk memulakan pengeditan.';
            addTaktikalProgramButton.classList.add('hidden');
        }
    }
    
    // ----------------------------------------------------
    // Template Admin Login Handler
    // ----------------------------------------------------
    templateAdminLoginButton.addEventListener('click', () => {
        if (templateAdminKeyInput.value === ADMIN_SECRET_KEY) {
            templateAdminGate.classList.add('hidden');
            planEditorContainer.classList.remove('hidden');
            headerSubtitle.textContent = 'Anda mengedit TEMPLAT INDUK. Perubahan di sini akan digunakan pada subjek BAHARU sahaja.';
            templateAdminKeyInput.value = ''; 
            addTaktikalProgramButton.classList.remove('hidden');
            
            // Load the Master Template Data (Setting isAdminTemplateLoad=true)
            loadPlan(MASTER_TEMPLATE_PATH, true); 
        } else {
            showMessage('Kunci Pentadbir tidak sah.', 'error', templateAdminMessage);
            templateAdminKeyInput.value = '';
        }
    });

    // ----------------------------------------------------
    // Toggle Admin/Subject Mode (triggered by footer)
    // ----------------------------------------------------
    adminFooterToggle.addEventListener('click', () => {
        setAdminMode(true);
    });
    
    // ----------------------------------------------------
    // Switch Subject Button Handler (The fix for the user's issue)
    // ----------------------------------------------------
    switchSubjectButton.addEventListener('click', () => {
        setAdminMode(false); 
        currentSubject = null;
        subjectSelector.value = ''; 
        pelanTaktikalTableBody.innerHTML = '';
        addTaktikalProgramButton.classList.add('hidden');
    });


    // --- SUBJECT MANAGEMENT (Omitted for brevity, unchanged) ---

    function createSubjectSlug(subjectName) {
        return subjectName.toLowerCase().replace(/[^a-z0-9]+/g, '_').trim('_');
    }

    async function loadSubjectList(selectSubject = null) {
        if (!isAuthReady || !db) {
             subjectListMessage.classList.remove('hidden');
             subjectListMessage.textContent = 'Ralat: Sambungan terputus atau Firebase tidak sedia.';
             return;
        }

        subjectListMessage.classList.remove('hidden');
        subjectListMessage.textContent = 'Memuatkan senarai subjek...';
        subjectSelector.innerHTML = '<option value="" disabled selected>--- Memuatkan... ---</option>';

        try {
            const subjectsRef = doc(db, SUBJECTS_DOC_PATH);
            const docSnap = await getDoc(subjectsRef);
            let subjects = [];
            
            // --- CORE LOGIC: Initialize 'Sejarah' as the first subject if list is empty
            if (!docSnap.exists() || !Array.isArray(docSnap.data().subjects) || docSnap.data().subjects.length === 0) {
                 subjects = ["Sejarah", "Matematik", "Sains", "Bahasa Inggeris", "Pendidikan Islam"];
                 await setDoc(subjectsRef, { subjects: subjects });
            } else {
                subjects = docSnap.data().subjects;
            }
            // --- END CORE LOGIC ---

            subjectSelector.innerHTML = '<option value="" disabled selected>--- Sila Pilih Subjek ---</option>';
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject;
                subjectSelector.appendChild(option);
            });
            
            subjectListMessage.classList.add('hidden');

            if (selectSubject) {
                subjectSelector.value = selectSubject;
                loadPlan(selectSubject, false);
            }

        } catch (error) {
            console.error("Error loading subject list:", error);
            subjectListMessage.textContent = 'Ralat memuatkan senarai subjek.';
            showMessage('Ralat memuatkan senarai subjek.', 'error', newSubjectMessageBox);
        }
    }
    
    async function addNewSubject() {
        if (!isAuthReady || !db) return;
        const newSubjectName = newSubjectInput.value.trim();
        
        if (!newSubjectName) {
            showMessage('Sila masukkan nama subjek.', 'error', newSubjectMessageBox);
            return;
        }

        const addSubjectButton = addNewSubjectButton;
        addSubjectButton.disabled = true;
        addSubjectButton.textContent = 'Menambah...';

        try {
            const subjectsRef = doc(db, SUBJECTS_DOC_PATH);
            
            const docSnap = await getDoc(subjectsRef);
            if (docSnap.exists() && docSnap.data().subjects.includes(newSubjectName)) {
                showMessage(`Subjek '${newSubjectName}' sudah wujud.`, 'error', newSubjectMessageBox);
                newSubjectInput.value = '';
                addSubjectButton.disabled = false;
                addSubjectButton.textContent = 'Tambah';
                return;
            }

            await updateDoc(subjectsRef, {
                subjects: arrayUnion(newSubjectName)
            });

            newSubjectInput.value = '';
            showMessage(`Subjek '${newSubjectName}' berjaya ditambah!`, 'success', newSubjectMessageBox);
            
            await loadSubjectList(newSubjectName);

        } catch (error) {
            console.error("Error adding new subject:", error);
            showMessage(`Gagal menambah subjek: ${error.message}`, 'error', newSubjectMessageBox);
        } finally {
            addSubjectButton.disabled = false;
            addSubjectButton.textContent = 'Tambah';
        }
    }
    addNewSubjectButton.addEventListener('click', addNewSubject);


    // --- LOAD AND SAVE LOGIC ---

    function getPlanDocPath(subject) {
        if (subject === MASTER_TEMPLATE_PATH) return MASTER_TEMPLATE_PATH;
        const slug = createSubjectSlug(subject);
        return `${PLAN_COLLECTION_BASE}/${slug}_plan`;
    }
    
    function resetForm() {
        // Reset Pelan Taktikal
        pelanTaktikalTableBody.innerHTML = '';
        
        // Reset Strategic Goals
        matlamatStrategik.value = '';
        strategiList.value = '';
        
        // Reset Butiran Program
        document.getElementById('programName').value = '';
        document.getElementById('objektifProgram').value = '';
        document.getElementById('aktivitiProgram').value = '';
        document.getElementById('penyelarasProgram').value = '';
        document.getElementById('tarikhMulaAkhir').value = '';
        document.getElementById('penyelarasAktiviti').value = '';
        document.getElementById('tempat').value = '';
        document.getElementById('sasaran').value = '';
        document.getElementById('kosSumber').value = '';
        document.getElementById('jawatankuasa').value = '';
        document.getElementById('ringkasanProgram').value = '';
        tableBody.innerHTML = '';
    }
    
    // --- LOAD DEFAULT CONTENT (SEJARAH MASTER MODULE) ---
    function loadHardcodedDefaults() {
        resetForm();
        
        // Default Pelan Taktikal Programs (Cross-curricular & Strategic Focus)
        const defaultTaktikalPrograms = [
            { 
                namaProgram: 'LITERASI DIGITAL & e-PORTFOLIO (Cross-Curricular)', 
                aktiviti: ['Bengkel Pembangunan E-Portfolio Murid', 'Latihan VLE/Google Classroom', 'Penggunaan Quizizz/Kahoot untuk kuiz'], 
                tanggungJawab: 'Penyelaras Digital & Semua Guru', 
                tempoh: 'Sepanjang Tahun', 
                kosSumber: 'PCG Digital', 
                sasaran: 'Semua Guru & Murid', 
                outputOutcome: ['100% murid mempunyai e-portfolio', 'Peningkatan engagement dalam PdP'], 
                pelanKontengensi: ['Manual PdP luar talian'] 
            },
            { 
                namaProgram: 'PLC BERFOKUS (Penjajaran Kurikulum)', 
                aktiviti: ['Mesyuarat Panitia Penjajaran DSKP', 'Peer Coaching', 'Lesson Study'], 
                tanggungJawab: 'Ketua Panitia & Guru Kanan Mata Pelajaran', 
                tempoh: 'Feb - Okt', 
                kosSumber: 'PCG Panitia', 
                sasaran: 'Semua Guru', 
                outputOutcome: ['100% guru menyelaraskan RPH', 'Peningkatan mutu pengajaran'], 
                pelanKontengensi: ['Sesi bimbingan individu'] 
            },
             { 
                namaProgram: 'BENGKEL TEKNIK MENJAWAB KBAT', 
                aktiviti: ['Klinik Skor A', 'Latih tubi berfokus KBAT', 'Modul F4/F5 berpusat'], 
                tanggungJawab: 'Semua guru Sejarah (Master)', 
                tempoh: 'Apr - Okt', 
                kosSumber: 'Dana Panitia', 
                sasaran: 'Murid Tingkatan 4 & 5', 
                outputOutcome: ['90% murid mahir jawab KBAT', 'Peningkatan % lulus peperiksaan'], 
                pelanKontengensi: ['Modul alternatif secara atas talian'] 
            },
            // --- NEW CROSS-CURRICULAR PROGRAMS ---
            { 
                namaProgram: 'AUDIT DATA PBD BERSEPADU', 
                aktiviti: ['Analisis jurang PBD bulanan', 'Sesi intervensi data silang panitia', 'Penetapan sasaran gred berdasarkan data awal'], 
                tanggungJawab: 'SU Peperiksaan & Ketua Panitia', 
                tempoh: 'Sepanjang Tahun (Suku Tahun)', 
                kosSumber: 'Tiada', 
                sasaran: 'Semua Guru Tingkatan', 
                outputOutcome: ['Laporan tren pencapaian murid', 'Intervensi segera untuk murid kritikal (bottom 10%)'], 
                pelanKontengensi: ['Pengumpulan data PBD manual'] 
            },
            { 
                namaProgram: 'PUSAT SUMBER DIGITAL INTERAKTIF', 
                aktiviti: ['Penciptaan repositori video PdP', 'Mengintegrasi AR/VR dalam Sejarah/Sains', 'Penyediaan modul interaktif Delima'], 
                tanggungJawab: 'Guru Media/ICT', 
                tempoh: 'Sepanjang Tahun', 
                kosSumber: 'PCG/ Sumbangan PIBG', 
                sasaran: 'Semua Murid & Guru', 
                outputOutcome: ['50+ bahan P&P interaktif tersedia', 'Peningkatan penggunaan Bilik Komputer'], 
                pelanKontengensi: ['Penggunaan bahan bercetak'] 
            },
            { 
                namaProgram: 'KAPSUL MIKRO SEJARAH (Video Content)', 
                aktiviti: ['Bengkel ringkas penciptaan video PdP', 'Muat naik video 5 minit ke platform sekolah (untuk ulangkaji)', 'Pertandingan Video Sejarah Murid'], 
                tanggungJawab: 'Penyelaras Media Panitia', 
                tempoh: 'Mac - Sep', 
                kosSumber: 'Tiada', 
                sasaran: 'Murid Menengah Rendah', 
                outputOutcome: ['20+ video ulangkaji tersedia', 'Peningkatan kefahaman konsep sukar'], 
                pelanKontengensi: ['Penggunaan infografik statik'] 
            },
            { 
                namaProgram: 'BIMBINGAN RAKAN SEBAYA DIGITAL (e-Mentoring)', 
                aktiviti: ['Memadankan guru pakar digital dengan guru baharu', 'Sesi bimbingan 1:1', 'Rekod sesi bimbingan dalam talian'], 
                tanggungJawab: 'Penyelaras LDP & SU Kurikulum', 
                tempoh: 'Sepanjang Tahun', 
                kosSumber: 'Tiada', 
                sasaran: 'Guru Baharu & Guru Kurang Mahir Digital', 
                outputOutcome: ['Peningkatan 80% keyakinan digital guru', 'Guru baharu mencapai standard Delima'], 
                pelanKontengensi: ['Sesi bimbingan bersemuka'] 
            },
        ];
        defaultTaktikalPrograms.forEach(row => createTaktikalProgramRow(row));
        updateTaktikalProgramRowNumbers();

        // Default Strategic Goals (Sejarah Focus)
        matlamatStrategik.value = 'Meningkatkan penguasaan kefahaman konsep Sejarah melalui pendekatan inkuiri (Project Based Learning) dan melonjakkan pencapaian akademik (A > 30%).';
        strategiList.value = 'Melaksanakan strategi Pembelajaran Abad Ke-21 (PAK21) secara konsisten.\nMemperkasa kemahiran guru dalam menilai soalan KBAT.\nMemanfaatkan teknologi Delima sepenuhnya dalam PdP.';
        
        // Butiran Program (General Default)
        document.getElementById('programName').value = 'Program Peningkatan Prestasi Sejarah Menyeluruh';
        document.getElementById('objektifProgram').value = 'Memastikan 100% murid menguasai konsep dan fakta Sejarah asas dan mencapai sekurang-kurangnya gred Lulus.';
        document.getElementById('aktivitiProgram').value = 'Program mentor-mentee\nPembelajaran berasaskan projek\nLawatan sambil belajar maya/fizikal';
        document.getElementById('penyelarasProgram').value = 'Ketua Panitia Sejarah';
        document.getElementById('tarikhMulaAkhir').value = 'Sepanjang Tahun';
        document.getElementById('penyelarasAktiviti').value = 'Semua Guru Sejarah';
        document.getElementById('tempat').value = 'Bilik Darjah / Makmal Komputer';
        document.getElementById('sasaran').value = 'Semua Murid Tingkatan 1-5';
        document.getElementById('kosSumber').value = 'PCG & Sumbangan Komuniti';
        document.getElementById('jawatankuasa').value = 'AJK Kurikulum Sekolah';
        document.getElementById('ringkasanProgram').value = 'Program ini menggabungkan pelbagai pendekatan untuk menjadikan subjek Sejarah lebih relevan dan menarik, menggunakan alat digital dan pendekatan inkuiri.';
        
        // Proses Pelaksanaan
        tableBody.innerHTML = '';
        const defaultProses = [
            { langkah: 1, prosesKerja: ["Mesyuarat JK Panitia & Penjajaran Dokumen Standard", "Analisis Data Peperiksaan Tahun Lalu", "Penetapan KPI & Sasaran"], tanggungJawab: 'KP & Penyelaras Program', tarikhMulaAkhir: 'Januari', kpi: 'Dokumen dan KPI disahkan', sasaran: 'Semua guru Sejarah', status: 'Selesai' },
            { langkah: 2, prosesKerja: ["Penyediaan bahan mengikut keperluan taktik", "Pengagihan tugas AJK dan guru"], tanggungJawab: 'Penyelaras Program & AJK', tarikhMulaAkhir: 'Februari - Mac', kpi: '80% bahan sokongan siap', sasaran: 'Guru dan Murid terlibat', status: 'Sedia' },
            { langkah: 3, prosesKerja: ["Pempromosian program", "Surat pemakluman kepada pihak berkepentingan"], tanggungJawab: 'Penyelaras Aktiviti', tarikhMulaAkhir: 'Mac', kpi: 'Semua pihak maklum', sasaran: 'Semua guru', status: 'Selesai' },
            { langkah: 4, prosesKerja: ["Pelaksanaan program utama mengikut jadual (Tactical Execution)"], tanggungJawab: 'Penyelaras Program', tarikhMulaAkhir: 'Sepanjang Tahun', kpi: 'Program dilaksanakan 100%', sasaran: 'Semua guru/murid Sejarah', status: 'Sedang Jalan' },
            { langkah: 5, prosesKerja: ["Penilaian & Pelaporan prestasi berkala (Ujian, PBD)", "Pengemaskinian data"], tanggungJawab: 'Pengetua, PKP & Guru Data', tarikhMulaAkhir: 'Mei - November', kpi: 'Peningkatan pencapaian murid', sasaran: 'Semua murid terlibat', status: 'Sedang Jalan' },
            { langkah: 6, prosesKerja: ["Pemantauan dan penyeliaan berterusan (Peer Coaching/Pencerapan)"], tanggungJawab: 'Pentadbir & GKMP', tarikhMulaAkhir: 'Sepanjang Tahun', kpi: 'Sesi pemantauan direkod', sasaran: 'Semua guru', status: 'Sedang Jalan' },
            { langkah: 7, prosesKerja: ["Post-Mortem Program Akhir Tahun", "Laporan Penilaian Keseluruhan & Cadangan Penambahbaikan"], tanggungjawab: 'KP Panitia', tarikhMulaAkhir: 'November', kpi: 'Laporan disemak dan disahkan', sasaran: 'JK Panitia', status: 'Belum Mula' }
        ];
        defaultProses.forEach(row => createTableRow(row));
        updateRowNumbers();
    }
    
    // Loads data from the Firebase master template document
    async function loadTemplateData(saveIfMissing = false) {
        const templateRef = doc(db, MASTER_TEMPLATE_PATH);
        try {
            const docSnap = await getDoc(templateRef);
            
            if (docSnap.exists()) {
                const data = docSnap.data();
                
                // Pelan Taktikal
                pelanTaktikalTableBody.innerHTML = '';
                if (Array.isArray(data.pelanTaktikal) && data.pelanTaktikal.length > 0) {
                    data.pelanTaktikal.forEach(row => createTaktikalProgramRow(row));
                    updateTaktikalProgramRowNumbers();
                } else {
                    createTaktikalProgramRow({});
                    updateTaktikalProgramRowNumbers();
                }
                
                // Strategic Goals
                matlamatStrategik.value = data.matlamatStrategik || '';
                strategiList.value = arrayToText(data.strategiList) || '';
                
                // Butiran Program
                document.getElementById('programName').value = data.programName || '';
                document.getElementById('objektifProgram').value = data.objektifProgram || '';
                document.getElementById('aktivitiProgram').value = arrayToText(data.aktivitiProgram) || '';
                document.getElementById('penyelarasProgram').value = data.penyelarasProgram || '';
                document.getElementById('tarikhMulaAkhir').value = data.tarikhMulaAkhir || '';
                document.getElementById('penyelarasAktiviti').value = data.penyelarasAktiviti || '';
                document.getElementById('tempat').value = data.tempat || '';
                document.getElementById('sasaran').value = data.sasaran || '';
                document.getElementById('kosSumber').value = data.kosSumber || '';
                document.getElementById('jawatankuasa').value = data.jawatankuasa || '';
                document.getElementById('ringkasanProgram').value = data.ringkasanProgram || '';

                tableBody.innerHTML = '';
                if (Array.isArray(data.prosesPelaksanaan) && data.prosesPelaksanaan.length > 0) {
                    data.prosesPelaksanaan.forEach(row => createTableRow(row));
                    updateRowNumbers();
                } else {
                    createTableRow({prosesKerja: ['']});
                    updateRowNumbers();
                }
            } else {
                loadHardcodedDefaults();
                if (saveIfMissing) {
                    await savePlan(null, MASTER_TEMPLATE_PATH);
                }
            }
        } catch (error) {
             console.error("Error loading master template:", error);
             // CRITICAL: If loading template fails, load hardcoded defaults to ensure structural integrity
             loadHardcodedDefaults();
             if (saveIfMissing) {
                await savePlan(null, MASTER_TEMPLATE_PATH);
             }
        }
    }


    async function loadPlan(subject, isAdminTemplateLoad = false) {
        if (!isAuthReady || !db || !subject) { planEditorContainer.classList.add('hidden'); return; }
        currentSubject = subject;
        if (!isAdminTemplateLoad) { pageMainTitle.innerHTML = `Pelan Strategik Mata Pelajaran **${subject}**`; }
        planEditorContainer.classList.remove('hidden');
        loadingOverlay.classList.remove('hidden'); 
        
        const planRef = doc(db, getPlanDocPath(subject));
        try {
            const docSnap = await getDoc(planRef);
            
            if (docSnap.exists()) {
                const data = docSnap.data();
                
                // Pelan Taktikal
                pelanTaktikalTableBody.innerHTML = '';
                if (Array.isArray(data.pelanTaktikal) && data.pelanTaktikal.length > 0) {
                    data.pelanTaktikal.forEach(row => createTaktikalProgramRow(row));
                    updateTaktikalProgramRowNumbers();
                } else { createTaktikalProgramRow({}); updateTaktikalProgramRowNumbers(); }

                // Strategic Goals
                matlamatStrategik.value = data.matlamatStrategik || '';
                strategiList.value = arrayToText(data.strategiList) || '';
                
                // Butiran Program
                document.getElementById('programName').value = data.programName || '';
                document.getElementById('objektifProgram').value = data.objektifProgram || '';
                document.getElementById('aktivitiProgram').value = arrayToText(data.aktivitiProgram) || '';
                document.getElementById('penyelarasProgram').value = data.penyelarasProgram || '';
                document.getElementById('tarikhMulaAkhir').value = data.tarikhMulaAkhir || '';
                document.getElementById('penyelarasAktiviti').value = data.penyelarasAktiviti || '';
                document.getElementById('tempat').value = data.tempat || '';
                document.getElementById('sasaran').value = data.sasaran || '';
                document.getElementById('kosSumber').value = data.kosSumber || '';
                document.getElementById('jawatankuasa').value = data.jawatankuasa || '';
                document.getElementById('ringkasanProgram').value = data.ringkasanProgram || '';

                tableBody.innerHTML = '';
                if (Array.isArray(data.prosesPelaksanaan) && data.prosesPelaksanaan.length > 0) {
                    data.prosesPelaksanaan.forEach(row => createTableRow(row));
                } else { createTableRow({prosesKerja: ['']}); }
                updateRowNumbers();
                
                if (!isAdminTemplateLoad) { showMessage(`Pelan Strategik untuk ${subject} berjaya dimuatkan untuk pengeditan.`, 'success');
                } else { saveButton.textContent = 'Simpan Templat Induk'; }

            } else if (!isAdminTemplateLoad) {
                // DATA TIDAK WUJUD UNTUK SUBJEK: Load Master Template
                showMessage(`Memuatkan templat Master untuk subjek baharu: ${subject}.`, 'info');
                await loadTemplateData(false); // Load template, but don't save it as default here
                saveButton.textContent = 'Simpan Pelan Operasi'; 
            } else {
                 // MASTER TEMPLATE TIDAK WUJUD: Initialize Defaults
                 loadHardcodedDefaults();
                 showMessage('Templat Induk baharu telah dibuat dari templat lalai.', 'info');
                 saveButton.textContent = 'Simpan Templat Induk';
                 await savePlan(null, MASTER_TEMPLATE_PATH); 
            }
        } catch (error) {
            console.error("Error fetching or loading plan data:", error);
            showMessage(`Ralat memuatkan data: ${error.message}. Memuatkan templat kosong.`, 'error');
            resetForm();
        } finally { loadingOverlay.classList.add('hidden'); }
    }


    async function savePlan(e, specificPath = null) {
        if (e) e.preventDefault();
        
        const savePath = specificPath || getPlanDocPath(currentSubject);
        const subjectName = specificPath === MASTER_TEMPLATE_PATH ? 'Templat Induk' : currentSubject;

        if (!isAuthReady || !db || !subjectName) {
            showMessage("Sila pilih subjek atau sahkan templat.", 'error');
            return;
        }

        saveButton.disabled = true;
        saveButton.textContent = `Menyimpan ${subjectName}...`;

        try {
            const staticData = {
                pelanTaktikal: collectPelanTaktikalData(),
                matlamatStrategik: matlamatStrategik.value.trim(),
                strategiList: textToArray(strategiList.value),
                
                programName: document.getElementById('programName').value.trim(),
                objektifProgram: document.getElementById('objektifProgram').value.trim(),
                aktivitiProgram: textToArray(document.getElementById('aktivitiProgram').value),
                penyelarasProgram: document.getElementById('penyelarasProgram').value.trim(),
                tarikhMulaAkhir: document.getElementById('tarikhMulaAkhir').value.trim(),
                penyelarasAktiviti: document.getElementById('penyelarasAktiviti').value.trim(),
                tempat: document.getElementById('tempat').value.trim(),
                sasaran: document.getElementById('sasaran').value.trim(),
                kosSumber: document.getElementById('kosSumber').value.trim(),
                jawatankuasa: document.getElementById('jawatankuasa').value.trim(),
                ringkasanProgram: document.getElementById('ringkasanProgram').value.trim(),
                
                prosesPelaksanaan: collectTableData(),
                updatedAt: serverTimestamp(),
            };

            const planRef = doc(db, savePath);
            await setDoc(planRef, staticData);
            
            showMessage(`Pelan Strategik untuk ${subjectName} berjaya disimpan!`, 'success');

        } catch (error) {
            console.error("Error saving plan:", error);
            showMessage(`Gagal menyimpan: ${error.message}`, 'error');
        } finally {
            saveButton.disabled = false;
            saveButton.textContent = specificPath === MASTER_TEMPLATE_PATH ? 'Simpan Templat Induk' : 'Simpan Pelan Operasi';
        }
    }
    
    // --- FIREBASE INITIALIZATION ---

    async function initializeFirebaseAndAuth() {
        try {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is empty. Cannot initialize.");
                ensureUIVisible();
                showMessage("Ralat Kritikal: Konfigurasi Firebase tidak lengkap.", 'error');
                return;
            }

            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                }
                userId = auth.currentUser?.uid;
                isAuthReady = true;
                
                // 1. Load subjects and show main UI (CRITICAL: ensure visible first)
                ensureUIVisible(); 
                
                // 2. Start data loading
                await loadSubjectList();
                
                // 3. Set default mode 
                setAdminMode(false);
            });

        } catch (error) {
            console.error("Firebase initialization error:", error);
            ensureUIVisible();
            showMessage(`Ralat Sistem: ${error.message}. Sila semak konsol log.`, 'error');
        }
    }
    
    // --- EVENT LISTENERS & STARTUP ---
    saveButton.addEventListener('click', savePlan);
    
    subjectSelector.addEventListener('change', (e) => {
        const selectedSubject = e.target.value;
        if (selectedSubject) {
            loadPlan(selectedSubject, false);
            saveButton.textContent = 'Simpan Pelan Operasi'; 
        } else {
            planEditorContainer.classList.add('hidden');
            pageMainTitle.innerHTML = 'Pelan Strategik Mata Pelajaran';
        }
    });
    
    // Start the whole process
    initializeFirebaseAndAuth();
</script>

</body>
</html>

