<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pelan Operasi Editor - SMK Seri Pulai Perdana</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
            min-height: 100vh;
            padding-bottom: 20px; 
        }
        /* Ensures table is wide enough for content, enabling horizontal scroll on mobile */
        .table-auto-layout {
            width: 1200px; 
            table-layout: fixed;
            border-collapse: collapse;
        }
        .table-auto-layout th, .table-auto-layout td {
            padding: 8px 12px;
            text-align: left;
            border: 1px solid #e5e7eb;
            font-size: 0.875rem;
            vertical-align: top;
        }
        
        #prosesPelaksanaanTable th, #pelanTaktikalTable th, #qsamMatrixTable th { 
            text-align: center;
            white-space: normal; 
            line-height: 1.2;
            padding-top: 10px;
            padding-bottom: 10px;
        }
        #pelanTaktikalTable textarea {
            min-height: 60px; /* Ensure sufficient space for multiline text */
        }
        
        /* Ensure responsive table container for desktop/mobile */
        .overflow-x-auto {
            overflow-x: auto;
        }
        
        /* --- Strategy Map Specific Styles --- */
        .strategy-map-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px; 
            padding: 20px 0;
            border-radius: 12px;
            background-color: #ffffff;
        }
        .strategy-perspective {
            width: 100%;
            max-width: 600px;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        .perspective-title {
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.8rem;
            margin-bottom: 4px;
        }
        .perspective-content {
            font-size: 0.95rem;
            font-weight: 500;
            min-height: 30px;
        }
        /* Arrow Styling (for visual flow) */
        .strategy-arrow {
            width: 4px;
            height: 16px;
            background-color: #3b82f6; /* Blue-500 */
            border-radius: 2px;
            position: relative;
            z-index: 10;
        }
        .strategy-arrow::after {
            content: '';
            position: absolute;
            top: 100%;
            left: -4px;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 8px solid #3b82f6;
        }
        /* Specific Colors */
        .impact { background-color: #fef2f2; border: 2px solid #ef4444; } /* Red-100 */
        .impact .perspective-title { color: #ef4444; }
        .outcome { background-color: #fffbeb; border: 2px solid #f59e0b; } /* Amber-100 */
        .outcome .perspective-title { color: #f59e0b; }
        .process { background-color: #eff6ff; border: 2px solid #3b82f6; } /* Blue-100 */
        .process .perspective-title { color: #3b82f6; }
        .capacity { background-color: #ecfdf5; border: 2px solid #10b981; } /* Green-100 */
        .capacity .perspective-title { color: #10b981; }
        
        /* QSAM Specific Styling */
        .qsam-score {
            font-weight: bold;
            text-align: center;
        }
        
        /* Appendix Styling */
        #appendixContent {
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
            max-height: 0;
            overflow: hidden;
            padding: 0 1rem;
        }
        #appendixContent.open {
            max-height: 1000px; /* Large enough value */
            padding: 1rem;
        }
        
        /* --- DASHBOARD VIEW STYLES (for Visual Mode) --- */
        .dashboard-container {
            background-color: #f1f5f9; /* Slate-100 */
            padding: 1.5rem;
            min-height: 600px;
            border-radius: 12px;
        }
        .dashboard-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 6px 10px -3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }
        .kpi-circle {
            width: 70px; height: 70px;
            border-radius: 50%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-weight: 800; font-size: 1.5rem;
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .ei-score { background-color: #f87171; } 
        .qra-score { background-color: #34d399; } 
        .tbs-score { background-color: #60a5fa; } 
        .qsam-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px dashed #e2e8f0;
        }
        .qsam-name { font-weight: 600; color: #1e293b; font-size: 0.9rem; width: 40%; }
        .qsam-badge {
            font-size: 0.75rem; font-weight: 700;
            padding: 2px 8px; border-radius: 9999px; margin-left: 8px;
        }
        .ei-badge { background-color: #fee2e2; color: #ef4444; }
        .im-badge { background-color: #fffbeb; color: #f59e0b; }
        .dashboard-map .strategy-map-perspective {
            max-width: 100%;
            margin: 10px 0;
            padding: 10px;
        }

        /* FIX: Ensure the main content container allows vertical scrolling */
        #planEditorContainer {
             overflow-y: auto;
        }

        /* Unified Button Styling for Bottom Row */
        .action-button {
            flex-grow: 1; /* Make buttons take equal space */
            font-weight: 700; 
            padding: 1rem 1.5rem; /* Large, comfortable padding */
            border-radius: 12px;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15); 
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem; 
        }

        /* Specific Button Styles */
        #downloadPlanButton {
            background-color: #4b5563; /* Gray-700 */
            color: white;
            margin-right: 1rem;
        }
        #downloadPlanButton:hover {
            background-color: #374151; /* Gray-800 */
        }
        #saveButton {
            background-color: #10b981; /* Emerald-500 */
            color: white;
        }
        #saveButton:hover {
            background-color: #059669; /* Emerald-600 */
        }
    </style>
</head>
<body>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="fixed inset-0 bg-gray-50 flex items-center justify-center z-50">
    <div class="text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500 mx-auto"></div>
        <p class="mt-4 text-indigo-700 font-semibold">Memulakan Aplikasi...</p>
    </div>
</div>

<div id="app" class="min-h-screen p-4 sm:p-8 max-w-7xl mx-auto">

    <!-- Header Section (Fixed Titles) -->
    <header class="text-center mb-8">
        <h1 class="text-4xl font-extrabold text-indigo-900 mb-2 tracking-tight">
            SMK Seri Pulai Perdana
        </h1>
        <h2 id="pageMainTitle" class="text-2xl font-bold text-gray-800">
            Pelan Strategik Mata Pelajaran
        </h2>
        <p id="headerSubtitle" class="text-sm text-gray-500 mt-1">Sila pilih subjek atau cipta subjek baharu untuk memulakan pengeditan.</p>
    </header>

    <!-- Subject Management Section (Only visible in Subject Editing Mode) -->
    <div id="subjectManagementSection" class="bg-white p-6 rounded-xl shadow-lg max-w-lg mx-auto mb-8 space-y-4">
        
        <!-- 1. Existing Subject Selector -->
        <div>
            <label for="subjectSelector" class="block text-lg font-medium text-gray-700 mb-2">1. Pilih Mata Pelajaran (Subjek) untuk Diedit:</label>
            <select id="subjectSelector" class="w-full p-3 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-white">
                <!-- Options populated by JavaScript -->
            </select>
            <p id="subjectListMessage" class="text-xs text-gray-500 mt-1 hidden">Memuatkan senarai subjek...</p>
        </div>

        <!-- 2. Add New Subject -->
        <div class="border-t pt-4">
            <label for="newSubjectInput" class="block text-lg font-medium text-gray-700 mb-2">2. Tambah Subjek Baharu:</label>
            <div class="flex space-x-2">
                <input type="text" id="newSubjectInput" placeholder="Contoh: Kimia" class="flex-grow p-3 border border-green-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150">
                <button id="addNewSubjectButton" class="bg-green-600 text-white font-semibold px-4 py-3 rounded-lg hover:bg-green-700 transition duration-200">
                    Tambah
                </button>
            </div>
            <div id="newSubjectMessageBox" class="mt-3 p-2 text-center rounded-lg hidden text-sm"></div>
        </div>
    </div>
    
    <!-- MASTER TEMPLATE ADMIN LOGIN GATE (Hidden by default, shown when footer link is clicked) -->
    <div id="templateAdminGate" class="bg-yellow-50 p-6 rounded-xl shadow-lg max-w-lg mx-auto mb-8 space-y-4 hidden">
        <h3 class="text-xl font-bold text-yellow-800">Templat Induk: Sila Sahkan</h3>
        <p class="text-sm text-yellow-700">Mod ini membolehkan anda mengedit templat asas untuk subjek baharu.</p>
        <div class="flex space-x-2">
            <input type="password" id="templateAdminKeyInput" placeholder="Masukkan Kunci Pentadbir" class="flex-grow p-3 border border-yellow-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 transition duration-150">
            <button id="templateAdminLoginButton" class="bg-yellow-600 text-white font-semibold px-4 py-3 rounded-lg hover:bg-yellow-700 transition duration-200">
                Buka Kunci
            </button>
        </div>
        <div id="templateAdminMessage" class="mt-3 p-2 text-center rounded-lg hidden text-sm"></div>
    </div>


    <!-- Main Content Container (Used for both Subject Editing and Template Editing) -->
    <div id="planEditorContainer" class="bg-white p-6 rounded-xl shadow-2xl hidden">
        <div id="messageBox" class="p-3 text-center rounded-lg hidden mb-4" role="alert"></div>
        
        <!-- View Toggle and Switch Subject Button -->
        <div class="flex justify-between items-center mb-4">
            <button id="switchSubjectButton" class="text-sm text-indigo-500 hover:text-indigo-700 font-medium py-1 px-3 rounded-lg border border-indigo-200 hover:bg-indigo-50 transition duration-150 flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                Tukar Subjek
            </button>
            <div class="flex space-x-2">
                <!-- Renamed buttons and set consistent styling -->
                <button id="toggleEditView" class="text-white font-semibold px-4 py-2 rounded-lg transition duration-150 text-base bg-indigo-700 hover:bg-indigo-600">
                    Edit
                </button>
                <button id="toggleDashboardView" class="text-white font-semibold px-4 py-2 rounded-lg transition duration-150 text-base bg-purple-600 hover:bg-purple-700">
                    Dashboard
                </button>
            </div>
        </div>

        <!-- Dynamic Content Area -->
        <div id="dynamicPlanContent">
            <!-- Content is injected here by setView() -->
        </div>

        <!-- Save and Export Button (SLIM & ENHANCED STYLING) -->
        <div class="border-t pt-4 mt-6 flex justify-between items-center" id="saveSection">
            <!-- JSON Button with Download Icon -->
            <button id="downloadPlanButton" class="action-button bg-gray-700 text-white mr-4">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                JSON
            </button>
            <!-- Save Button -->
            <button id="saveButton" class="action-button bg-green-600 text-white">
                Save
            </button>
        </div>
    </div>
</div>

<!-- Subtle Footer Link for Admin Mode -->
<footer class="p-4 text-center">
    <button id="adminFooterToggle" class="text-xs text-gray-400 hover:text-indigo-600 transition duration-150 cursor-pointer">
        Mod Pentadbir
    </button>
</footer>

<!-- Firebase SDKs -->
<script type="module">
    // Define a placeholder subject name used in the template text that needs replacing
    const TEMPLATE_SUBJECT_NAME = "Sejarah"; 
    
    // --------------------------------------------------------------------------
    // Define a default template for the master data.
    const DEFAULT_MASTER_DATA = {
        // Executive Summary Defaults
        misi: "Melestarikan Sistem Pendidikan Yang Berkualiti Untuk Membangunkan Potensi Individu Bagi Memenuhi Aspirasi Negara.",
        visi: "Pendidikan Berkualiti Insan Terdidik Negara Sejahtera.",
        bhag: "Mencapai kedudukan Top 3 Daerah dalam SPM 2026 dengan Gred Purata Sekolah (GPS) di bawah 4.0.",

        smartPrinciple: 'Quantum SMART Principle Example: Semua KPI (Measurable) mestilah boleh dicapai (Achievable) dalam tempoh (Time-bound) yang ditetapkan.',
        // NOTE: The placeholders {SUBJECT_NAME} will be automatically replaced by the new subject name on load.
        entanglementMeasure: `Peningkatan 15% murid Band 4 ke atas dalam PBD subjek ${TEMPLATE_SUBJECT_NAME}, selaras dengan peningkatan penggunaan sumber digital oleh guru.`,
        
        // SWOT Default Data - UPDATED WITH 5 COMMON CHALLENGES PER QUADRANT
        swot: {
            s: "- Barisan pentadbir yang komited dan berwawasan.\n- Lebih 85% guru adalah terlatih dan berpengalaman (>5 tahun).\n- Kemudahan infrastruktur dan ICT yang kondusif untuk PdP.\n- Disiplin murid yang terkawal dan budaya sekolah yang positif.\n- Pencapaian kokurikulum yang cemerlang di peringkat daerah/negeri.",
            w: "- Capaian internet yang lemah di beberapa blok akademik.\n- Masalah kehadiran murid tegar yang menjejaskan prestasi kelas.\n- Beban tugas perkeranian guru yang tinggi mengurangkan masa rancang PdP.\n- Penguasaan murid dalam kemahiran asas (3M) bagi tingkatan peralihan.\n- Kekurangan dana untuk program pembangunan sahsiah secara berskala besar.",
            o: "- Hubungan erat dan sokongan kewangan yang padu daripada PIBG.\n- Jalinan kerjasama strategik dengan IPTA/IPTS tempatan.\n- Sumbangan dana dan kepakaran daripada Alumni sekolah.\n- Peluang geran dan sumbangan CSR daripada syarikat korporat berhampiran.\n- Sokongan padu komuniti setempat dalam program sarana sekolah.",
            c: "- Pengaruh gajet dan media sosial yang melalaikan murid di rumah.\n- Gejala sosial persekitaran (cybercafe/lepak) yang mempengaruhi murid.\n- Kurangnya pemantauan ibu bapa terhadap pembelajaran anak di rumah.\n- Ekspektasi ibu bapa yang terlalu tinggi tanpa sokongan realistik.\n- Kos sara hidup keluarga B40 yang menjejaskan fokus murid (bekerja sambilan)."
        },

        matlamatStrategik: `Tingkatkan penguasaan kefahaman konsep ${TEMPLATE_SUBJECT_NAME} dan lonjakkan pencapaian akademik (A > 30%).`,
        strategiList: [
            "Melaksanakan PAK21 konsisten", 
            "Memperkasa kemahiran KBAT guru", 
            "Memanfaatkan teknologi DELIMA"
        ],
        pelanTaktikal: [
            {namaProgram: 'LITERASI DIGITAL & e-PORTFOLIO', aktiviti: ['Sesi Latihan e-Portfolio'], tanggungJawab: 'Guru Kanan', tempoh: 'Jan-Mac', kosSumber: 'RM 500', sasaran: 'Semua Guru', outputOutcome: ['100% guru mahir e-Portfolio'], pelanKontengensi: ['Manual Latihan']},
            {namaProgram: 'PLC BERFOKUS (Inkuiri)', aktiviti: ['Sesi Bengkel PLC berfokus Inkuiri'], tanggungJawab: 'Ketua Panitia', tempoh: 'Sepanjang Tahun', kosSumber: 'Tiada', sasaran: 'Guru Subjek', outputOutcome: ['Peningkatan mutu P&P'], pelanKontengensi: ['Sesi Mentoring']},
        ],
        // --- MOCK DATA FOR QSAM ---
        qsamData: [
            { programName: 'LITERASI DIGITAL & e-PORTFOLIO', im: 6, ei: 4, qra: 75, tbs: 30, statusCatatan: 'Pembelian aset selesai (75% QRA) tetapi pelaksanaan latihan tertunda (30% TBS). Perlu tindakan segera.', laporanKemajuan: 'Fasa 1 (Asset Acquisition) selesai.' },
            { programName: 'PLC BERFOKUS (Inkuiri)', im: 9, ei: 5, qra: 20, tbs: 25, statusCatatan: 'Program berimpak kritikal (EI 5) dan leverage tinggi (IM 9). TBS > QRA, menunjukkan kecekapan masa yang baik. Teruskan.', laporanKemajuan: 'Satu sesi bengkel telah dilaksanakan. Kehadiran 95%.' },
        ],
        // --- END MOCK DATA ---
        prosesPelaksanaan: [],
        programName: '',
        objektifProgram: '',
        aktivitiProgram: [],
        penyelarasProgram: '',
        tarikhMulaAkhir: '',
        penyelarasAktiviti: '',
        tempat: '',
        sasaran: '',
        kosSumber: '',
        jawatankuasa: '',
        ringkasanProgram: ''
    };
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    setLogLevel('debug');

    // --- Core Configuration and Paths ---
    const appId = 'strategic2026'; 
    const ADMIN_SECRET_KEY = "admin2025";
    
    // Using the original working configuration
    const firebaseConfig = {
        apiKey: "AIzaSyDvGANnXKmwWlpRT3Wlfsm-WBOEIC62SWU",
        authDomain: "strategic2026.firebaseapp.com",
        projectId: "strategic2026",
        storageBucket: "strategic2026.firebasestorage.app",
        messagingSenderId: "642605714672",
        appId: "1:642605714672:web:5dcdfbf351c36ca6084635"
    };
    
    const SUBJECTS_DOC_PATH = `artifacts/${appId}/public/data/subject_config/subject_list`;
    const PLAN_COLLECTION_BASE = `artifacts/${appId}/public/data/pelan_strategik`; 
    const MASTER_TEMPLATE_PATH = `${PLAN_COLLECTION_BASE}/master_template`; 


    // --- GLOBAL STATE ---
    let app, db, auth;
    let userId = null;
    let isAuthReady = false;
    let currentSubject = null; 
    let isAdminMode = false; 
    let masterTemplateCache = {};
    let currentPlanData = {}; 
    let programCounter = 0;
    let currentView = 'edit'; // 'edit' or 'dashboard'


    // --- UTILITIES ---

    function showMessage(message, type = 'success', target = document.getElementById('messageBox')) {
        target.textContent = message;
        target.className = `p-3 text-center rounded-lg ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} mb-4`;
        target.classList.remove('hidden');
        setTimeout(() => { target.classList.add('hidden'); }, 5000);
    }
    
    const textToArray = (text) => text.split('\n').map(item => item.trim()).filter(item => item.length > 0);
    const arrayToText = (array) => Array.isArray(array) ? array.join('\n') : '';
    
    function ensureUIVisible() {
        document.getElementById('loadingOverlay').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
    }
    
    function getFormState() {
        // Collects data regardless of which view is currently rendered
        // Prioritize data from form elements if they exist, otherwise use in-memory cache
        return {
            // Executive Summary Data
            misi: document.getElementById('misiInput')?.value.trim() || currentPlanData.misi || '',
            visi: document.getElementById('visiInput')?.value.trim() || currentPlanData.visi || '',
            bhag: document.getElementById('bhagInput')?.value.trim() || currentPlanData.bhag || '',

            smartPrinciple: document.getElementById('smartPrinciple')?.value.trim() || currentPlanData.smartPrinciple || '',
            entanglementMeasure: document.getElementById('entanglementMeasure')?.value.trim() || currentPlanData.entanglementMeasure || '',
            
            // SWOT Data
            swot: {
                s: document.getElementById('swot_s')?.value.trim() || currentPlanData.swot?.s || '',
                w: document.getElementById('swot_w')?.value.trim() || currentPlanData.swot?.w || '',
                o: document.getElementById('swot_o')?.value.trim() || currentPlanData.swot?.o || '',
                c: document.getElementById('swot_c')?.value.trim() || currentPlanData.swot?.c || '',
            },

            matlamatStrategik: document.getElementById('matlamatStrategik')?.value.trim() || currentPlanData.matlamatStrategik || '',
            strategiList: textToArray(document.getElementById('strategiList')?.value) || currentPlanData.strategiList || [],
            // Use collected table data if rows exist, otherwise fall back to currentPlanData
            pelanTaktikal: collectPelanTaktikalData().length > 0 ? collectPelanTaktikalData() : currentPlanData.pelanTaktikal || [],
            qsamData: collectQsamData().length > 0 ? collectQsamData() : currentPlanData.qsamData || [],
            
            programName: document.getElementById('programName')?.value.trim() || currentPlanData.programName || '',
            objektifProgram: document.getElementById('objektifProgram')?.value.trim() || currentPlanData.objektifProgram || '',
            aktivitiProgram: textToArray(document.getElementById('aktivitiProgram')?.value) || currentPlanData.aktivitiProgram || [],
            penyelarasProgram: document.getElementById('penyelarasProgram')?.value.trim() || currentPlanData.penyelarasProgram || '',
            tarikhMulaAkhir: document.getElementById('tarikhMulaAkhir')?.value.trim() || currentPlanData.tarikhMulaAkhir || '',
            penyelarasAktiviti: document.getElementById('penyelarasAktiviti')?.value.trim() || currentPlanData.penyelarasAktiviti || '',
            tempat: document.getElementById('tempat')?.value.trim() || currentPlanData.tempat || '',
            sasaran: document.getElementById('sasaran')?.value.trim() || currentPlanData.sasaran || '',
            kosSumber: document.getElementById('kosSumber')?.value.trim() || currentPlanData.kosSumber || '',
            jawatankuasa: document.getElementById('jawatankuasa')?.value.trim() || currentPlanData.jawatankuasa || '',
            ringkasanProgram: document.getElementById('ringkasanProgram')?.value.trim() || currentPlanData.ringkasanProgram || '',
            
            prosesPelaksanaan: collectTableData().length > 0 ? collectTableData() : currentPlanData.prosesPelaksanaan || [],
            updatedAt: serverTimestamp(),
        };
    }
    
    function setFormState(data) {
        currentPlanData = data; 
        
        // Only attempt to set the state if the elements for the current view exist
        if (currentView === 'edit') {
            // Populate Executive Summary - FALLBACK TO DEFAULT_MASTER_DATA IF EMPTY
            if (document.getElementById('misiInput')) document.getElementById('misiInput').value = data.misi || DEFAULT_MASTER_DATA.misi;
            if (document.getElementById('visiInput')) document.getElementById('visiInput').value = data.visi || DEFAULT_MASTER_DATA.visi;
            if (document.getElementById('bhagInput')) document.getElementById('bhagInput').value = data.bhag || DEFAULT_MASTER_DATA.bhag;

            // 1. Populate static inputs
            if (document.getElementById('smartPrinciple')) document.getElementById('smartPrinciple').value = data.smartPrinciple || '';
            if (document.getElementById('entanglementMeasure')) document.getElementById('entanglementMeasure').value = data.entanglementMeasure || '';

            // Populate SWOT Inputs - FALLBACK TO DEFAULT_MASTER_DATA IF EMPTY
            // This fixes the issue where existing saved plans without SWOT data showed up blank.
            if (document.getElementById('swot_s')) document.getElementById('swot_s').value = data.swot?.s || DEFAULT_MASTER_DATA.swot.s;
            if (document.getElementById('swot_w')) document.getElementById('swot_w').value = data.swot?.w || DEFAULT_MASTER_DATA.swot.w;
            if (document.getElementById('swot_o')) document.getElementById('swot_o').value = data.swot?.o || DEFAULT_MASTER_DATA.swot.o;
            if (document.getElementById('swot_c')) document.getElementById('swot_c').value = data.swot?.c || DEFAULT_MASTER_DATA.swot.c;

            if (document.getElementById('matlamatStrategik')) document.getElementById('matlamatStrategik').value = data.matlamatStrategik || '';
            if (document.getElementById('strategiList')) document.getElementById('strategiList').value = arrayToText(data.strategiList) || '';
            
            if (document.getElementById('programName')) document.getElementById('programName').value = data.programName || '';
            if (document.getElementById('objektifProgram')) document.getElementById('objektifProgram').value = data.objektifProgram || '';
            if (document.getElementById('aktivitiProgram')) document.getElementById('aktivitiProgram').value = arrayToText(data.aktivitiProgram) || '';
            if (document.getElementById('penyelarasProgram')) document.getElementById('penyelarasProgram').value = data.penyelarasProgram || '';
            if (document.getElementById('tarikhMulaAkhir')) document.getElementById('tarikhMulaAkhir').value = data.tarikhMulaAkhir || '';
            if (document.getElementById('penyelarasAktiviti')) document.getElementById('penyelarasAktiviti').value = data.penyelarasAktiviti || '';
            if (document.getElementById('tempat')) document.getElementById('tempat').value = data.tempat || '';
            if (document.getElementById('sasaran')) document.getElementById('sasaran').value = data.sasaran || '';
            if (document.getElementById('kosSumber')) document.getElementById('kosSumber').value = data.kosSumber || '';
            if (document.getElementById('jawatankuasa')) document.getElementById('jawatankuasa').value = data.jawatankuasa || '';
            if (document.getElementById('ringkasanProgram')) document.getElementById('ringkasanProgram').value = data.ringkasanProgram || '';

            // 2. Populate dynamic tables (calls to table functions handle innerHTML setting)
            if (document.getElementById('pelanTaktikalTableBody')) {
                const pelanTaktikalTableBody = document.getElementById('pelanTaktikalTableBody');
                pelanTaktikalTableBody.innerHTML = '';
                const dataPelanTaktikal = data.pelanTaktikal || [];
                dataPelanTaktikal.forEach(row => createTaktikalProgramRow(row));
                if (dataPelanTaktikal.length === 0) createTaktikalProgramRow({});
                updateTaktikalProgramRowNumbers();
                syncQsamMatrix(data.pelanTaktikal || [], data.qsamData || []);
            }

            if (document.getElementById('tableBody')) {
                const tableBody = document.getElementById('tableBody');
                tableBody.innerHTML = '';
                const dataProses = data.prosesPelaksanaan || [];
                dataProses.forEach(row => createTableRow(row));
                if (dataProses.length === 0) createTableRow({prosesKerja: ['']});
                updateRowNumbers();
            }
            
            if (document.getElementById('strategyMapDisplay')) renderStrategyMap(data);
        } else if (currentView === 'dashboard') {
            renderDashboard(data);
        }
    }
    
    // NEW FUNCTION: Toggles between Edit View and Dashboard View
    function setAppView(view) {
        if (!currentSubject) {
            showMessage("Sila pilih subjek sebelum menukar pandangan.", 'error');
            return;
        }
        
        // 1. If switching views, capture the current state of the form elements before destroying them
        // This updates currentPlanData with the latest input values.
        if (currentView === 'edit') {
            currentPlanData = getFormState();
        }
        
        currentView = view;
        const dynamicContent = document.getElementById('dynamicPlanContent');
        
        // Clear previous listeners and content
        dynamicContent.innerHTML = '';
        
        // Update button appearance
        const editButton = document.getElementById('toggleEditView');
        const dashboardButton = document.getElementById('toggleDashboardView');

        if (view === 'edit') {
            dynamicContent.innerHTML = getEditViewHTML();
            attachDynamicListeners();
            setFormState(currentPlanData); 
            document.getElementById('saveSection').classList.remove('hidden');

            editButton.classList.add('bg-indigo-700');
            editButton.classList.remove('bg-indigo-500');
            dashboardButton.classList.remove('bg-purple-700');
            dashboardButton.classList.add('bg-purple-600');


        } else if (view === 'dashboard') {
            dynamicContent.innerHTML = getDashboardViewHTML();
            // Use the collected/cached data to render the dashboard
            setFormState(currentPlanData); 
            document.getElementById('saveSection').classList.add('hidden'); // Hide save button in dashboard view
            
            editButton.classList.remove('bg-indigo-700');
            editButton.classList.add('bg-indigo-500');
            dashboardButton.classList.add('bg-purple-700');
            dashboardButton.classList.remove('bg-purple-600');
        }
    }

    // NEW FUNCTION: Handles the JSON download
    function downloadPlan() {
        if (!currentSubject || !currentPlanData) {
            showMessage("Sila pilih subjek dan simpan data sekurang-kurangnya sekali.", 'error');
            return;
        }

        // Use the current in-memory data state
        const dataToExport = getFormState();
        
        // Add a timestamp to the exported data
        const exportData = {
            subject: currentSubject,
            exportedAt: new Date().toISOString(),
            data: dataToExport
        };

        const jsonString = JSON.stringify(exportData, null, 2);
        const filename = `${createSubjectSlug(currentSubject)}_strategic_plan_export.json`;
        
        // Create a temporary link element to trigger the download
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        
        // Append to body, click, and remove
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showMessage(`Fail '${filename}' berjaya dimuat turun!`, 'success');
    }


    // NEW FUNCTION: Renders the Dashboard View HTML structure
    function getDashboardViewHTML() {
        return `
            <div class="dashboard-container">
                <h3 class="text-3xl font-extrabold text-gray-800 mb-6 border-b pb-2">Dashboard Prestasi Quantum Strategik</h3>
                
                <!-- Executive Summary Card in Dashboard (Read-Only View) -->
                <div class="bg-gradient-to-r from-indigo-600 to-blue-500 text-white p-6 rounded-xl shadow-lg mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-bold text-indigo-100 uppercase tracking-wide text-xs mb-1">Visi</h4>
                            <p class="font-semibold text-lg leading-tight" id="dashVisi">Loading...</p>
                            <h4 class="font-bold text-indigo-100 uppercase tracking-wide text-xs mt-4 mb-1">Misi</h4>
                            <p class="font-semibold text-lg leading-tight" id="dashMisi">Loading...</p>
                        </div>
                        <div class="border-l border-indigo-400 pl-6 flex flex-col justify-center">
                            <h4 class="font-bold text-yellow-300 uppercase tracking-wide text-xs mb-2">Matlamat Utama (BHAG)</h4>
                            <p class="font-extrabold text-2xl italic leading-tight" id="dashBhag">Loading...</p>
                        </div>
                    </div>
                </div>

                <!-- KPI Summary Row -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-8">
                    
                    <div class="dashboard-card text-center">
                        <p class="text-sm font-semibold text-red-500 mb-2">Entanglement Index (EI) Purata</p>
                        <div id="dashboardEiAvg" class="kpi-circle ei-score mx-auto">0.0</div>
                        <p class="text-xs text-gray-500 mt-2">Penjajaran Strategik Langsung</p>
                    </div>

                    <div class="dashboard-card text-center">
                        <p class="text-sm font-semibold text-green-500 mb-2">QRA (Sumber Digunakan) Purata</p>
                        <div id="dashboardQraAvg" class="kpi-circle qra-score mx-auto">0%</div>
                        <p class="text-xs text-gray-500 mt-2">Kecekapan Penggunaan Kos/Masa</p>
                    </div>

                    <div class="dashboard-card text-center">
                        <p class="text-sm font-semibold text-blue-500 mb-2">TBS (Kemajuan Fizikal) Purata</p>
                        <div id="dashboardTbsAvg" class="kpi-circle tbs-score mx-auto">0%</div>
                        <p class="text-xs text-gray-500 mt-2">Prestasi Pelaksanaan Program</p>
                    </div>
                </div>

                <!-- Strategy Map (Visual Flow) -->
                <h4 class="text-xl font-bold text-blue-700 mb-4">Peta Strategi & KPI Utama</h4>
                <div id="strategyMapDisplay" class="dashboard-map mb-8">
                    <!-- Strategy Map rendered by renderStrategyMap(data) -->
                </div>

                <!-- QSAM Matrix Status -->
                <h4 class="text-xl font-bold text-green-700 mb-4">Status & Penjajaran Program Taktikal (QSAM)</h4>
                <div class="dashboard-card">
                    <div id="qsamDashboardList" class="divide-y divide-gray-100">
                        <!-- Header -->
                        <div class="qsam-item font-bold text-xs text-gray-600">
                            <span class="w-2/5">Nama Program</span>
                            <span class="w-1/6 text-center">EI (0-5)</span>
                            <span class="w-1/5 text-center">QRA (Sumber)</span>
                            <span class="w-1/5 text-center">TBS (Progress)</span>
                        </div>
                        <!-- List items injected by renderDashboard() -->
                        <p id="noQsamData" class="py-4 text-center text-gray-400 hidden">Tiada data QSAM dijumpai. Sila masukkan data dalam Mod Edit.</p>
                    </div>
                </div>
            </div>
        `;
    }

    // NEW FUNCTION: Renders the Dashboard Data
    function renderDashboard(data) {
        // Render Strategy Map
        renderStrategyMap(data);

        // Render Executive Summary Fields - Fallback to Default if Empty
        if (document.getElementById('dashVisi')) document.getElementById('dashVisi').textContent = data.visi || DEFAULT_MASTER_DATA.visi;
        if (document.getElementById('dashMisi')) document.getElementById('dashMisi').textContent = data.misi || DEFAULT_MASTER_DATA.misi;
        if (document.getElementById('dashBhag')) document.getElementById('dashBhag').textContent = data.bhag || DEFAULT_MASTER_DATA.bhag;

        // Calculate and Render KPI Averages
        const qsamData = data.qsamData || [];
        let totalEi = 0, totalQra = 0, totalTbs = 0;

        qsamData.forEach(item => {
            totalEi += item.ei || 0;
            totalQra += item.qra || 0;
            totalTbs += item.tbs || 0;
        });

        const count = qsamData.length > 0 ? qsamData.length : 1;
        const avgEi = (totalEi / count).toFixed(1);
        const avgQra = (totalQra / count).toFixed(0);
        const avgTbs = (totalTbs / count).toFixed(0);

        // Ensure elements exist before setting content (important if dashboard view loads quickly)
        const eiAvgElement = document.getElementById('dashboardEiAvg');
        const qraAvgElement = document.getElementById('dashboardQraAvg');
        const tbsAvgElement = document.getElementById('dashboardTbsAvg');
        
        if (eiAvgElement) eiAvgElement.textContent = avgEi;
        if (qraAvgElement) qraAvgElement.textContent = `${avgQra}%`;
        if (tbsAvgElement) tbsAvgElement.textContent = `${avgTbs}%`;

        // Render QSAM List with VISUAL PROGRESS BARS
        const qsamListContainer = document.getElementById('qsamDashboardList');
        if (!qsamListContainer) return; // Exit if container not found

        // Reset list, keep header structure
        qsamListContainer.innerHTML = `
            <div class="qsam-item font-bold text-xs text-gray-600">
                <span class="w-2/5">Nama Program</span>
                <span class="w-1/6 text-center">EI (0-5)</span>
                <span class="w-1/5 text-center">QRA (Sumber)</span>
                <span class="w-1/5 text-center">TBS (Progress)</span>
            </div>
        `; 

        const noDataElement = document.getElementById('noQsamData');

        if (qsamData.length === 0) {
            if (noDataElement) noDataElement.classList.remove('hidden');
        } else {
            if (noDataElement) noDataElement.classList.add('hidden');
            qsamData.forEach(item => {
                const isHighEi = (item.ei || 0) >= 4;
                const isLagging = (item.tbs || 0) < (item.qra || 0);
                
                const statusText = isLagging ? ' (LAGGING)' : '';
                const statusClass = isLagging ? 'text-red-600 font-bold' : 'text-gray-700';
                
                const qra = item.qra || 0;
                const tbs = item.tbs || 0;

                const itemHtml = `
                    <div class="qsam-item">
                        <span class="w-2/5 ${statusClass} text-sm pr-2">${item.programName}${statusText}</span>
                        <span class="w-1/6 text-center"><span class="qsam-badge ${isHighEi ? 'ei-badge' : 'bg-gray-100 text-gray-500'}">${item.ei || 0}</span></span>
                        
                        <!-- Visual Bar for QRA -->
                        <div class="w-1/5 flex flex-col justify-center px-2">
                            <div class="flex justify-between text-xs text-gray-500 mb-1">
                                <span>Used</span>
                                <span>${qra}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-teal-500 h-2 rounded-full transition-all duration-500" style="width: ${qra}%"></div>
                            </div>
                        </div>

                        <!-- Visual Bar for TBS -->
                        <div class="w-1/5 flex flex-col justify-center px-2">
                            <div class="flex justify-between text-xs text-gray-500 mb-1">
                                <span>Done</span>
                                <span class="${isLagging ? 'text-red-500 font-bold' : ''}">${tbs}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="${isLagging ? 'bg-red-500' : 'bg-blue-500'} h-2 rounded-full transition-all duration-500" style="width: ${tbs}%"></div>
                            </div>
                        </div>
                    </div>
                `;
                qsamListContainer.insertAdjacentHTML('beforeend', itemHtml);
            });
        }
    }
    
    // NEW FUNCTION: Renders the Strategy Map Visualization
    function renderStrategyMap(data) {
        const display = document.getElementById('strategyMapDisplay');
        if (!display) return;
        
        const matlamat = data.matlamatStrategik || `Tingkatkan penguasaan kefahaman konsep ${TEMPLATE_SUBJECT_NAME} dan lonjakkan pencapaian akademik (A > 30%).`;
        const entanglement = data.entanglementMeasure || `Peningkatan 15% murid Band 4 ke atas dalam PBD subjek ${TEMPLATE_SUBJECT_NAME}, selaras dengan peningkatan penggunaan sumber digital oleh guru.`;
        const strategi = arrayToText(data.strategiList).replace(/\n/g, '<br>') || 'Strategi: Melaksanakan PAK21 konsisten, memperkasa kemahiran KBAT guru, memanfaatkan teknologi DELIMA.';
        const initiatives = data.pelanTaktikal ? data.pelanTaktikal.map(p => p.namaProgram).join(', ') : 'Program: LITERASI DIGITAL & e-PORTFOLIO, PLC BERFOKUS, BENGKEL TEKNIK MENJAWAB KBAT.';

        display.innerHTML = `
            <div class="strategy-map-container">
                
                <!-- I. ULTIMATE IMPACT (RED) -->
                <div class="strategy-perspective impact">
                    <div class="perspective-title">I. ULTIMATE IMPACT (Vision Sekolah / Subjek)</div>
                    <div class="perspective-content">${matlamat}</div>
                </div>

                <div class="strategy-arrow" title="Dicapai melalui..."></div>

                <!-- II. STUDENT OUTCOME (AMBER) -->
                <div class="strategy-perspective outcome">
                    <div class="perspective-title">II. STUDENT OUTCOME (KPI Utama Entanglement Measurement)</div>
                    <div class="perspective-content">${entanglement}</div>
                </div>

                <div class="strategy-arrow" title="Memerlukan proses..."></div>
                
                <!-- III. INTERNAL PROCESS (BLUE) -->
                <div class="strategy-perspective process">
                    <div class="perspective-title">III. INTERNAL PROCESS (Strategi & Pelaksanaan P&P)</div>
                    <div class="perspective-content">${strategi}</div>
                </div>

                <div class="strategy-arrow" title="Disokong oleh..."></div>

                <!-- IV. FOUNDATIONAL CAPACITY (GREEN) -->
                <div class="strategy-perspective capacity">
                    <div class="perspective-title">IV. FOUNDATIONAL CAPACITY (Program Taktikal / Sumber)</div>
                    <div class="perspective-content">${initiatives}</div>
                </div>
            </div>
        `;
    }
    
    // QSAM CONTENT GENERATION
    function renderQsamAppendix() {
        const appendixContent = document.getElementById('appendixContent');
        if (!appendixContent) return; 
        appendixContent.innerHTML = `
            <div class="p-4 space-y-4">
                <p class="text-sm font-semibold text-indigo-700">QSAM (Quantum Strategic Alignment Matrix) adalah alat pemantauan yang canggih untuk mengukur sumbangan setiap program taktik secara langsung kepada Matlamat Strategik utama ('Entanglement Measurement').</p>
                
                <h4 class="text-lg font-bold text-gray-800 border-b pb-1">1. Impact Multiplier (IM) (Skor 1-10)</h4>
                <p class="text-sm">Menilai potensi leverage atau keberkesanan sistemik program. Skor ini ditetapkan pada awal perancangan dan sukar diubah.</p>
                <ul class="list-disc list-inside text-sm pl-4 space-y-1">
                    <li>**1-3 (Low):** Program sokongan asas, pematuhan pentadbiran.</li>
                    <li>**4-7 (Medium):** Peningkatan kecekapan rutin, latihan biasa.</li>
                    <li>**8-10 (High):** Program yang menggunakan teknologi inovatif, menangani masalah sistemik, atau menjana perubahan budaya yang besar (e.g., inkuiri, KBAT).</li>
                </ul>

                <h4 class="text-lg font-bold text-gray-800 border-b pb-1">2. Entanglement Index (EI) (Skor 0-5)</h4>
                <p class="text-sm">Menilai Penjajaran Strategik Langsung. Sejauh mana kejayaan program ini *akan* memberi impak yang boleh diukur kepada **Entanglement Measurement KPI** anda (Contoh: Peningkatan 15% Band 4 ke atas).</p>
                <ul class="list-disc list-inside text-sm pl-4 space-y-1">
                    <li>**5 (Critical):** Program memberi impak terus kepada KPI Utama (Contoh: Bengkel KBAT untuk KPI KBAT).</li>
                    <li>**3-4 (High):** Program menyokong prasyarat penting untuk KPI Utama (Contoh: PLC guru untuk peningkatan mutu P&P).</li>
                    <li>**0-2 (Low):** Program lebih fokus pada pembangunan guru/sumber dan hanya memberi impak tidak langsung kepada KPI murid.</li>
                </ul>
                
                <h4 class="text-lg font-bold text-gray-800 border-b pb-1">3. Quantum Resource Allocation (QRA) (%)</h4>
                <p class="text-sm">Peratusan sumber (kos dan tenaga kerja) yang telah **digunakan** setakat ini. Ini membolehkan pemantau menilai kecekapan perbelanjaan.</p>
                
                <h4 class="text-lg font-bold text-gray-800 border-b pb-1">4. T-Bound Score (TBS) (%)</h4>
                <p class="text-sm">Peratusan **kemajuan fizikal** program berbanding **tempoh masa** yang ditetapkan. Ia adalah indikator prestasi masa nyata. Jika TBS jauh lebih rendah daripada QRA, ini menunjukkan pembaziran sumber atau pelaksanaan yang tidak cekap.</p>

                <p class="text-base pt-2 font-bold text-red-600">Fokus Strategik QSAM: Program dengan **EI Tinggi** dan **IM Tinggi** mesti mempunyai **TBS > QRA**.</p>
            </div>
        `;
    }

    // --- TABLE MANAGEMENT FUNCTIONS (UNCHANGED) ---

    function createTaktikalProgramRow(data = {}) {
        if (!document.getElementById('pelanTaktikalTableBody')) return;
        const pelanTaktikalTableBody = document.getElementById('pelanTaktikalTableBody');
        
        programCounter++;
        const row = pelanTaktikalTableBody.insertRow();
        row.dataset.id = `taktikal-program-${programCounter}`;
        row.className = 'hover:bg-gray-50';

        const rowData = {
            bil: pelanTaktikalTableBody.rows.length,
            namaProgram: data.namaProgram || '',
            aktiviti: arrayToText(data.aktiviti || ['Aktiviti 1']),
            tanggungJawab: data.tanggungJawab || '',
            tempoh: data.tempoh || '',
            kosSumber: data.kosSumber || '',
            sasaran: data.sasaran || '',
            outputOutcome: arrayToText(data.outputOutcome || ['Output/Outcome']),
            pelanKontengensi: arrayToText(data.pelanKontengensi || ['Pelan Kontengensi']),
            ...data
        };

        row.innerHTML = `
            <td class="text-center font-medium program-bil">${rowData.bil}</td>
            <td><textarea rows="3" class="w-full focus:outline-none resize-none" data-field="namaProgram">${rowData.namaProgram}</textarea></td>
            <td><textarea rows="3" class="w-full focus:outline-none resize-none" data-field="aktiviti">${rowData.aktiviti}</textarea></td>
            <td><input type="text" class="w-full focus:outline-none" data-field="tanggungJawab" value="${rowData.tanggungJawab}"></td>
            <td><input type="text" class="w-full focus:outline-none" data-field="tempoh" value="${rowData.tempoh}"></td>
            <td><input type="text" class="w-full focus:outline-none" data-field="kosSumber" value="${rowData.kosSumber}"></td>
            <td><input type="text" class="w-full focus:outline-none" data-field="sasaran" value="${rowData.sasaran}"></td>
            <td><textarea rows="3" class="w-full focus:outline-none resize-none" data-field="outputOutcome">${rowData.outputOutcome}</textarea></td>
            <td><textarea rows="3" class="w-full focus:outline-none resize-none" data-field="pelanKontengensi">${rowData.pelanKontengensi}</textarea></td>
            <td class="text-center">
                <button type="button" class="text-red-500 hover:text-red-700 delete-program-taktikal-btn" title="Hapus">
                    <svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3"></path></svg>
                </button>
            </td>
        `;

        // Add input listener to force map update when program name changes
        row.querySelector('[data-field="namaProgram"]').addEventListener('input', () => renderStrategyMap(getFormState()));
        
        row.querySelector('.delete-program-taktikal-btn').addEventListener('click', () => {
            row.remove();
            updateTaktikalProgramRowNumbers();
            syncQsamMatrix(collectPelanTaktikalData(), collectQsamData()); // Sync QSAM after deletion
            renderStrategyMap(getFormState()); // Update map
        });
    }

    function updateTaktikalProgramRowNumbers() {
        if (!document.getElementById('pelanTaktikalTableBody')) return;
        const tableBody = document.getElementById('pelanTaktikalTableBody');

        Array.from(tableBody.rows).forEach((row, index) => {
            row.cells[0].textContent = index + 1;
        });
    }

    function collectPelanTaktikalData() {
        if (!document.getElementById('pelanTaktikalTableBody')) return [];
        const tableBody = document.getElementById('pelanTaktikalTableBody');

        const data = [];
        Array.from(tableBody.rows).forEach(row => {
            const rowData = {};
            Array.from(row.querySelectorAll('[data-field]')).forEach(input => {
                const fieldName = input.dataset.field;
                let value = input.value.trim();
                
                if (['aktiviti', 'outputOutcome', 'pelanKontengensi'].includes(fieldName)) {
                    value = textToArray(value);
                }
                rowData[fieldName] = value;
            });
            rowData.bil = parseInt(row.cells[0].textContent, 10);
            data.push(rowData);
        });
        return data;
    }
    
    function createTableRow(data = {}) {
        if (!document.getElementById('tableBody')) return;
        const tableBody = document.getElementById('tableBody');

        const langkah = tableBody.rows.length + 1;
        const row = tableBody.insertRow();
        row.dataset.index = langkah;
        row.className = 'hover:bg-gray-50';

        const rowData = {
            langkah: langkah,
            prosesKerja: arrayToText(data.prosesKerja || ["Proses 1", "Proses 2"]),
            tanggungJawab: data.tanggungJawab || '',
            tarikhMulaAkhir: data.tarikhMulaAkhir || '',
            kpi: data.kpi || '',
            sasaran: data.sasaran || '',
            status: data.status || 'Jelas',
            ...data
        };

        const statusOptions = ['Jelas', 'Belum Mula', 'Sedang Jalan', 'Selesai', 'Laporan disemak'];

        row.innerHTML = `
            <td class="text-center font-medium">${rowData.langkah}</td>
            <td><textarea rows="3" class="w-full focus:outline-none resize-none" data-field="prosesKerja">${rowData.prosesKerja}</textarea></td>
            <td><input type="text" class="w-full focus:outline-none" data-field="tanggungJawab" value="${rowData.tanggungJawab}"></td>
            <td><input type="text" class="w-full focus:outline-none" data-field="tarikhMulaAkhir" value="${rowData.tarikhMulaAkhir}"></td>
            <td><input type="text" class="w-full focus:outline-none" data-field="kpi" value="${rowData.kpi}"></td>
            <td><input type="text" class="w-full focus:outline-none" data-field="sasaran" value="${rowData.sasaran}"></td>
            <td>
                <select class="w-full p-1 border rounded" data-field="status">
                    ${statusOptions.map(opt => `<option value="${opt}" ${rowData.status === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                </select>
            </td>
            <td class="text-center">
                <button type="button" class="text-red-500 hover:text-red-700 delete-row-btn" title="Hapus">
                    <svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3"></path></svg>
                </button>
            </td>
        `;

        row.querySelector('.delete-row-btn').addEventListener('click', () => {
            row.remove();
            updateRowNumbers();
        });
    }

    function updateRowNumbers() {
        if (!document.getElementById('tableBody')) return;
        const tableBody = document.getElementById('tableBody');

        Array.from(tableBody.rows).forEach((row, index) => {
            const rowNumber = index + 1;
            row.cells[0].textContent = rowNumber;
            row.dataset.index = rowNumber;
        });
    }

    function collectTableData() {
        if (!document.getElementById('tableBody')) return [];
        const tableBody = document.getElementById('tableBody');

        const data = [];
        Array.from(tableBody.rows).forEach(row => {
            const rowData = {};
            Array.from(row.querySelectorAll('[data-field]')).forEach(input => {
                const fieldName = input.dataset.field;
                let value = input.value.trim();
                if (fieldName === 'prosesKerja') {
                    value = textToArray(value);
                }
                rowData[fieldName] = value;
            });
            rowData.langkah = parseInt(row.dataset.index, 10);
            data.push(rowData);
        });
        return data;
    }

    function collectQsamData() {
        if (!document.getElementById('qsamMatrixTableBody')) return [];
        const tableBody = document.getElementById('qsamMatrixTableBody');

        const data = [];
        Array.from(tableBody.rows).forEach(row => {
            const rowData = {};
            Array.from(row.querySelectorAll('[data-field]')).forEach(input => {
                const fieldName = input.dataset.field;
                let value = input.value.trim();
                
                if (['im', 'ei', 'qra', 'tbs'].includes(fieldName)) {
                    rowData[fieldName] = parseFloat(value) || 0;
                } else {
                    rowData[fieldName] = value;
                }
            });
            rowData.programName = row.dataset.programName;
            rowData.bil = parseInt(row.cells[0].textContent, 10);
            data.push(rowData);
        });
        return data;
    }

    // NEW FUNCTION: Syncs QSAM rows with the Pelan Taktikal programs
    function syncQsamMatrix(pelanTaktikal, qsamData) {
        if (!document.getElementById('qsamMatrixTableBody')) return;
        const qsamMatrixTableBody = document.getElementById('qsamMatrixTableBody');
        qsamMatrixTableBody.innerHTML = '';
        const qsamMap = (qsamData || []).reduce((acc, item) => {
            acc[item.programName] = item;
            return acc;
        }, {});
        
        if (Array.isArray(pelanTaktikal) && pelanTaktikal.length > 0) {
            pelanTaktikal.forEach((program, index) => {
                const existingQsam = qsamMap[program.namaProgram];
                
                // Use existing QSAM data if available, otherwise use defaults
                const programQsamData = existingQsam || {
                    im: 5, ei: 3, qra: 0, tbs: 0, 
                    statusCatatan: '', laporanKemajuan: ''
                };
                
                // Pass the program name and default/existing QSAM data
                createQsamRow(program.namaProgram, index + 1, programQsamData);
            });
        }
    }

    function createQsamRow(programName, index, existingData = {}) {
        if (!document.getElementById('qsamMatrixTableBody')) return;
        const qsamMatrixTableBody = document.getElementById('qsamMatrixTableBody');

        const row = qsamMatrixTableBody.insertRow();
        row.dataset.programName = programName;
        row.className = 'hover:bg-gray-50';

        // Use the passed existingData which contains default or loaded values
        const data = {
            bil: index,
            programName: programName,
            im: existingData.im || 5, // Impact Multiplier (1-10) Default: 5
            ei: existingData.ei || 3, // Entanglement Index (0-5) Default: 3
            qra: existingData.qra || 50, // Quantum Resource Allocation (%) Default: 50
            tbs: existingData.tbs || 0, // T-Bound Score (%) Default: 0
            statusCatatan: existingData.statusCatatan || '',
            laporanKemajuan: existingData.laporanKemajuan || ''
        };

        row.innerHTML = `
            <td class="text-center font-medium">${data.bil}</td>
            <td><div class="font-medium text-gray-800">${data.programName}</div></td>
            <td><input type="number" min="1" max="10" class="w-full focus:outline-none text-center qsam-score bg-yellow-50" data-field="im" value="${data.im}"></td>
            <td><input type="number" min="0" max="5" class="w-full focus:outline-none text-center qsam-score bg-red-50" data-field="ei" value="${data.ei}"></td>
            <td><input type="number" min="0" max="100" class="w-full focus:outline-none text-center qsam-score bg-teal-50" data-field="qra" value="${data.qra}"></td>
            <td><input type="number" min="0" max="100" class="w-full focus:outline-none text-center qsam-score bg-indigo-50" data-field="tbs" value="${data.tbs}"></td>
            <td><textarea rows="2" class="w-full focus:outline-none resize-none" data-field="statusCatatan">${data.statusCatatan}</textarea></td>
            <td><textarea rows="2" class="w-full focus:outline-none resize-none" data-field="laporanKemajuan">${data.laporanKemajuan}</textarea></td>
        `;
    }


    // --- FIREBASE LOAD/SAVE LOGIC ---

    async function loadTemplateData(path, saveIfMissing = false) {
        try {
            const docSnap = await getDoc(doc(db, path));
            
            if (docSnap.exists()) {
                masterTemplateCache = docSnap.data();
                return true;
            } else {
                masterTemplateCache = DEFAULT_MASTER_DATA;
                if (saveIfMissing) {
                    await savePlan(null, path);
                }
                return false;
            }
        } catch (error) {
             console.error(`Error processing path ${path}:`, error);
             masterTemplateCache = DEFAULT_MASTER_DATA;
             return false;
        }
    }


    async function loadPlan(subject, isAdminTemplateLoad = false) {
        if (!isAuthReady || !db || !subject) { document.getElementById('planEditorContainer').classList.add('hidden'); return; }
        currentSubject = subject;
        if (!isAdminTemplateLoad) { document.getElementById('pageMainTitle').innerHTML = `Pelan Strategik Mata Pelajaran **${subject}**`; }
        document.getElementById('planEditorContainer').classList.remove('hidden');
        document.getElementById('loadingOverlay').classList.remove('hidden'); 
        
        const path = getPlanDocPath(subject);
        
        try {
            // 1. Inject HTML for the default view (Edit)
            currentView = 'edit';
            document.getElementById('dynamicPlanContent').innerHTML = getEditViewHTML();
            attachDynamicListeners(); 
            // Set initial button state (Edit should be active on load)
            document.getElementById('toggleEditView').classList.add('bg-indigo-700');
            document.getElementById('toggleEditView').classList.remove('bg-indigo-500'); // Ensure hover background is removed
            document.getElementById('toggleDashboardView').classList.remove('bg-purple-700');
            document.getElementById('saveSection').classList.remove('hidden');


            const docSnap = await getDoc(doc(db, path));
            let data = {};

            if (docSnap.exists()) {
                data = docSnap.data();
                showMessage(`Pelan Strategik untuk ${subject} berjaya dimuatkan untuk pengeditan.`, 'success');
            } else if (!isAdminTemplateLoad) {
                // --- CUSTOM LOGIC FOR NEW SUBJECT ---
                let templateData = JSON.parse(JSON.stringify(masterTemplateCache)); 
                
                // Replace the generic TEMPLATE_SUBJECT_NAME with the new subject name
                const replaceSubject = (text) => 
                    (typeof text === 'string') ? text.replace(new RegExp(TEMPLATE_SUBJECT_NAME, 'g'), subject) : text;
                
                templateData.matlamatStrategik = replaceSubject(templateData.matlamatStrategik);
                templateData.entanglementMeasure = replaceSubject(templateData.entanglementMeasure);

                data = templateData;
                showMessage(`Memuatkan templat Master untuk subjek baharu: ${subject}.`, 'info');
            }
            
            setFormState(data);
            
            document.getElementById('saveButton').textContent = isAdminTemplateLoad ? 'Simpan Templat Induk' : 'Save';

        } catch (error) {
            console.error("Error fetching or loading plan data:", error);
            showMessage(`Ralat memuatkan data: ${error.message}. Memuatkan templat Master.`, 'error');
            
            // Fallback content loading
            if (document.getElementById('dynamicPlanContent').innerHTML === "") {
                document.getElementById('dynamicPlanContent').innerHTML = getEditViewHTML();
                attachDynamicListeners();
            }
            setFormState(masterTemplateCache); 

        } finally { document.getElementById('loadingOverlay').classList.add('hidden'); }
    }


    async function savePlan(e, specificPath = null) {
        if (e) e.preventDefault();
        
        const savePath = specificPath || getPlanDocPath(currentSubject);
        const subjectName = specificPath === MASTER_TEMPLATE_PATH ? 'Templat Induk' : currentSubject;

        if (!isAuthReady || !db || !subjectName) {
            showMessage("Sila pilih subjek atau sahkan templat.", 'error');
            return;
        }
        
        // Ensure we collect data from the latest state, even if not in 'edit' view, use currentPlanData
        const dataToSave = getFormState();

        document.getElementById('saveButton').disabled = true;
        document.getElementById('saveButton').textContent = `Saving ${subjectName}...`;

        try {
            const planRef = doc(db, savePath);
            await setDoc(planRef, dataToSave);
            currentPlanData = dataToSave; // Update cache with saved data
            
            showMessage(`Pelan Strategik untuk ${subjectName} berjaya disimpan!`, 'success');

        } catch (error) {
            console.error("Error saving plan:", error);
            showMessage(`Gagal menyimpan: ${error.message}`, 'error');
        } finally {
            document.getElementById('saveButton').disabled = false;
            document.getElementById('saveButton').textContent = specificPath === MASTER_TEMPLATE_PATH ? 'Simpan Templat Induk' : 'Save';
        }
    }
    
    // --- FIREBASE INITIALIZATION AND APP STARTUP (UNCHANGED) ---

    async function loadSubjectList(selectSubject = null) {
        if (!isAuthReady || !db) return;

        const subjectListMessage = document.getElementById('subjectListMessage');
        const subjectSelector = document.getElementById('subjectSelector');

        subjectListMessage.classList.remove('hidden');
        subjectListMessage.textContent = 'Memuatkan senarai subjek...';
        subjectSelector.innerHTML = '<option value="" disabled selected>--- Memuatkan... ---</option>';

        try {
            const subjectsRef = doc(db, SUBJECTS_DOC_PATH);
            const docSnap = await getDoc(subjectsRef);
            let subjects = [];
            
            if (!docSnap.exists() || !Array.isArray(docSnap.data().subjects) || docSnap.data().subjects.length === 0) {
                 subjects = ["Sejarah", "Matematik", "Sains", "Bahasa Inggeris", "Pendidikan Islam"];
                 await setDoc(subjectsRef, { subjects: subjects });
            } else {
                subjects = docSnap.data().subjects;
            }

            subjectSelector.innerHTML = '<option value="" disabled selected>--- Sila Pilih Subjek ---</option>';
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject;
                subjectSelector.appendChild(option);
            });
            
            subjectListMessage.classList.add('hidden');

            if (selectSubject) {
                subjectSelector.value = selectSubject;
                loadPlan(selectSubject, false);
            }

        } catch (error) {
            console.error("Error loading senarai subjek:", error);
            subjectListMessage.textContent = 'Ralat memuatkan senarai subjek.';
            showMessage('Ralat memuatkan senarai subjek.', 'error', document.getElementById('newSubjectMessageBox'));
        }
    }

    async function initializeFirebaseAndAuth() {
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            await signInAnonymously(auth); 
            userId = auth.currentUser?.uid;
            isAuthReady = true;

            ensureUIVisible(); 
            
            await loadTemplateData(MASTER_TEMPLATE_PATH, false);
            await loadSubjectList();
            setAdminMode(false);

        } catch (error) {
            console.error("Firebase initialization error:", error);
            ensureUIVisible();
            showMessage(`Ralat Sistem (Firebase): ${error.message}. SILA SEMAK PERATURAN KESELAMATAN FIREBASE ANDA.`, 'error');
        }
    }

    function attachDynamicListeners() {
        // This function ensures all event listeners for dynamically created HTML are re-attached
        
        // Table listeners
        if (document.getElementById('addRowButton')) document.getElementById('addRowButton').addEventListener('click', () => { createTableRow({}); updateRowNumbers(); });
        if (document.getElementById('addTaktikalProgramButton')) document.getElementById('addTaktikalProgramButton').addEventListener('click', () => { 
            createTaktikalProgramRow({}); 
            updateTaktikalProgramRowNumbers();
            syncQsamMatrix(collectPelanTaktikalData(), collectQsamData()); 
        });
        
        // QSAM Sync
        if (document.getElementById('syncQsamButton')) document.getElementById('syncQsamButton').addEventListener('click', (e) => {
            e.preventDefault();
            const pelanTaktikal = collectPelanTaktikalData();
            const currentQsam = collectQsamData();
            syncQsamMatrix(pelanTaktikal, currentQsam);
            showMessage("Matriks QSAM disegerakkan dengan senarai Program Taktikal.", 'info');
        });

        // Map Input Listeners (For Live Preview)
        if (document.getElementById('matlamatStrategik')) document.getElementById('matlamatStrategik').addEventListener('input', () => renderStrategyMap(getFormState()));
        if (document.getElementById('entanglementMeasure')) document.getElementById('entanglementMeasure').addEventListener('input', () => renderStrategyMap(getFormState()));
        if (document.getElementById('strategiList')) document.getElementById('strategiList').addEventListener('input', () => renderStrategyMap(getFormState()));
        
        // Appendix Toggle Handler
        if (document.getElementById('toggleAppendixButton')) document.getElementById('toggleAppendixButton').addEventListener('click', () => {
            const appendixContent = document.getElementById('appendixContent');
            const appendixArrow = document.getElementById('appendixArrow');
            const isOpen = appendixContent.classList.toggle('open');
            appendixArrow.style.transform = isOpen ? 'rotate(180deg)' : 'rotate(0deg)';
        });
        renderQsamAppendix();
    }
    
    // --- COMPONENT LOGIC (UNCHANGED) ---

    function setAdminMode(enable) {
        const subjectManagementSection = document.getElementById('subjectManagementSection');
        const templateAdminGate = document.getElementById('templateAdminGate');

        isAdminMode = enable;
        document.getElementById('subjectSelector').value = '';
        if (document.getElementById('pelanTaktikalTableBody')) document.getElementById('pelanTaktikalTableBody').innerHTML = '';
        if (document.getElementById('qsamMatrixTableBody')) document.getElementById('qsamMatrixTableBody').innerHTML = '';

        if (isAdminMode) {
            subjectManagementSection.classList.add('hidden');
            templateAdminGate.classList.remove('hidden');
            planEditorContainer.classList.add('hidden');
            document.getElementById('pageMainTitle').textContent = 'Templat Induk Pelan Strategik';
            document.getElementById('headerSubtitle').textContent = 'Anda kini dalam Mod Pentadbir. Sila buka kunci untuk mengedit templat asas.';
            currentSubject = null; 
            if (document.getElementById('addTaktikalProgramButton')) document.getElementById('addTaktikalProgramButton').classList.remove('hidden');
            renderStrategyMap(DEFAULT_MASTER_DATA); 
        } else {
            subjectManagementSection.classList.remove('hidden');
            templateAdminGate.classList.add('hidden');
            planEditorContainer.classList.add('hidden');
            document.getElementById('pageMainTitle').textContent = 'Pelan Strategik Mata Pelajaran';
            document.getElementById('headerSubtitle').textContent = 'Sila pilih subjek atau cipta subjek baharu untuk memulakan pengeditan.';
            if (document.getElementById('addTaktikalProgramButton')) document.getElementById('addTaktikalProgramButton').classList.add('hidden');
            if (document.getElementById('strategyMapDisplay')) document.getElementById('strategyMapDisplay').innerHTML = '';
        }
    }

    function createSubjectSlug(subjectName) {
        return subjectName.toLowerCase().replace(/[^a-z0-9]+/g, '_').trim('_');
    }
    
    function getPlanDocPath(subject) {
        if (subject === 'master_template') return MASTER_TEMPLATE_PATH;
        const slug = createSubjectSlug(subject);
        return `${PLAN_COLLECTION_BASE}/${slug}_plan`;
    }

    // This HTML template generates all the dynamic inputs and buttons
    function getEditViewHTML() {
        return `
            <!-- NEW SECTION: Executive Summary (Ringkasan Eksekutif) - EDIT MODE -->
            <div class="mb-8 p-6 bg-white border border-indigo-200 rounded-xl shadow-md">
                <h3 class="text-xl font-bold text-indigo-800 mb-4 border-b pb-2">Ringkasan Eksekutif (Executive Summary)</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Visi Sekolah/Panitia</label>
                        <textarea id="visiInput" rows="2" class="w-full p-2 border border-gray-300 rounded focus:ring-indigo-500 focus:border-indigo-500 text-sm" placeholder="Contoh: Pendidikan Berkualiti Insan Terdidik..."></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Misi Sekolah/Panitia</label>
                        <textarea id="misiInput" rows="2" class="w-full p-2 border border-gray-300 rounded focus:ring-indigo-500 focus:border-indigo-500 text-sm" placeholder="Contoh: Melestarikan Sistem Pendidikan Yang Berkualiti..."></textarea>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-bold text-yellow-600 mb-1">Matlamat Utama (Big Hairy Audacious Goal - BHAG)</label>
                        <input type="text" id="bhagInput" class="w-full p-3 border border-yellow-400 bg-yellow-50 rounded focus:ring-yellow-500 focus:border-yellow-500 font-bold text-gray-800" placeholder="Contoh: Mencapai kedudukan Top 3 Daerah dalam SPM 2026...">
                    </div>
                </div>
            </div>

            <!-- Section 0.2: Analisis Quantum SMART (Prinsip Teras) -->
            <h3 class="text-xl font-semibold text-teal-600 mb-4 border-b pb-2">Analisis Quantum SMART (Prinsip Teras)</h3>
            
            <!-- INSERTED IMAGE: Quantum SMART Framework -->
            <div class="mb-6 flex justify-center">
                <img src="https://raw.githubusercontent.com/GowSMK/StrategicPlan2026/refs/heads/main/smart.jpg" alt="Quantum SMART Framework" class="rounded-lg shadow-lg max-w-full h-auto border border-gray-200">
            </div>

            <div class="overflow-x-auto mb-8 p-4 border border-teal-200 rounded-lg bg-teal-50">
                <table class="table-auto-layout border-collapse border border-gray-200" style="width: 1000px;">
                    <tbody>
                        <tr>
                            <th class="w-1/5 bg-teal-100 font-medium">Quantum SMART Principle</th>
                            <td colspan="3"><textarea id="smartPrinciple" rows="3" class="w-full focus:outline-none resize-none" placeholder="Terangkan bagaimana setiap program taktik memenuhi prinsip SMART. Contoh: Semua KPI (Measurable) mestilah boleh dicapai (Achievable) dalam tempoh (Time-bound) yang ditetapkan."></textarea></td>
                        </tr>
                        <tr>
                            <th class="w-1/5 bg-teal-100 font-medium">Entanglement Measurement</th>
                            <td colspan="3"><textarea id="entanglementMeasure" rows="3" class="w-full focus:outline-none resize-none" placeholder="Terangkan metrik utama yang mengukur kejayaan holistik program ini. Contoh: Peningkatan 15% Gred A merentasi semua tingkatan dalam tempoh 6 bulan, diukur melalui ujian PBD dan Peperiksaan Pertengahan Tahun."></textarea></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- MOVED IMAGE: Strategic Process Flow -->
            <div class="mb-6 flex justify-center">
                <img src="https://raw.githubusercontent.com/GowSMK/StrategicPlan2026/refs/heads/main/flow.JPG" alt="Strategic Process Flow" class="rounded-lg shadow-lg max-w-full h-auto border border-gray-200">
            </div>

            <!-- NEW SECTION: SWOT/SWOC Analysis (Analisis Persekitaran) -->
            <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Analisis Persekitaran (SWOT/SWOC Analysis)</h3>
            <p class="text-sm text-gray-500 mb-4">Kenal pasti Kekuatan (S), Kelemahan (W), Peluang (O), dan Cabaran/Ancaman (C/T) sebagai asas kepada penetapan strategi.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                <!-- Strengths -->
                <div class="bg-green-50 p-4 rounded-lg border border-green-200 shadow-sm">
                    <div class="flex items-center mb-2">
                        <div class="w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center font-bold mr-2">S</div>
                        <h4 class="font-bold text-green-800">Strengths (Kekuatan)</h4>
                    </div>
                    <textarea id="swot_s" rows="4" class="w-full p-2 border border-green-300 rounded bg-white focus:outline-none focus:ring-2 focus:ring-green-500 text-sm" placeholder="Senaraikan kekuatan dalaman (e.g., Guru berpengalaman, Fasiliti ICT lengkap)..."></textarea>
                </div>

                <!-- Weaknesses -->
                <div class="bg-red-50 p-4 rounded-lg border border-red-200 shadow-sm">
                    <div class="flex items-center mb-2">
                        <div class="w-8 h-8 rounded-full bg-red-500 text-white flex items-center justify-center font-bold mr-2">W</div>
                        <h4 class="font-bold text-red-800">Weaknesses (Kelemahan)</h4>
                    </div>
                    <textarea id="swot_w" rows="4" class="w-full p-2 border border-red-300 rounded bg-white focus:outline-none focus:ring-2 focus:ring-red-500 text-sm" placeholder="Senaraikan kelemahan dalaman (e.g., Beban tugas guru, Motivasi murid rendah)..."></textarea>
                </div>

                <!-- Opportunities -->
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 shadow-sm">
                    <div class="flex items-center mb-2">
                        <div class="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold mr-2">O</div>
                        <h4 class="font-bold text-blue-800">Opportunities (Peluang)</h4>
                    </div>
                    <textarea id="swot_o" rows="4" class="w-full p-2 border border-blue-300 rounded bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" placeholder="Senaraikan peluang luaran (e.g., Sokongan PIBG, Dana komuniti, Jaringan IPTA)..."></textarea>
                </div>

                <!-- Challenges/Threats -->
                <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200 shadow-sm">
                    <div class="flex items-center mb-2">
                        <div class="w-8 h-8 rounded-full bg-yellow-500 text-white flex items-center justify-center font-bold mr-2">C</div>
                        <h4 class="font-bold text-yellow-800">Challenges/Threats (Cabaran/Ancaman)</h4>
                    </div>
                    <textarea id="swot_c" rows="4" class="w-full p-2 border border-yellow-300 rounded bg-white focus:outline-none focus:ring-2 focus:ring-yellow-500 text-sm" placeholder="Senaraikan ancaman luaran (e.g., Pengaruh gajet, Masalah sosial setempat)..."></textarea>
                </div>
            </div>

            <!-- Section 0.5: Strategic Goals Table -->
            <h3 class="text-xl font-semibold text-red-600 mb-4 border-b pb-2">Matlamat & Strategi</h3>
            <div class="overflow-x-auto mb-8">
                <table class="table-auto-layout border-collapse border border-gray-200" style="width: 1000px;">
                    <tbody>
                        <tr>
                            <th class="w-1/5 bg-red-100 font-medium">MATLAMAT STRATEGIK</th>
                            <td colspan="3"><textarea id="matlamatStrategik" rows="2" class="w-full focus:outline-none resize-none"></textarea></td>
                        </tr>
                        <tr>
                            <th class="w-1/5 bg-red-100 font-medium">STRATEGI</th>
                            <td colspan="3"><textarea id="strategiList" rows="3" class="w-full focus:outline-none resize-none"></textarea></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- SECTION 0.6: VISUAL STRATEGY MAP (LIVE PREVIEW) -->
            <h3 class="text-xl font-semibold text-blue-600 mb-4 border-b pb-2">Peta Strategi Visual (Strategic Outcome Flow) - Live Preview</h3>
            <div id="strategyMapDisplay" class="mb-8 p-4 rounded-xl bg-gray-50 border border-gray-200">
                <!-- Content will be rendered here by JS function renderStrategyMap() -->
            </div>

            <!-- Section 0.7: Pelan Taktikal (Senarai Program) -->
            <h3 class="text-xl font-semibold text-purple-600 mb-4 border-b pb-2">Pelan Taktikal (Senarai Program)</h3>
            <div class="overflow-x-auto mb-8">
                <table class="table-auto-layout border-collapse border border-gray-200" id="pelanTaktikalTable" style="width: 1800px;">
                    <thead>
                        <tr class="bg-purple-50 text-gray-600 uppercase text-xs">
                            <th style="width: 30px;">Bil</th>
                            <th style="width: 150px;">Nama Program</th>
                            <th style="width: 250px;">Aktiviti</th>
                            <th style="width: 150px;">Tanggungjawab</th>
                            <th style="width: 100px;">Tempoh / Hari / Kekerapan</th>
                            <th style="width: 80px;">Kos / Sumber</th>
                            <th style="width: 150px;">Sasaran</th>
                            <th style="width: 200px;">Output / Outcome / Benefit</th>
                            <th style="width: 200px;">Pelan Kontengensi</th>
                            <th style="width: 50px;" class="text-center">Padam</th>
                        </tr>
                    </thead>
                    <tbody id="pelanTaktikalTableBody"></tbody>
                </table>
                <button id="addTaktikalProgramButton" class="bg-purple-500 text-white px-3 py-1 mt-2 text-sm rounded-lg hover:bg-purple-600 transition duration-150 flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    Tambah Program Taktikal
                </button>
            </div>
            
            <!-- Quantum Strategic Alignment Matrix (QSAM) -->
            <h3 class="text-xl font-semibold text-green-700 mb-4 border-b pb-2">3. Matriks Penjajaran Strategik Quantum (QSAM) - Pemantauan Outcome</h3>
            <p class="text-sm text-gray-600 mb-4">QSAM mengukur Entanglement Index (EI) setiap program taktik dengan Matlamat Strategik. Skala EI (0-5), di mana 5 = Impak Tinggi kepada KPI utama.</p>
            <div class="overflow-x-auto mb-8">
                <table class="table-auto-layout border-collapse border border-gray-200" id="qsamMatrixTable" style="width: 1500px;">
                    <thead>
                        <tr class="bg-green-100 text-gray-700 uppercase text-xs">
                            <th style="width: 30px;">Bil</th>
                            <th style="width: 250px;">Nama Program Taktikal</th>
                            <th style="width: 80px;">Impact Multiplier (IM) (1-10)</th>
                            <th style="width: 150px;">Entanglement Index (EI) (0-5)</th>
                            <th style="width: 150px;">Quantum Resource Allocation (QRA) (%)</th>
                            <th style="width: 150px;">T-Bound Score (TBS) (%)</th>
                            <th style="width: 150px;">Status / Catatan Penjajaran</th>
                            <th style="width: 150px;">Laporan Kemajuan Output (Terbaru)</th>
                        </tr>
                    </thead>
                    <tbody id="qsamMatrixTableBody"></tbody>
                </table>
                <button id="syncQsamButton" class="bg-blue-500 text-white px-3 py-1 mt-2 text-sm rounded-lg hover:bg-blue-600 transition duration-150 flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    Segerak QSAM (Sync Program List)
                </button>
            </div>

            <!-- APPENDIX SECTION -->
            <div class="border-t pt-4 mt-8">
                <button id="toggleAppendixButton" class="w-full text-left p-3 bg-gray-100 hover:bg-gray-200 font-semibold text-gray-700 rounded-lg flex justify-between items-center transition duration-150">
                    <span>LAMPIRAN A: Penjelasan Matriks Penjajaran Strategik Quantum (QSAM)</span>
                    <svg id="appendixArrow" class="w-5 h-5 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div id="appendixContent" class="bg-gray-50 border border-gray-200 rounded-b-lg"></div>
            </div>

            <!-- Section 1: Butiran Program (Static Header Info - Now less relevant due to tactical table) -->
            <h3 class="text-xl font-semibold text-indigo-600 mb-4 border-b pb-2 mt-8">Butiran Program (Untuk Pelan Am)</h3>
            <div class="overflow-x-auto mb-8">
                <table class="table-auto-layout border-collapse border border-gray-200" style="width: 1000px;">
                    <tbody>
                        <tr>
                            <th class="w-1/5 bg-gray-100 font-medium">Nama Program</th>
                            <td colspan="3"><input type="text" id="programName" class="w-full focus:outline-none" value=""></td>
                        </tr>
                        <tr>
                            <th class="w-1/5 bg-gray-100 font-medium">Objektif Program</th>
                            <td colspan="3"><textarea id="objektifProgram" rows="3" class="w-full focus:outline-none resize-none"></textarea></td>
                        </tr>
                        <tr>
                            <th class="w-1/5 bg-gray-100 font-medium">Aktiviti Program</th>
                            <td colspan="3"><textarea id="aktivitiProgram" rows="5" class="w-full focus:outline-none resize-none"></textarea></td>
                        </tr>
                        <tr>
                            <th class="w-1/5 bg-gray-100 font-medium">Penyelaras Program</th>
                            <td class="w-2/5"><input type="text" id="penyelarasProgram" class="w-full focus:outline-none" value=""></td>
                            <th class="w-1/5 bg-gray-100 font-medium">Tarikh Mula - Akhir</th>
                            <td class="w-1/5"><input type="text" id="tarikhMulaAkhir" class="w-full focus:outline-none" value=""></td>
                        </tr>
                        <tr>
                            <th class="w-1/5 bg-gray-100 font-medium">Penyelaras Aktiviti</th>
                            <td><input type="text" id="penyelarasAktiviti" class="w-full focus:outline-none" value=""></td>
                            <th class="w-1/5 bg-gray-100 font-medium">Tempat</th>
                            <td><input type="text" id="tempat" class="w-full focus:outline-none" value=""></td>
                        </tr>
                        <tr>
                            <th class="w-1/5 bg-gray-100 font-medium">Sasaran</th>
                            <td><input type="text" id="sasaran" class="w-full focus:outline-none" value=""></td>
                            <th class="w-1/5 bg-gray-100 font-medium">Kos dan Sumber</th>
                            <td><input type="text" id="kosSumber" class="w-full focus:outline-none" value=""></td>
                        </tr>
                        <tr>
                            <th class="w-1/5 bg-gray-100 font-medium">Jawatankuasa</th>
                            <td colspan="3"><input type="text" id="jawatankuasa" class="w-full focus:outline-none" value=""></td>
                        </tr>
                        <tr>
                            <th class="w-1/5 bg-gray-100 font-medium">Ringkasan Program</th>
                            <td colspan="3"><textarea id="ringkasanProgram" rows="4" class="w-full focus:outline-none resize-none"></textarea></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Section 2: Proses Pelaksanaan Table (Proses Kerja) -->
            <h3 class="text-xl font-semibold text-indigo-600 mb-4 border-b pb-2">Proses Pelaksanaan (Langkah-langkah)</h3>
            
            <div class="overflow-x-auto mb-4">
                <table class="table-auto-layout border-collapse border border-gray-200" id="prosesPelaksanaanTable" style="width: 1200px;">
                    <thead>
                        <tr class="bg-gray-100 text-gray-600 uppercase text-xs">
                            <th style="width: 50px;">Langkah</th>
                            <th style="width: 250px;">Proses Kerja</th>
                            <th style="width: 150px;">Tanggungjawab</th> 
                            <th style="width: 150px;">Tarikh Mula-Akhir</th> 
                            <th style="width: 150px;">KPI</th>
                            <th style="width: 150px;">Sasaran</th>
                            <th style="width: 120px;">Status</th> 
                            <th style="width: 80px;">Tindakan</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            
            <!-- Table Action Buttons -->
            <div class="flex justify-between items-center mb-6">
                <button id="addRowButton" class="bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 transition duration-150 flex items-center">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    Tambah Langkah
                </button>
            </div>
        `;
    }

    // --- INITIALIZATION AND LISTENERS ---

    document.addEventListener('DOMContentLoaded', () => {
        // --- EVENT LISTENERS (Non-Dynamic) ---
        
        // Mode Toggles (FIXED: Added handlers for the view buttons)
        document.getElementById('toggleEditView').addEventListener('click', () => setAppView('edit'));
        document.getElementById('toggleDashboardView').addEventListener('click', () => setAppView('dashboard'));
        
        // JSON Export Button Handler (NEW)
        document.getElementById('downloadPlanButton').addEventListener('click', downloadPlan);

        // Subject Selection Logic
        document.getElementById('subjectSelector').addEventListener('change', (e) => {
            const subject = e.target.value;
            if (subject) {
                loadPlan(subject, false);
            }
        });

        // Add New Subject Logic
        document.getElementById('addNewSubjectButton').addEventListener('click', async () => {
            const newSubjectInput = document.getElementById('newSubjectInput');
            const subjectName = newSubjectInput.value.trim();
            const messageBox = document.getElementById('newSubjectMessageBox');

            if (!subjectName) {
                showMessage('Sila masukkan nama subjek.', 'error', messageBox);
                return;
            }

            try {
                const subjectsRef = doc(db, SUBJECTS_DOC_PATH);
                const subjectsDoc = await getDoc(subjectsRef);
                let subjects = subjectsDoc.exists() && Array.isArray(subjectsDoc.data().subjects) ? subjectsDoc.data().subjects : [];

                if (subjects.map(s => s.toLowerCase()).includes(subjectName.toLowerCase())) {
                    showMessage(`Subjek '${subjectName}' sudah wujud.`, 'error', messageBox);
                    return;
                }

                await updateDoc(subjectsRef, {
                    subjects: arrayUnion(subjectName)
                });
                
                // When adding a new subject, load the master template content
                // This ensures the new subject has the mock QSAM data for testing
                await loadSubjectList(subjectName); 
                newSubjectInput.value = '';
                showMessage(`Subjek '${subjectName}' berjaya ditambah! Sila edit pelan anda.`, 'success', messageBox);

            } catch (error) {
                console.error("Error adding new subject:", error);
                showMessage(`Gagal menambah subjek: ${error.message}`, 'error', messageBox);
            }
        });

        // Save Button Handler
        document.getElementById('saveButton').addEventListener('click', savePlan);
        
        // Switch Subject Handler
        document.getElementById('switchSubjectButton').addEventListener('click', () => {
            setAdminMode(false); // Ensure admin mode is disabled when switching back to subject selection
            document.getElementById('planEditorContainer').classList.add('hidden');
        });
        
        // Admin Mode Toggle (Footer link)
        document.getElementById('adminFooterToggle').addEventListener('click', () => {
            if (isAdminMode) {
                setAdminMode(false);
            } else {
                setAdminMode(true);
            }
        });
        
        // Admin Login
        document.getElementById('templateAdminLoginButton').addEventListener('click', () => {
            const keyInput = document.getElementById('templateAdminKeyInput');
            const messageBox = document.getElementById('templateAdminMessage');
            
            if (keyInput.value === ADMIN_SECRET_KEY) {
                document.getElementById('templateAdminGate').classList.add('hidden');
                document.getElementById('subjectManagementSection').classList.add('hidden');
                document.getElementById('planEditorContainer').classList.remove('hidden');
                document.getElementById('headerSubtitle').textContent = 'Anda kini mengedit Templat Induk. Perubahan akan digunakan untuk subjek baharu.';
                
                // Load the Master Template for editing
                loadPlan('master_template', true); 
                showMessage('Kunci diterima. Templat Induk sedang dimuatkan untuk pengeditan.', 'success', messageBox);
            } else {
                showMessage('Kunci Pentadbir tidak sah.', 'error', messageBox);
            }
        });

        // Initialize Firebase and start the app flow
        initializeFirebaseAndAuth();
    });
</script>
</body>
</html>


